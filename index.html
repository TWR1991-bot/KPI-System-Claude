<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è€ƒæ ¸ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #7986CB 0%, #9FA8DA 100%);  /* ç´«è—è‰²æ¼¸å±¤èƒŒæ™¯ */
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #F5F5F5;  /* æ·ºç°èƒŒæ™¯ */
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #FFFFFF;  /* ç™½è‰² */
        }
        
        .header-logo {
            height: 70px;
            width: auto;
            margin-right: 25px;
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }
        
        .company-logo {
            height: 60px;
            margin-bottom: 15px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
        }
        
        .company-title {
            font-size: 1.9em;
            font-weight: bold;
            color: #1976D2;  /* è—è‰² */
            margin: 0;
            line-height: 1.3;
            letter-spacing: 0.5px;
        }
        
        .company-subtitle {
            font-size: 0.9em;
            color: #9E9E9E;  /* ç°è‰² */
            margin-top: 5px;
            font-weight: normal;
            letter-spacing: 0.3px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            text-align: right;
        }

        .user-name {
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #424242;  /* æ·±ç°è‰²ï¼Œé©é…ç™½è‰²èƒŒæ™¯ */
            font-weight: 500;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #1976D2;  /* åç²‰çš„å¤©ç©ºè— */
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(125, 204, 219, 0.4);
        }

        .btn-success {
            background: #81C784;
            color: white;
        }

        .btn-success:hover {
            background: #66BB6A;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .login-container {
            padding: 60px;
            max-width: 500px;
            margin: 100px auto;
        }

        .login-container h2 {
            text-align: center;
            color: #1E88E5;  /* æ”¹ç‚ºæ–°çš„ä¸»è‰² */
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background-color: #ffffff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1E88E5;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #a0aec0;
        }

        .content {
            padding: 30px;
            background: white;
            margin: 20px;
            border-radius: 12px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #718096;
            transition: all 0.3s;
        }

        .tab.active {
            color: #1E88E5;
            border-bottom: 3px solid #1E88E5;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .employee-card {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .employee-card:hover {
            border-color: #1E88E5;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .employee-card.disabled {
            background: #f7fafc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .employee-card.submitted {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .evaluation-form {
            max-width: 900px;
            margin: 0 auto;
        }

        .category-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .category-title {
            font-size: 1.5em;
            color: #1E88E5;
            margin-bottom: 20px;
            border-bottom: 2px solid #1E88E5;
            padding-bottom: 10px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            align-items: start;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .item-name {
            font-weight: bold;
            color: #2d3748;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding-top: 8px;
        }

        .score-input {
            text-align: center;
        }

        .score-input input {
            width: 80px;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: bold;
        }

        table tr:hover {
            background: #f7fafc;
        }

        .score-positive {
            color: #48bb78;
            font-weight: bold;
        }

        .score-negative-light {
            color: #ed8936;
            font-weight: bold;
        }

        .score-negative-heavy {
            color: #f56565;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #a0aec0;
        }

        .close-modal:hover {
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #f0fff4;
            border: 1px solid #48bb78;
            color: #22543d;
        }

        .alert-error {
            background: #fff5f5;
            border: 1px solid #f56565;
            color: #742a2a;
        }

        .alert-info {
            background: #ebf8ff;
            border: 1px solid #4299e1;
            color: #2c5282;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .chart-container {
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3em;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCz__a2mqHuKtI8-magMdCG_35mHITa-To",
            authDomain: "kpi-system-76380260.firebaseapp.com",
            projectId: "kpi-system-76380260",
            storageBucket: "kpi-system-76380260.firebasestorage.app",
            messagingSenderId: "243808614082",
            appId: "1:243808614082:web:7cfc400d9b2d4c3379ad5b"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å…¨åŸŸç‹€æ…‹
        window.currentUser = null;
        let currentPage = 'login';

        // åˆå§‹åŒ–ç³»çµ±
        async function initSystem() {
            // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­ç®¡ç†å“¡å¸³è™Ÿ
            const adminDoc = await getDoc(doc(db, 'users', 'Admin01'));
            if (!adminDoc.exists()) {
                // å»ºç«‹é è¨­ç®¡ç†å“¡å¸³è™Ÿ
                await setDoc(doc(db, 'users', 'Admin01'), {
                    userId: 'Admin01',
                    name: 'ç³»çµ±ç®¡ç†å“¡',
                    password: '76380260',
                    level: 'L5',
                    role: 'admin',
                    evaluators: []
                });
            }
            renderLogin();
        }

        // æ¸²æŸ“ç™»å…¥é é¢
        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <img src="https://scontent.fkhh1-1.fna.fbcdn.net/v/t39.30808-6/638320048_1475577827909977_1700135213741656516_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=53a332&_nc_ohc=xGAAk3yJe8EQ7kNvwE8lz25&_nc_oc=AdlIyrb0DzEclqxgcIRChglQFyD__ug5GE190Xp93e0MGN4Y44qBjCg1SOooxScjmQA&_nc_zt=23&_nc_ht=scontent.fkhh1-1.fna&_nc_gid=Mn2LiUh0dop6qSALV1NsfA&oh=00_Afsctaij0Qeq2JzQ8IJvMEeQq-5zC9Pl8uQXNlOqYmeRSQ&oe=69A2DD0F" alt="ä½•é‘«å¯¦æ¥­" class="header-logo">
                        <div class="header-content">
                            <div class="company-title">
                                ä½•é‘«å¯¦æ¥­ å“¡å·¥ç¸¾æ•ˆè€ƒæ ¸ç³»çµ±
                                <div class="company-subtitle">HerHsin Performance Management System</div>
                            </div>
                        </div>
                    </div>
                    <div class="login-container">
                        <h2>ç³»çµ±ç™»å…¥</h2>
                        <div id="loginMessage"></div>
                        <form id="loginForm">
                            <div class="form-group">
                                <label>å¸³è™Ÿ</label>
                                <select id="loginUserId" required>
                                    <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å¯†ç¢¼</label>
                                <input type="password" id="loginPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å…¥</button>
                        </form>
                    </div>
                </div>
            `;

            loadUsers();

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        async function loadUsers() {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const select = document.getElementById('loginUserId');
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // åªé¡¯ç¤ºå¯ä»¥ç™»å…¥çš„ä½¿ç”¨è€…(æ’é™¤ä¸€èˆ¬è·å“¡)
                if (user.role !== 'employee') {
                    const option = document.createElement('option');
                    option.value = user.userId;
                    option.textContent = `${user.name} (${user.userId})`;
                    select.appendChild(option);
                }
            });
        }

        // è™•ç†ç™»å…¥
        async function handleLogin(e) {
            e.preventDefault();
            const userId = document.getElementById('loginUserId').value;
            const password = document.getElementById('loginPassword').value;

            const userDoc = await getDoc(doc(db, 'users', userId));
            
            if (!userDoc.exists()) {
                showMessage('loginMessage', 'å¸³è™Ÿä¸å­˜åœ¨', 'error');
                return;
            }

            const userData = userDoc.data();
            
            if (userData.password !== password) {
                showMessage('loginMessage', 'å¯†ç¢¼éŒ¯èª¤', 'error');
                return;
            }

            currentUser = userData;
            
            if (userData.role === 'admin') {
                renderAdminDashboard();
            } else {
                renderEvaluatorDashboard();
            }
        }

        // æ¸²æŸ“è©•åˆ†è€…å„€è¡¨æ¿
        function renderEvaluatorDashboard() {
            const app = document.getElementById('app');
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <img src="https://scontent.fkhh1-1.fna.fbcdn.net/v/t39.30808-6/638320048_1475577827909977_1700135213741656516_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=53a332&_nc_ohc=xGAAk3yJe8EQ7kNvwE8lz25&_nc_oc=AdlIyrb0DzEclqxgcIRChglQFyD__ug5GE190Xp93e0MGN4Y44qBjCg1SOooxScjmQA&_nc_zt=23&_nc_ht=scontent.fkhh1-1.fna&_nc_gid=Mn2LiUh0dop6qSALV1NsfA&oh=00_Afsctaij0Qeq2JzQ8IJvMEeQq-5zC9Pl8uQXNlOqYmeRSQ&oe=69A2DD0F" alt="ä½•é‘«å¯¦æ¥­" class="header-logo">
                        <div class="header-content">
                            <div class="company-title">
                                ä½•é‘«å¯¦æ¥­ å“¡å·¥ç¸¾æ•ˆè€ƒæ ¸ç³»çµ±
                                <div class="company-subtitle">HerHsin Performance Management System</div>
                            </div>
                        </div>
                        <div class="user-info">
                            <div class="user-name">${currentUser.name}</div>
                            ${currentUser.role === 'manager' ? '<button class="btn btn-secondary" onclick="window.showAdminPanel()">ç®¡ç†å¾Œå°</button>' : ''}
                            <button class="btn btn-secondary" onclick="window.logout()">ç™»å‡º</button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="tabs">
                            <button class="tab active" onclick="window.switchEvaluationTab(0)">ä¸€èˆ¬è©•æ ¸</button>
                            <button class="tab" onclick="window.switchEvaluationTab(1)">KPIæª¢æ ¸</button>
                        </div>
                        
                        <div id="evalTab0" class="tab-content active">
                            <h2>æœ¬æœˆè©•æ ¸äººå“¡ (${currentMonth.slice(0,4)}å¹´${currentMonth.slice(4)}æœˆ)</h2>
                            <div id="employeeList" class="employee-grid">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                        
                        <div id="evalTab1" class="tab-content">
                            <h2>KPIæª¢æ ¸è¡¨ç®¡ç†</h2>
                            <div id="kpiChecklistContainer">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            loadEvaluationList();
        }

        // åˆ‡æ›è©•åˆ†ç³»çµ±åˆ†é 
        window.switchEvaluationTab = function(index) {
            const tabs = document.querySelectorAll('.content > .tabs .tab');
            const contents = document.querySelectorAll('#evalTab0, #evalTab1');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
            
            if (index === 1) {
                loadKPIChecklists();
            }
        };

        // è¼‰å…¥è©•æ ¸äººå“¡åˆ—è¡¨
        async function loadEvaluationList() {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            const employeeListDiv = document.getElementById('employeeList');
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const employees = [];
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // æª¢æŸ¥ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦æ˜¯é€™å€‹å“¡å·¥çš„è©•æ ¸è€…
                if (user.evaluators && user.evaluators.includes(currentUser.userId)) {
                    // ä½¿ç”¨æ–°çš„evaluationFrequencyåˆ¤æ–·
                    const needsEvaluation = checkNeedsEvaluationByFrequency(user.evaluationFrequency || 'none', currentMonth);
                    if (needsEvaluation) {
                        employees.push(user);
                    }
                }
            });

            if (employees.length === 0) {
                employeeListDiv.innerHTML = '<p style="text-align: center; color: #a0aec0;">æœ¬æœˆç„¡éœ€è©•æ ¸äººå“¡</p>';
                return;
            }

            let html = '';
            for (const employee of employees) {
                const evaluationId = `${employee.userId}_${currentUser.userId}_${currentMonth}`;
                const evalDoc = await getDoc(doc(db, 'evaluations', evaluationId));
                const status = evalDoc.exists() ? evalDoc.data().status : 'pending';
                
                const cardClass = status === 'submitted' ? 'employee-card submitted' : 'employee-card';
                const statusText = status === 'submitted' ? 'âœ“ å·²é€å‡º' : 'å¾…è©•åˆ†';
                
                html += `
                    <div class="${cardClass}" onclick="window.openEvaluation('${employee.userId}', '${status}')">
                        <h3>${employee.name}</h3>
                        <p>${employee.level}</p>
                        <p style="margin-top: 10px; color: ${status === 'submitted' ? '#48bb78' : '#ed8936'};">
                            ${statusText}
                        </p>
                    </div>
                `;
            }
            
            employeeListDiv.innerHTML = html;
        }

        // æ ¹æ“šè©•æ ¸é »ç‡åˆ¤æ–·æ˜¯å¦éœ€è¦è©•æ ¸
        function checkNeedsEvaluationByFrequency(frequency, month) {
            if (frequency === 'none') {
                return false;
            }
            
            if (frequency === 'monthly') {
                return true; // æ¯æœˆéƒ½è©•æ ¸
            }
            
            if (frequency === 'quarterly') {
                const monthNum = parseInt(month.slice(4));
                return [3, 5, 9, 12].includes(monthNum); // å­£è©•æ ¸
            }
            
            return false;
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦è©•æ ¸ï¼ˆèˆŠç‰ˆï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
        function checkNeedsEvaluation(level, month) {
            // L5 æˆ–ç„¡è·ç­‰ä¸éœ€è©•æ ¸
            if (!level || level === 'L5' || level === '') {
                return false;
            }
            
            const monthNum = parseInt(month.slice(4));
            
            if (level === 'L1') {
                return true; // æ¯æœˆè©•æ ¸
            } else if (['L2', 'L3', 'L4'].includes(level)) {
                return [3, 5, 9, 12].includes(monthNum); // å­£è©•æ ¸(é…åˆä¸‰ç¯€çé‡‘)
            }
            
            return false;
        }

        // é–‹å•Ÿè©•åˆ†è¡¨
        window.openEvaluation = async function(employeeId, status) {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            
            // æª¢æŸ¥è©²æœˆä»½çš„é–å–®ç‹€æ…‹
            const lockDoc = await getDoc(doc(db, 'system_settings', `evaluation_lock_${currentMonth}`));
            const isLocked = lockDoc.exists() && lockDoc.data().isLocked;
            
            // å¦‚æœå·²é–å®šä¸”å°šæœªé€å‡ºï¼Œå‰‡ç¦æ­¢è©•åˆ†
            if (isLocked && status !== 'submitted') {
                const monthDisplay = `${currentMonth.substring(0,4)}-${currentMonth.substring(4,6)}`;
                alert(`ğŸ”’ ${monthDisplay} çš„è©•åˆ†å·²è¢«ç®¡ç†å“¡é–å®š\nç›®å‰ç„¡æ³•é€²è¡Œè©•åˆ†æˆ–ç·¨è¼¯è‰ç¨¿\n\nè«‹è¯çµ¡ç®¡ç†å“¡äº†è§£è©³æƒ…`);
                return;
            }
            
            const evaluationId = `${employeeId}_${currentUser.userId}_${currentMonth}`;
            
            // å–å¾—å“¡å·¥è³‡æ–™
            const employeeDoc = await getDoc(doc(db, 'users', employeeId));
            const employee = employeeDoc.data();
            
            // å–å¾—è©•åˆ†è¡¨ç¯„æœ¬
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', `${employeeId}_${currentMonth}`));
            
            if (!templateDoc.exists()) {
                alert('æ­¤å“¡å·¥å°šæœªè¨­å®šè©•åˆ†è¡¨ç¯„æœ¬ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
                return;
            }
            
            const template = templateDoc.data();
            
            // å–å¾—å·²å„²å­˜çš„è©•åˆ†
            const evalDoc = await getDoc(doc(db, 'evaluations', evaluationId));
            const savedScores = evalDoc.exists() ? evalDoc.data().scores : {};
            const savedComment = evalDoc.exists() ? evalDoc.data().comment : '';
            const isSubmitted = status === 'submitted';
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦KPIè‡ªå‹•å›å¡«
            let kpiAutoFillData = null;
            if (employee.needKPI && employee.kpiSettings?.targetField) {
                kpiAutoFillData = await calculateKPIAutoFill(employeeId, currentMonth, employee.kpiSettings.targetField);
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>${employee.name} - ${currentMonth.slice(0,4)}å¹´${currentMonth.slice(4)}æœˆè©•æ ¸</h2>
                    
                    ${kpiAutoFillData && kpiAutoFillData.hasKPIData ? `
                    <div style="background: #dcfce7; border: 1px solid #059669; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #059669; margin-bottom: 10px;">ğŸ“Š KPIè‡ªå‹•è©•åˆ†</h4>
                        <div style="color: #166534;">
                            <div><strong>æœ¬${kpiAutoFillData.isQuarterly ? 'å­£' : 'æœˆ'}KPIå¹³å‡: ${kpiAutoFillData.averageScore.toFixed(1)}%</strong> (${kpiAutoFillData.scoreOutOf5.toFixed(2)}/5.0åˆ†)</div>
                            <div style="font-size: 0.9em; margin-top: 5px;">
                                ${kpiAutoFillData.monthlyScores.map(s => `${s.month}æœˆ: ${s.score.toFixed(1)}%`).join(' | ')}
                            </div>
                            <div style="font-size: 0.85em; margin-top: 8px; color: #15803d;">
                                âœ“ å·²è‡ªå‹•å›å¡«åˆ°ã€Œ${kpiAutoFillData.targetFieldName}ã€æ¬„ä½
                            </div>
                        </div>
                    </div>
                    ` : employee.needKPI ? `
                    <div style="background: #fff3cd; border: 1px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #92400e; margin-bottom: 5px;">âš ï¸ KPIè©•æ ¸æœªå®Œæˆ</h4>
                        <div style="color: #78350f; font-size: 0.9em;">
                            æ­¤å“¡å·¥éœ€è¦KPIè©•æ ¸ï¼Œä½†${kpiAutoFillData.isQuarterly ? 'æœ¬å­£' : 'æœ¬æœˆ'}KPIæª¢æ ¸è¡¨å°šæœªå…¨éƒ¨é€å‡º<br>
                            ${kpiAutoFillData.missingMonths.length > 0 ? `ç¼ºå°‘æœˆä»½: ${kpiAutoFillData.missingMonths.join(', ')}` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div id="evaluationMessage"></div>
                    <form id="evaluationForm">
                        ${renderEvaluationForm(template, savedScores, isSubmitted, kpiAutoFillData)}
                        
                        <div class="form-group">
                            <label>ç¸½è©•èª</label>
                            <textarea id="comment" rows="4" ${isSubmitted ? 'disabled' : ''}>${savedComment}</textarea>
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px;">
                            ${!isSubmitted ? `
                                <button type="button" class="btn btn-secondary" onclick="window.saveEvaluationDraft('${evaluationId}', '${employeeId}')">æš«å­˜</button>
                                <button type="button" class="btn btn-success" onclick="window.submitEvaluation('${evaluationId}', '${employeeId}')">ç¢ºèªé€å‡º</button>
                            ` : `
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">é—œé–‰</button>
                            `}
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // è¨ˆç®—KPIè‡ªå‹•å›å¡«è³‡æ–™
        async function calculateKPIAutoFill(employeeId, currentPeriod, targetField) {
            // å–å¾—å“¡å·¥è³‡æ–™ä»¥åˆ¤æ–·è©•æ ¸é »ç‡
            const userDoc = await getDoc(doc(db, 'users', employeeId));
            const userData = userDoc.data();
            const isQuarterly = userData.evaluationFrequency === 'quarterly';
            
            // åˆ¤æ–·éœ€è¦è¨ˆç®—çš„æœˆä»½
            const year = currentPeriod.slice(0, 4);
            const month = parseInt(currentPeriod.slice(4));
            let monthsToCalculate = [];
            
            if (isQuarterly) {
                // å­£è©•æ ¸ï¼šè¨ˆç®—æœ¬å­£çš„3å€‹æœˆKPIå¹³å‡
                // 3æœˆå­£: 1,2,3æœˆ; 5æœˆå­£: 3,4,5æœˆ; 9æœˆå­£: 6,7,8,9æœˆ; 12æœˆå­£: 10,11,12æœˆ
                if (month === 3) {
                    monthsToCalculate = [1, 2, 3];
                } else if (month === 5) {
                    monthsToCalculate = [3, 4, 5];
                } else if (month === 9) {
                    monthsToCalculate = [6, 7, 8, 9];
                } else if (month === 12) {
                    monthsToCalculate = [10, 11, 12];
                }
            } else {
                // æœˆè©•æ ¸ï¼šåªè¨ˆç®—æœ¬æœˆ
                monthsToCalculate = [month];
            }
            
            // æŸ¥è©¢KPIæª¢æ ¸è¡¨ä¸¦æ”¶é›†åˆ†æ•¸
            const kpiScores = [];
            const missingMonths = [];
            
            for (const m of monthsToCalculate) {
                const period = `${year}${String(m).padStart(2, '0')}`;
                const kpiId = `kpi_${employeeId}_${period}`;
                const kpiDoc = await getDoc(doc(db, 'kpi_checklists', kpiId));
                
                if (kpiDoc.exists() && kpiDoc.data().status === 'submitted') {
                    kpiScores.push({
                        month: m,
                        score: kpiDoc.data().totalScore || 0
                    });
                } else {
                    missingMonths.push(`${m}æœˆ`);
                }
            }
            
            // å¦‚æœæ²’æœ‰ä»»ä½•KPIè³‡æ–™
            if (kpiScores.length === 0) {
                return {
                    hasKPIData: false,
                    isQuarterly: isQuarterly,
                    missingMonths: missingMonths,
                    targetField: targetField
                };
            }
            
            // è¨ˆç®—å¹³å‡åˆ†æ•¸
            const averageScore = kpiScores.reduce((sum, s) => sum + s.score, 0) / kpiScores.length;
            const scoreOutOf5 = (averageScore / 100) * 5;
            
            // å–å¾—æ¬„ä½åç¨±
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', `${employeeId}_${currentPeriod}`));
            let targetFieldName = targetField;
            
            if (templateDoc.exists()) {
                const template = templateDoc.data();
                // è§£ætargetField (ä¾‹å¦‚: flat_2_0)
                const parts = targetField.split('_');
                if (parts[0] === 'flat' && template.categories) {
                    const catIndex = parseInt(parts[1]);
                    const itemIndex = parseInt(parts[2]);
                    if (template.categories[catIndex] && template.categories[catIndex].items[itemIndex]) {
                        targetFieldName = `${template.categories[catIndex].name} - ${template.categories[catIndex].items[itemIndex]}`;
                    }
                }
            }
            
            return {
                hasKPIData: true,
                isQuarterly: isQuarterly,
                averageScore: averageScore,
                scoreOutOf5: scoreOutOf5,
                monthlyScores: kpiScores,
                missingMonths: missingMonths,
                targetField: targetField,
                targetFieldName: targetFieldName
            };
        }

        // æ¸²æŸ“è©•åˆ†è¡¨å–®
        function renderEvaluationForm(template, savedScores, isDisabled, kpiAutoFillData) {
            let html = '';
            
            // åˆ¤æ–·ç¯„æœ¬é¡å‹
            if (template.templateType === 'flat') {
                // L3ã€L4 æ‰å¹³åŒ–çµæ§‹ - åªæœ‰ä¸€å€‹è©•åˆ†æ¬„ä½
                if (template.categories) {
                    template.categories.forEach((category, catIndex) => {
                        html += `<div class="category-section">`;
                        html += `<h3 class="category-title">${category.name} (ä½”æ¯”: ${category.weight}%)</h3>`;
                        
                        category.items.forEach((item, itemIndex) => {
                            const itemKey = `flat_${catIndex}_${itemIndex}`;
                            
                            // æª¢æŸ¥æ˜¯å¦ç‚ºKPIè‡ªå‹•å›å¡«æ¬„ä½
                            const isKPIField = kpiAutoFillData?.hasKPIData && kpiAutoFillData.targetField === itemKey;
                            const score = isKPIField ? kpiAutoFillData.scoreOutOf5.toFixed(2) : (savedScores[`${itemKey}`] || '');
                            const fieldDisabled = isDisabled || isKPIField;
                            
                            html += `
                                <div class="item-row" style="grid-template-columns: 2fr 1fr; ${isKPIField ? 'background: #dcfce7; border: 2px solid #059669; padding: 12px; border-radius: 8px;' : ''}">
                                    <div class="item-name">
                                        ${item}
                                        ${isKPIField ? '<br><span style="color: #059669; font-size: 0.9em; font-weight: bold;">ğŸ“Š KPIè‡ªå‹•è©•åˆ†</span>' : ''}
                                    </div>
                                    <div class="score-input">
                                        <label>è©•åˆ† (0-5åˆ†) ${isKPIField ? '<span style="color: #059669;">ğŸ”’</span>' : ''}</label>
                                        <input type="number" name="${itemKey}" min="0" max="5" step="0.1" value="${score}" ${fieldDisabled ? 'disabled' : ''} oninput="window.validateScore(this)" style="${isKPIField ? 'background: #f0fdf4; border: 2px solid #059669; font-weight: bold;' : ''}">
                                        ${isKPIField ? 
                                            `<div style="font-size: 0.75em; color: #059669; margin-top: 4px; font-weight: bold;">KPI${kpiAutoFillData.isQuarterly ? 'å­£' : 'æœˆ'}åº¦å¹³å‡: ${kpiAutoFillData.averageScore.toFixed(1)}%</div>` :
                                            `<div style="font-size: 0.75em; color: #718096; margin-top: 4px;">ç„¡è¦åŠƒ[0] é¦¬è™[1] éƒ¨åˆ†åŸ·è¡Œ[2~3] å®Œæ•´åŸ·è¡Œ[4~5]</div>`
                                        }
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    });
                }
            } else {
                // L1ã€L2 çµæ§‹åŒ– - å…©å€‹è©•åˆ†æ¬„ä½
                // å·¥ä½œè¡¨ç¾
                if (template.workPerformance) {
                    html += '<div class="category-section"><h3 class="category-title">å·¥ä½œè¡¨ç¾</h3>';
                    template.workPerformance.forEach((category, catIndex) => {
                        html += `<h4 style="margin: 15px 0 10px 0;">${category.name} (ä½”æ¯”: ${category.weight}%)</h4>`;
                        category.items.forEach((item, itemIndex) => {
                            const itemKey = `work_${catIndex}_${itemIndex}`;
                            const score1 = savedScores[`${itemKey}_1`] || '';
                            const score2 = savedScores[`${itemKey}_2`] || '';
                            
                            html += `
                                <div class="item-row">
                                    <div class="item-name">${item}</div>
                                    <div class="score-input">
                                        <label>åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§</label>
                                        <input type="number" name="${itemKey}_1" min="0" max="5" step="0.1" value="${score1}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                    </div>
                                    <div class="score-input">
                                        <label>éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§</label>
                                        <input type="number" name="${itemKey}_2" min="0" max="5" step="0.1" value="${score2}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                    </div>
                                </div>
                            `;
                        });
                    });
                    html += '</div>';
                }
                
                // ç¶œåˆè¡¨ç¾
                if (template.comprehensivePerformance) {
                    html += '<div class="category-section"><h3 class="category-title">ç¶œåˆè¡¨ç¾</h3>';
                    template.comprehensivePerformance.forEach((category, catIndex) => {
                        html += `<h4 style="margin: 15px 0 10px 0;">${category.name} (ä½”æ¯”: ${category.weight}%)</h4>`;
                        category.items.forEach((item, itemIndex) => {
                            const itemKey = `comp_${catIndex}_${itemIndex}`;
                            const score1 = savedScores[`${itemKey}_1`] || '';
                            const score2 = savedScores[`${itemKey}_2`] || '';
                            
                            html += `
                                <div class="item-row">
                                    <div class="item-name">${item}</div>
                                    <div class="score-input">
                                        <label>åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§</label>
                                        <input type="number" name="${itemKey}_1" min="0" max="5" step="0.1" value="${score1}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                    </div>
                                    <div class="score-input">
                                        <label>éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§</label>
                                        <input type="number" name="${itemKey}_2" min="0" max="5" step="0.1" value="${score2}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                    </div>
                                </div>
                            `;
                        });
                    });
                    html += '</div>';
                }
                
                // å€‹äººå­¸ç¿’
                if (template.personalLearning) {
                    html += '<div class="category-section"><h3 class="category-title">å€‹äººå­¸ç¿’</h3>';
                    template.personalLearning.items.forEach((item, itemIndex) => {
                        const itemKey = `learn_${itemIndex}`;
                        const score1 = savedScores[`${itemKey}_1`] || '';
                        const score2 = savedScores[`${itemKey}_2`] || '';
                        
                        html += `
                            <div class="item-row">
                                <div class="item-name">${item}</div>
                                <div class="score-input">
                                    <label>åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§</label>
                                    <input type="number" name="${itemKey}_1" min="0" max="5" step="0.1" value="${score1}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                </div>
                                <div class="score-input">
                                    <label>éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§</label>
                                    <input type="number" name="${itemKey}_2" min="0" max="5" step="0.1" value="${score2}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }
            
            return html;
        }

        // å„²å­˜è©•åˆ†è‰ç¨¿
        window.saveEvaluationDraft = async function(evaluationId, employeeId) {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            
            // æª¢æŸ¥è©²æœˆä»½çš„é–å–®ç‹€æ…‹
            const lockDoc = await getDoc(doc(db, 'system_settings', `evaluation_lock_${currentMonth}`));
            if (lockDoc.exists() && lockDoc.data().isLocked) {
                const monthDisplay = `${currentMonth.substring(0,4)}-${currentMonth.substring(4,6)}`;
                alert(`ğŸ”’ ${monthDisplay} çš„è©•åˆ†å·²è¢«é–å®šï¼Œç„¡æ³•å„²å­˜è‰ç¨¿`);
                return;
            }
            
            // é©—è­‰åˆ†æ•¸
            if (!validateAllScores()) {
                alert('è©•åˆ†ä¸å¯è¶…é 5 åˆ†!è«‹æª¢æŸ¥æ‰€æœ‰è©•åˆ†æ¬„ä½ã€‚');
                return;
            }
            
            const form = document.getElementById('evaluationForm');
            const formData = new FormData(form);
            const scores = {};
            
            for (let [key, value] of formData.entries()) {
                if (key !== 'comment') {
                    scores[key] = value;
                }
            }
            
            const comment = document.getElementById('comment').value;
            
            await setDoc(doc(db, 'evaluations', evaluationId), {
                evaluationId: evaluationId,
                evaluateeId: employeeId,
                evaluatorId: currentUser.userId,
                period: currentMonth,
                status: 'draft',
                scores: scores,
                comment: comment,
                updatedAt: new Date().toISOString()
            });
            
            showMessage('evaluationMessage', 'å·²å„²å­˜è‰ç¨¿', 'success');
        };

        // é€å‡ºè©•åˆ†
        window.submitEvaluation = async function(evaluationId, employeeId) {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            
            // æª¢æŸ¥è©²æœˆä»½çš„é–å–®ç‹€æ…‹
            const lockDoc = await getDoc(doc(db, 'system_settings', `evaluation_lock_${currentMonth}`));
            if (lockDoc.exists() && lockDoc.data().isLocked) {
                const monthDisplay = `${currentMonth.substring(0,4)}-${currentMonth.substring(4,6)}`;
                alert(`ğŸ”’ ${monthDisplay} çš„è©•åˆ†å·²è¢«é–å®šï¼Œç„¡æ³•é€å‡ºè©•åˆ†`);
                return;
            }
            
            // é©—è­‰åˆ†æ•¸
            if (!validateAllScores()) {
                alert('è©•åˆ†ä¸å¯è¶…é 5 åˆ†!è«‹æª¢æŸ¥æ‰€æœ‰è©•åˆ†æ¬„ä½ã€‚');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦é€å‡ºè©•åˆ†å—?é€å‡ºå¾Œå°‡ç„¡æ³•ä¿®æ”¹!')) {
                return;
            }
            
            const form = document.getElementById('evaluationForm');
            const formData = new FormData(form);
            const scores = {};
            
            for (let [key, value] of formData.entries()) {
                if (key !== 'comment') {
                    scores[key] = value;
                }
            }
            
            const comment = document.getElementById('comment').value;
            
            await setDoc(doc(db, 'evaluations', evaluationId), {
                evaluationId: evaluationId,
                evaluateeId: employeeId,
                evaluatorId: currentUser.userId,
                period: currentMonth,
                status: 'submitted',
                scores: scores,
                comment: comment,
                submittedAt: new Date().toISOString()
            });
            
            alert('è©•åˆ†å·²é€å‡º!');
            document.querySelector('.modal').remove();
            loadEvaluationList();
        };

        // é©—è­‰æ‰€æœ‰è©•åˆ†ä¸è¶…é5åˆ†
        function validateAllScores() {
            const form = document.getElementById('evaluationForm');
            if (!form) return true;
            
            const inputs = form.querySelectorAll('input[type="number"]');
            for (let input of inputs) {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 5) {
                    input.style.borderColor = '#f56565';
                    return false;
                }
            }
            return true;
        }

        // å³æ™‚é©—è­‰å–®ä¸€è©•åˆ†æ¬„ä½
        window.validateScore = function(input) {
            const value = parseFloat(input.value);
            if (!isNaN(value) && value > 5) {
                input.style.borderColor = '#f56565';
                input.style.backgroundColor = '#fff5f5';
            } else {
                input.style.borderColor = '#cbd5e0';
                input.style.backgroundColor = '#ffffff';
            }
        };

        // æ¸²æŸ“ç®¡ç†å“¡å„€è¡¨æ¿
        function renderAdminDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <img src="https://scontent.fkhh1-1.fna.fbcdn.net/v/t39.30808-6/638320048_1475577827909977_1700135213741656516_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=53a332&_nc_ohc=xGAAk3yJe8EQ7kNvwE8lz25&_nc_oc=AdlIyrb0DzEclqxgcIRChglQFyD__ug5GE190Xp93e0MGN4Y44qBjCg1SOooxScjmQA&_nc_zt=23&_nc_ht=scontent.fkhh1-1.fna&_nc_gid=Mn2LiUh0dop6qSALV1NsfA&oh=00_Afsctaij0Qeq2JzQ8IJvMEeQq-5zC9Pl8uQXNlOqYmeRSQ&oe=69A2DD0F" alt="ä½•é‘«å¯¦æ¥­" class="header-logo">
                        <div class="header-content">
                            <div class="company-title">
                                ä½•é‘«å¯¦æ¥­ å“¡å·¥ç¸¾æ•ˆè€ƒæ ¸ç³»çµ±
                                <div class="company-subtitle">HerHsin Performance Management System</div>
                            </div>
                        </div>
                        <div class="user-info">
                            <div class="user-name">${currentUser.name}</div>
                            ${currentUser.role === 'manager' ? '<button class="btn btn-secondary" onclick="window.backToEvaluation()">è¿”å›è©•åˆ†é é¢</button>' : ''}
                            <button class="btn btn-secondary" onclick="window.logout()">ç™»å‡º</button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="tabs">
                            ${currentUser.role === 'admin' ? '<button class="tab active" onclick="window.switchTab(0)">äººå“¡ç®¡ç†</button>' : ''}
                            <button class="tab ${currentUser.role === 'admin' ? '' : 'active'}" onclick="window.switchTab(${currentUser.role === 'admin' ? '1' : '0'})">è€ƒæ ¸çµ±è¨ˆè¡¨</button>
                            <button class="tab" onclick="window.switchTab(${currentUser.role === 'admin' ? '2' : '1'})">è·ç­‰æ¯”å°åœ–è¡¨</button>
                            <button class="tab" onclick="window.switchTab(${currentUser.role === 'admin' ? '3' : '2'})">ç·¨è¼¯è€ƒæ ¸è¡¨</button>
                            <button class="tab" onclick="window.switchTab(${currentUser.role === 'admin' ? '4' : '3'})">KPIæª¢æ ¸ç®¡ç†</button>
                            <button class="tab" onclick="window.switchTab(${currentUser.role === 'admin' ? '5' : '4'})">è©•åˆ†é€²åº¦è¿½è¹¤</button>
                        </div>
                        
                        ${currentUser.role === 'admin' ? `
                        <div id="tab0" class="tab-content active">
                            ${renderUserManagement()}
                        </div>
                        ` : ''}
                        <div id="tab${currentUser.role === 'admin' ? '1' : '0'}" class="tab-content ${currentUser.role === 'admin' ? '' : 'active'}">
                            <h2>è€ƒæ ¸çµ±è¨ˆè¡¨</h2>
                            <div class="form-group" style="max-width: 400px;">
                                <label>é¸æ“‡æœˆä»½</label>
                                <input type="month" id="statsMonth" onchange="window.loadStatistics()">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <button class="btn btn-primary" onclick="window.downloadCSV()">ğŸ“¥ ä¸‹è¼‰è©•åˆ†æ˜ç´° CSV</button>
                            </div>
                            <div id="statisticsContainer">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                        <div id="tab${currentUser.role === 'admin' ? '2' : '1'}" class="tab-content">
                            <h2>è·ç­‰æ¯”å°åœ–è¡¨</h2>
                            <div class="form-group" style="max-width: 400px;">
                                <label>é¸æ“‡å¹´åº¦</label>
                                <input type="number" id="chartYear" min="2020" max="2099" onchange="window.loadCharts()">
                            </div>
                            <div id="chartsContainer">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                        <div id="tab${currentUser.role === 'admin' ? '3' : '2'}" class="tab-content">
                            ${renderTemplateEditor()}
                        </div>
                        <div id="tab${currentUser.role === 'admin' ? '4' : '3'}" class="tab-content">
                            ${renderKPIManagement()}
                        </div>
                        <div id="tab${currentUser.role === 'admin' ? '5' : '4'}" class="tab-content">
                            ${renderProgressTracking()}
                        </div>
                    </div>
                </div>
            `;
            
            if (currentUser.role === 'admin') {
                loadUsersList();
            }
            loadTemplateEmployees();
            
            // è¨­å®šç•¶å‰æœˆä»½ä¸¦è‡ªå‹•è¼‰å…¥çµ±è¨ˆè³‡æ–™
            const currentMonth = new Date().toISOString().slice(0, 7);
            const statsMonthInput = document.getElementById('statsMonth');
            if (statsMonthInput) {
                statsMonthInput.value = currentMonth;
                window.loadStatistics();
            }
            
            // è¨­å®šç•¶å‰å¹´åº¦ä¸¦è‡ªå‹•è¼‰å…¥åœ–è¡¨
            const currentYear = new Date().getFullYear();
            const chartYearInput = document.getElementById('chartYear');
            if (chartYearInput) {
                chartYearInput.value = currentYear;
                window.loadCharts();
            }
            
            // è¨­å®šè©•åˆ†é€²åº¦è¿½è¹¤æœˆä»½ï¼ˆä½†ä¸ç«‹å³è¼‰å…¥ï¼Œç­‰åˆ‡æ›åˆ°è©²tabæ™‚å†è¼‰å…¥ï¼‰
            const progressMonthInput = document.getElementById('progressMonth');
            if (progressMonthInput) {
                progressMonthInput.value = currentMonth;
            }
        }

        // åˆ‡æ›åˆ†é 
        window.switchTab = function(index) {
            // ç§»é™¤æ‰€æœ‰tabçš„active class
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            // éš±è—æ‰€æœ‰tab-content
            document.querySelectorAll('.tab-content').forEach((content) => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // è¨ˆç®—æ­£ç¢ºçš„tab ID
            let tabId;
            if (currentUser.role === 'admin') {
                tabId = `tab${index}`;
            } else {
                // manageræ²’æœ‰tab0ï¼Œæ‰€ä»¥è¦èª¿æ•´
                tabId = `tab${index}`;
            }
            
            // é¡¯ç¤ºç›®æ¨™tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
            }
            
            // åˆ‡æ›åˆ°KPIæª¢æ ¸ç®¡ç†æ™‚,è‡ªå‹•è¼‰å…¥æª¢æ ¸è¡¨åˆ—è¡¨
            const kpiTabIndex = currentUser.role === 'admin' ? 4 : 3;
            if (index === kpiTabIndex) {
                setTimeout(() => {
                    // é è¨­è¼‰å…¥ç¬¬ä¸€å€‹å­tabï¼ˆæª¢æ ¸è¡¨å¡«å¯«ï¼‰
                    loadKPIChecklists();
                }, 150);
            }
            
            // åˆ‡æ›åˆ°è©•åˆ†é€²åº¦è¿½è¹¤æ™‚,è‡ªå‹•è¼‰å…¥æ•¸æ“š
            const progressTabIndex = currentUser.role === 'admin' ? 5 : 4;
            if (index === progressTabIndex) {
                setTimeout(() => {
                    const progressMonthInput = document.getElementById('progressMonth');
                    if (progressMonthInput) {
                        if (!progressMonthInput.value) {
                            progressMonthInput.value = new Date().toISOString().slice(0, 7);
                        }
                        window.loadProgressTracking();
                    }
                    window.loadMonthLockStatus();
                }, 200);
            }
        };

        // åˆ‡æ›KPIç®¡ç†å­åˆ†é 
        window.switchKPITab = function(index) {
            const tabs = document.querySelectorAll('#tab' + (currentUser.role === 'admin' ? '4' : '3') + ' .tab');
            const contents = document.querySelectorAll('#kpiTab0, #kpiTab1');
            
            // æ›´æ–°tabæŒ‰éˆ•çš„activeç‹€æ…‹
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            // æ›´æ–°tabå…§å®¹çš„activeç‹€æ…‹ä¸¦æ¸…é™¤inline style
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
                content.style.display = '';  // æ¸…é™¤inline styleï¼Œè®“CSSè¦å‰‡ç”Ÿæ•ˆ
            });
            
            if (index === 0) {
                loadKPIChecklists();
            } else {
                loadKPITemplates();
            }
        };

        // å…¨åŸŸé–å–®åŠŸèƒ½
        // åˆ‡æ›æœˆä»½é–å–®
        window.toggleMonthLock = async function(checkbox) {
            const month = document.getElementById('progressMonth').value;
            if (!month) {
                alert('è«‹å…ˆé¸æ“‡æœˆä»½');
                checkbox.checked = false;
                return;
            }
            
            const period = month.replace('-', '');
            const isLocked = checkbox.checked;
            const lockStatus = document.getElementById('monthLockStatus');
            const lockInfo = document.getElementById('monthLockInfo');
            
            if (isLocked) {
                if (!confirm(`ç¢ºå®šè¦é–å®š ${month} çš„è©•åˆ†å—ï¼Ÿ\n\né–å®šå¾Œï¼š\nâ€¢ ä¸»ç®¡ç„¡æ³•é–‹å§‹æ–°çš„è©•åˆ†\nâ€¢ æœªé€å‡ºçš„è‰ç¨¿ç„¡æ³•ç·¨è¼¯\nâ€¢ å·²é€å‡ºçš„è©•åˆ†ä¸å—å½±éŸ¿\n\næ‚¨å¯ä»¥éš¨æ™‚è§£é–`)) {
                    checkbox.checked = false;
                    return;
                }
            }
            
            try {
                await setDoc(doc(db, 'system_settings', `evaluation_lock_${period}`), {
                    period: period,
                    month: month,
                    isLocked: isLocked,
                    lockedAt: isLocked ? new Date().toISOString() : null,
                    lockedBy: isLocked ? currentUser.userId : null,
                    lockedByName: isLocked ? currentUser.name : null,
                    unlockedAt: !isLocked ? new Date().toISOString() : null,
                    unlockedBy: !isLocked ? currentUser.userId : null
                });
                
                lockStatus.textContent = isLocked ? `${month} å·²é–å®š` : `${month} é–‹æ”¾è©•åˆ†`;
                lockStatus.style.color = isLocked ? '#dc2626' : '#059669';
                
                if (isLocked) {
                    lockInfo.textContent = `é–å®šæ™‚é–“: ${new Date().toLocaleString('zh-TW')} | é–å®šäºº: ${currentUser.name}`;
                } else {
                    lockInfo.textContent = `è§£é–æ™‚é–“: ${new Date().toLocaleString('zh-TW')} | è§£é–äºº: ${currentUser.name}`;
                }
                
                alert(isLocked ? `å·²é–å®š ${month} çš„è©•åˆ†ï¼` : `å·²è§£é– ${month} çš„è©•åˆ†ï¼`);
            } catch (error) {
                console.error('é–å®šè¨­å®šå¤±æ•—:', error);
                alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                checkbox.checked = !isLocked;
            }
        };

        // è¼‰å…¥æœˆä»½é–å®šç‹€æ…‹
        window.loadMonthLockStatus = async function() {
            const month = document.getElementById('progressMonth').value;
            if (!month) return;
            
            const period = month.replace('-', '');
            
            try {
                const lockDoc = await getDoc(doc(db, 'system_settings', `evaluation_lock_${period}`));
                const checkbox = document.getElementById('monthLockToggle');
                const lockStatus = document.getElementById('monthLockStatus');
                const lockInfo = document.getElementById('monthLockInfo');
                
                if (lockDoc.exists() && lockDoc.data().isLocked) {
                    const data = lockDoc.data();
                    if (checkbox) checkbox.checked = true;
                    if (lockStatus) {
                        lockStatus.textContent = `${month} å·²é–å®š`;
                        lockStatus.style.color = '#dc2626';
                    }
                    if (lockInfo && data.lockedAt) {
                        const lockTime = new Date(data.lockedAt).toLocaleString('zh-TW');
                        lockInfo.textContent = `é–å®šæ™‚é–“: ${lockTime} | é–å®šäºº: ${data.lockedByName || 'æœªçŸ¥'}`;
                    }
                } else {
                    if (checkbox) checkbox.checked = false;
                    if (lockStatus) {
                        lockStatus.textContent = `${month} é–‹æ”¾è©•åˆ†`;
                        lockStatus.style.color = '#059669';
                    }
                    if (lockInfo) {
                        lockInfo.textContent = '';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥é–å®šç‹€æ…‹å¤±æ•—:', error);
            }
        };

        // è¼‰å…¥KPIæª¢æ ¸è¡¨åˆ—è¡¨
        async function loadKPIChecklists() {
            const container = document.getElementById('kpiChecklistContainer');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°kpiChecklistContainer');
                return;
            }
            
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            
            try {
                // å–å¾—æ‰€æœ‰éœ€è¦KPIè©•æ ¸çš„å“¡å·¥
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const kpiEmployees = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    
                    // ä¿®æ”¹ç¯©é¸é‚è¼¯ï¼š
                    // 1. å¦‚æœæ˜¯adminï¼Œé¡¯ç¤ºæ‰€æœ‰éœ€è¦KPIçš„å“¡å·¥
                    // 2. å¦‚æœæ˜¯managerï¼Œåªé¡¯ç¤ºè‡ªå·±è² è²¬è©•æ ¸çš„å“¡å·¥
                    if (userData.needKPI) {
                        if (currentUser.role === 'admin') {
                            // adminå¯ä»¥çœ‹åˆ°æ‰€æœ‰äºº
                            kpiEmployees.push({
                                userId: doc.id,  // é‡è¦ï¼šåŠ å…¥userId
                                ...userData
                            });
                        } else if (userData.evaluators && userData.evaluators.includes(currentUser.userId)) {
                            // manageråªèƒ½çœ‹åˆ°è‡ªå·±è² è²¬çš„å“¡å·¥
                            kpiEmployees.push({
                                userId: doc.id,  // é‡è¦ï¼šåŠ å…¥userId
                                ...userData
                            });
                        }
                    }
                });
                
                if (kpiEmployees.length === 0) {
                    container.innerHTML = '<p style="color: #a0aec0;">ç„¡éœ€æ‚¨æª¢æ ¸çš„KPIå“¡å·¥</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 15px;">';
                
                for (const employee of kpiEmployees) {
                    // ä½¿ç”¨æ–°æ ¼å¼IDï¼ˆåŒ…å«ç•¶å‰è©•åˆ†äººï¼‰
                    const myKpiId = `kpi_${employee.userId}_${currentMonth}_${currentUser.userId}`;
                    const myKpiDoc = await getDoc(doc(db, 'kpi_checklists', myKpiId));
                    
                    // æª¢æŸ¥èˆŠæ ¼å¼è³‡æ–™ï¼ˆå…¼å®¹æ€§ï¼‰
                    const oldKpiId = `kpi_${employee.userId}_${currentMonth}`;
                    const oldKpiDoc = await getDoc(doc(db, 'kpi_checklists', oldKpiId));
                    
                    const myStatus = myKpiDoc.exists() ? myKpiDoc.data().status : 'æœªå»ºç«‹';
                    const hasOldData = oldKpiDoc.exists();
                    
                    const statusText = myStatus === 'submitted' ? 'âœ“ å·²é€å‡º' : myStatus === 'draft' ? 'â¸ æš«å­˜ä¸­' : 'å°šæœªå»ºç«‹';
                    const statusColor = myStatus === 'submitted' ? '#059669' : myStatus === 'draft' ? '#f59e0b' : '#dc2626';
                    
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #E3F2FD; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin-bottom: 5px;">${employee.name} (${employee.userId})</h3>
                                    <p style="color: #64748b; margin: 0;">è·ç­‰: ${employee.level} | é¡åˆ¥: ${employee.category === 'external' ? 'å¤–å‹¤' : 'å…§å‹¤'}</p>
                                    ${hasOldData && myStatus === 'æœªå»ºç«‹' ? '<p style="color: #f59e0b; font-size: 0.85em; margin-top: 5px;">âš ï¸ åµæ¸¬åˆ°èˆŠç‰ˆè³‡æ–™ï¼Œè«‹é‡æ–°è©•æ ¸</p>' : ''}
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${statusColor}; font-weight: bold; margin-bottom: 8px;">${statusText}</div>
                                    <button class="btn btn-primary" onclick="window.openKPIChecklist('${employee.userId}', '${currentMonth}')">
                                        ${myStatus === 'submitted' ? 'æŸ¥çœ‹æª¢æ ¸è¡¨' : 'å¡«å¯«æª¢æ ¸è¡¨'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥KPIæª¢æ ¸è¡¨å¤±æ•—:', error);
                container.innerHTML = `<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }

        // è¼‰å…¥KPIæª¢æ ¸é …ç›®è¨­å®š
        async function loadKPITemplates() {
            const container = document.getElementById('kpiTemplateContainer');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°kpiTemplateContainer');
                return;
            }
            
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            // åªæœ‰adminå¯ä»¥è¨­å®š
            if (currentUser.role !== 'admin') {
                container.innerHTML = '<p style="color: #dc2626;">åªæœ‰ç³»çµ±ç®¡ç†å“¡å¯ä»¥è¨­å®šKPIæª¢æ ¸é …ç›®</p>';
                return;
            }
            
            try {
                // å–å¾—æ‰€æœ‰éœ€è¦KPIçš„å“¡å·¥
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const kpiEmployees = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.needKPI) {
                        kpiEmployees.push({
                            userId: doc.id,  // é‡è¦ï¼šåŠ å…¥userId
                            ...userData
                        });
                    }
                });
                
                if (kpiEmployees.length === 0) {
                    container.innerHTML = '<p style="color: #a0aec0;">ç„¡éœ€KPIè©•æ ¸çš„å“¡å·¥<br><small>è«‹åœ¨ã€Œäººå“¡ç®¡ç†ã€ä¸­è¨­å®šéœ€è¦KPIè©•æ ¸çš„å“¡å·¥</small></p>';
                    return;
                }
                
                let html = '<div style="margin-bottom: 20px;">';
                html += '<button class="btn btn-primary" onclick="window.showKPITemplateEditor()">+ æ–°å¢/ç·¨è¼¯æª¢æ ¸é …ç›®ç¯„æœ¬</button>';
                html += '</div>';
                
                html += '<h4 style="margin-bottom: 15px;">éœ€è¦KPIè©•æ ¸çš„å“¡å·¥</h4>';
                html += '<div style="display: grid; gap: 10px;">';
                
                for (const employee of kpiEmployees) {
                    // æª¢æŸ¥æ˜¯å¦æœ‰ç¯„æœ¬
                    const templateDoc = await getDoc(doc(db, 'kpi_templates', employee.userId));
                    const hasTemplate = templateDoc.exists();
                    const itemCount = hasTemplate ? templateDoc.data().items?.length || 0 : 0;
                    
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #E3F2FD; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${employee.name}</strong> (${employee.userId}) - ${employee.level}
                                <div style="font-size: 0.9em; color: #64748b; margin-top: 5px;">
                                    å›å¡«æ¬„ä½: ${employee.kpiSettings?.targetField || 'æœªè¨­å®š'}
                                    ${hasTemplate ? `| æª¢æ ¸é …ç›®: ${itemCount}å€‹` : ''}
                                </div>
                            </div>
                            <div>
                                <button class="btn ${hasTemplate ? 'btn-secondary' : 'btn-primary'}" onclick="window.editKPITemplate('${employee.userId}')">
                                    ${hasTemplate ? 'ç·¨è¼¯ç¯„æœ¬' : 'å»ºç«‹ç¯„æœ¬'}
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥KPIç¯„æœ¬è¨­å®šå¤±æ•—:', error);
                container.innerHTML = `<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }

        // ç·¨è¼¯KPIæª¢æ ¸ç¯„æœ¬
        window.editKPITemplate = async function(employeeId) {
            // å–å¾—å“¡å·¥è³‡æ–™
            const userDoc = await getDoc(doc(db, 'users', employeeId));
            if (!userDoc.exists()) {
                alert('æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™');
                return;
            }
            const userData = userDoc.data();
            
            // å–å¾—ç¾æœ‰ç¯„æœ¬
            const templateDoc = await getDoc(doc(db, 'kpi_templates', employeeId));
            const templateData = templateDoc.exists() ? templateDoc.data() : { items: [] };
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>KPIæª¢æ ¸é …ç›®è¨­å®š - ${userData.name}</h2>
                    <div id="kpiTemplateMessage"></div>
                    
                    <div style="background: #F1F8FE; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">è¨­å®šèªªæ˜</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #64748b;">
                            <li>å‘¨æª¢æ ¸ï¼šæ¯æœˆæª¢æ ¸5æ¬¡ï¼ˆé ç•™5å€‹æ ¼å­ï¼‰</li>
                            <li>æœˆæª¢æ ¸ï¼šæ¯æœˆæª¢æ ¸1æ¬¡ï¼ˆåªæœ‰1å€‹æ ¼å­ï¼‰</li>
                            <li>å æ¯”ç¸½å’Œå»ºè­°ç‚º100%</li>
                            <li>å›å¡«æ¬„ä½: ${userData.kpiSettings?.targetField || 'æœªè¨­å®š'}</li>
                        </ul>
                    </div>
                    
                    <div id="kpiItemsContainer"></div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="window.addKPIItem()">+ æ–°å¢æª¢æ ¸é …ç›®</button>
                        <button class="btn btn-primary" onclick="window.saveKPITemplate('${employeeId}')">å„²å­˜ç¯„æœ¬</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
            window.currentKPIItems = templateData.items || [];
            window.currentKPIEmployeeId = employeeId;
            
            renderKPIItems();
        };

        // æ¸²æŸ“KPIæª¢æ ¸é …ç›®
        async function renderKPIItems() {
            const container = document.getElementById('kpiItemsContainer');
            if (!window.currentKPIItems || window.currentKPIItems.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0;">å°šç„¡æª¢æ ¸é …ç›®ï¼Œè«‹é»é¸ã€Œæ–°å¢æª¢æ ¸é …ç›®ã€</p>';
                return;
            }
            
            // å–å¾—è©²å“¡å·¥çš„æ‰€å±¬ä¸»ç®¡åˆ—è¡¨
            const employeeDoc = await getDoc(doc(db, 'users', window.currentKPIEmployeeId));
            const employeeData = employeeDoc.data();
            const employeeEvaluators = employeeData.evaluators || [];
            
            // è¼‰å…¥è©²å“¡å·¥çš„æ‰€å±¬ä¸»ç®¡è³‡æ–™
            const evaluators = [];
            const usersSnapshot = await getDocs(collection(db, 'users'));
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // åªé¡¯ç¤ºè©²å“¡å·¥çš„æ‰€å±¬ä¸»ç®¡
                if (employeeEvaluators.includes(user.userId)) {
                    evaluators.push({ userId: user.userId, name: user.name });
                }
            });
            
            if (evaluators.length === 0) {
                container.innerHTML = '<p style="color: #f59e0b;">âš ï¸ è©²å“¡å·¥å°šæœªè¨­å®šæ‰€å±¬ä¸»ç®¡<br><small>è«‹å…ˆåœ¨ã€Œäººå“¡ç®¡ç†ã€ä¸­è¨­å®šè©²å“¡å·¥çš„æ‰€å±¬ä¸»ç®¡</small></p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            window.currentKPIItems.forEach((item, index) => {
                const assignedUsers = item.assignedUsers || [];
                const required = item.required || false;
                
                html += `
                    <div style="background: white; border: 2px solid #E3F2FD; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0; flex: 1;">é …ç›® ${index + 1}</h4>
                            <button class="btn btn-danger" onclick="window.removeKPIItem(${index})" style="padding: 5px 10px;">åˆªé™¤</button>
                        </div>
                        
                        <div class="form-group">
                            <label>é …ç›®åç¨±</label>
                            <input type="text" id="kpiItemName_${index}" value="${item.name || ''}" placeholder="ä¾‹å¦‚ï¼šæ¸…æ½”è¾¦å…¬å€åŸŸ" style="width: 100%;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>æª¢æ ¸é »ç‡</label>
                                <select id="kpiItemFreq_${index}" style="width: 100%;">
                                    <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>å‘¨æª¢æ ¸ (5æ¬¡/æœˆ)</option>
                                    <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>æœˆæª¢æ ¸ (1æ¬¡/æœˆ)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>å æ¯” (%)</label>
                                <input type="number" id="kpiItemWeight_${index}" value="${item.weight || 0}" min="0" max="100" step="0.1" style="width: 100%;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="kpiItemRequired_${index}" ${required ? 'checked' : ''}>
                                <strong>è¨­ç‚ºå¿…å¡«é …ç›®</strong>
                                <span style="color: #64748b; font-size: 0.9em;">ï¼ˆå‹¾é¸å¾Œï¼Œè©•åˆ†äººå“¡å¿…é ˆå¡«å¯«æ­¤é …ç›®æ‰èƒ½é€å‡ºï¼‰</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>æŒ‡å®šè©•åˆ†äººå“¡ï¼ˆä¸é¸å‰‡æ‰€æœ‰ä¸»ç®¡éƒ½å¯è©•æ ¸ï¼‰</label>
                            <div style="background: #f8fafc; border: 1px solid #cbd5e0; border-radius: 6px; padding: 10px; max-height: 150px; overflow-y: auto;">
                                ${evaluators.map(evaluator => `
                                    <label style="display: block; padding: 5px 0; cursor: pointer;">
                                        <input type="checkbox" 
                                               class="kpi-evaluator-checkbox" 
                                               data-item-index="${index}" 
                                               value="${evaluator.name}" 
                                               ${assignedUsers.includes(evaluator.name) ? 'checked' : ''}>
                                        ${evaluator.name} (${evaluator.userId})
                                    </label>
                                `).join('')}
                            </div>
                            <small style="color: #64748b;">è‹¥ä¸å‹¾é¸ä»»ä½•äººï¼Œå‰‡æ‰€æœ‰ä¸»ç®¡éƒ½å¯ä»¥è©•æ ¸æ­¤é …ç›®</small>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // é¡¯ç¤ºå æ¯”ç¸½å’Œ
            const totalWeight = window.currentKPIItems.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
            const weightColor = Math.abs(totalWeight - 100) < 0.01 ? '#059669' : '#dc2626';
            
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #F1F8FE; border-radius: 6px; text-align: right;">
                    <strong>å æ¯”ç¸½å’Œ: <span style="color: ${weightColor};">${totalWeight.toFixed(1)}%</span></strong>
                    ${Math.abs(totalWeight - 100) > 0.01 ? ' <span style="color: #dc2626;">âš ï¸ å»ºè­°ç‚º100%</span>' : ' <span style="color: #059669;">âœ“</span>'}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // æ–°å¢KPIæª¢æ ¸é …ç›®
        window.addKPIItem = function() {
            if (!window.currentKPIItems) {
                window.currentKPIItems = [];
            }
            
            window.currentKPIItems.push({
                name: '',
                frequency: 'weekly',
                weight: 0
            });
            
            renderKPIItems();
        };

        // åˆªé™¤KPIæª¢æ ¸é …ç›®
        window.removeKPIItem = function(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æª¢æ ¸é …ç›®å—ï¼Ÿ')) {
                return;
            }
            
            window.currentKPIItems.splice(index, 1);
            renderKPIItems();
        };

        // å„²å­˜KPIç¯„æœ¬
        window.saveKPITemplate = async function(employeeId) {
            // æ”¶é›†æ‰€æœ‰é …ç›®è³‡æ–™
            const items = [];
            
            for (let i = 0; i < window.currentKPIItems.length; i++) {
                const name = document.getElementById(`kpiItemName_${i}`).value.trim();
                const frequency = document.getElementById(`kpiItemFreq_${i}`).value;
                const weight = parseFloat(document.getElementById(`kpiItemWeight_${i}`).value);
                const required = document.getElementById(`kpiItemRequired_${i}`)?.checked || false;
                
                // æ”¶é›†æŒ‡å®šçš„è©•åˆ†äººå“¡
                const assignedUsers = [];
                const checkboxes = document.querySelectorAll(`.kpi-evaluator-checkbox[data-item-index="${i}"]:checked`);
                checkboxes.forEach(cb => {
                    assignedUsers.push(cb.value);
                });
                
                if (!name) {
                    alert(`é …ç›® ${i + 1} çš„åç¨±ä¸èƒ½ç‚ºç©º`);
                    return;
                }
                
                if (isNaN(weight) || weight < 0) {
                    alert(`é …ç›® ${i + 1} çš„å æ¯”å¿…é ˆå¤§æ–¼ç­‰æ–¼0`);
                    return;
                }
                
                items.push({
                    name: name,
                    frequency: frequency,
                    weight: weight,
                    required: required,
                    assignedUsers: assignedUsers
                });
            }
            
            if (items.length === 0) {
                alert('è‡³å°‘éœ€è¦ä¸€å€‹æª¢æ ¸é …ç›®');
                return;
            }
            
            // æª¢æŸ¥å æ¯”ç¸½å’Œ
            const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
            if (Math.abs(totalWeight - 100) > 0.01) {
                if (!confirm(`å æ¯”ç¸½å’Œç‚º ${totalWeight.toFixed(1)}%ï¼Œä¸æ˜¯100%\nç¢ºå®šè¦å„²å­˜å—ï¼Ÿ`)) {
                    return;
                }
            }
            
            try {
                await setDoc(doc(db, 'kpi_templates', employeeId), {
                    employeeId: employeeId,
                    items: items,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.userId
                });
                
                alert('KPIæª¢æ ¸ç¯„æœ¬å·²å„²å­˜ï¼');
                document.querySelector('.modal').remove();
                loadKPITemplates();
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        };

        // æ‰“é–‹KPIæª¢æ ¸è¡¨
        window.openKPIChecklist = async function(employeeId, period) {
            // å–å¾—å“¡å·¥è³‡æ–™
            const userDoc = await getDoc(doc(db, 'users', employeeId));
            if (!userDoc.exists()) {
                alert('æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™');
                return;
            }
            const userData = userDoc.data();
            
            // å–å¾—KPIç¯„æœ¬
            const templateDoc = await getDoc(doc(db, 'kpi_templates', employeeId));
            if (!templateDoc.exists()) {
                alert('æ­¤å“¡å·¥å°šæœªè¨­å®šKPIæª¢æ ¸é …ç›®ç¯„æœ¬\nè«‹å…ˆåˆ°ã€Œæª¢æ ¸é …ç›®è¨­å®šã€å»ºç«‹ç¯„æœ¬');
                return;
            }
            const template = templateDoc.data();
            
            // å–å¾—ç¾æœ‰æª¢æ ¸è³‡æ–™ï¼ˆä½¿ç”¨ç•¶å‰è©•åˆ†äººçš„IDï¼‰
            const checklistId = `kpi_${employeeId}_${period}_${currentUser.userId}`;
            const checklistDoc = await getDoc(doc(db, 'kpi_checklists', checklistId));
            const checklistData = checklistDoc.exists() ? checklistDoc.data() : null;
            
            const isSubmitted = checklistData?.status === 'submitted';
            const isReadOnly = isSubmitted;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>KPIæª¢æ ¸è¡¨ - ${userData.name}</h2>
                    <div style="background: #F1F8FE; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                            <div><strong>æœˆä»½:</strong> ${period.slice(0,4)}å¹´${period.slice(4)}æœˆ</div>
                            <div><strong>æª¢æ ¸äººå“¡:</strong> ${currentUser.name}</div>
                            <div><strong>ç‹€æ…‹:</strong> <span style="color: ${isSubmitted ? '#059669' : '#f59e0b'}; font-weight: bold;">${isSubmitted ? 'å·²é€å‡º' : 'ç·¨è¼¯ä¸­'}</span></div>
                        </div>
                    </div>
                    
                    ${isSubmitted ? '<div style="background: #dcfce7; border: 1px solid #059669; padding: 12px; border-radius: 6px; margin-bottom: 20px; color: #059669;"><strong>âœ“ æ­¤æª¢æ ¸è¡¨å·²é€å‡ºï¼Œç„¡æ³•å†ä¿®æ”¹</strong></div>' : ''}
                    
                    <div id="kpiChecklistItems"></div>
                    
                    ${!isSubmitted ? `
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="window.saveKPIChecklist('${employeeId}', '${period}', 'draft')">ğŸ’¾ æš«å­˜</button>
                        <button class="btn btn-primary" onclick="window.saveKPIChecklist('${employeeId}', '${period}', 'submitted')">ğŸ“¤ é€å‡º</button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å„²å­˜ç•¶å‰ç¯„æœ¬ä¾›å¾ŒçºŒä½¿ç”¨
            window.currentKPITemplate = template;
            
            // æ¸²æŸ“æª¢æ ¸é …ç›®
            renderKPIChecklistItems(template.items, checklistData?.results || {}, isReadOnly);
        };

        // æ¸²æŸ“KPIæª¢æ ¸é …ç›®
        function renderKPIChecklistItems(items, results, isReadOnly) {
            const container = document.getElementById('kpiChecklistItems');
            
            // éæ¿¾åªé¡¯ç¤ºç•¶å‰ç”¨æˆ¶è² è²¬çš„é …ç›®ï¼Œä½†ä¿ç•™åŸå§‹ç´¢å¼•
            const myItemsWithIndex = items.map((item, originalIndex) => ({ item, originalIndex }))
                .filter(({ item }) => {
                    if (!item.assignedUsers || item.assignedUsers.length === 0) {
                        return true; // æ²’æœ‰æŒ‡å®šè©•åˆ†äººå“¡ï¼Œæ‰€æœ‰äººéƒ½å¯è¦‹
                    }
                    return item.assignedUsers.includes(currentUser.name);
                });
            
            if (myItemsWithIndex.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">æ‚¨æ²’æœ‰éœ€è¦è©•æ ¸çš„é …ç›®</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse; background: white;">';
            html += '<thead><tr style="background: #1E88E5; color: white;">';
            html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: left; width: 25%;">æª¢æ ¸é …ç›®</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 10%;">é »ç‡</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 10%;">å æ¯”</th>';
            html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center;">æª¢æ ¸è¨˜éŒ„</th>';
            html += '</tr></thead><tbody>';
            
            myItemsWithIndex.forEach(({ item, originalIndex }) => {
                const slotCount = item.frequency === 'weekly' ? 5 : 1;
                const frequencyText = item.frequency === 'weekly' ? 'å‘¨æª¢æ ¸' : 'æœˆæª¢æ ¸';
                const requiredMark = item.required ? ' <span style="color: #ef4444;">*å¿…å¡«</span>' : '';
                
                html += `<tr>`;
                html += `<td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${item.name}${requiredMark}</td>`;
                html += `<td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${frequencyText}</td>`;
                html += `<td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.weight}%</td>`;
                html += `<td style="padding: 12px; border: 1px solid #ddd;">`;
                html += `<div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">`;
                
                for (let i = 0; i < slotCount; i++) {
                    // ä½¿ç”¨åŸå§‹ç´¢å¼•ä½œç‚ºkey
                    const slotKey = `item_${originalIndex}_slot_${i}`;
                    const value = results[slotKey] || '';
                    
                    html += `
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <small style="color: #64748b;">ç¬¬${i+1}${item.frequency === 'weekly' ? 'å‘¨' : 'æ¬¡'}</small>
                            <select id="${slotKey}" ${isReadOnly ? 'disabled' : ''} style="padding: 6px 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1em;">
                                <option value="">-</option>
                                <option value="V" ${value === 'V' ? 'selected' : ''}>âœ“ å®Œæˆ</option>
                                <option value="X" ${value === 'X' ? 'selected' : ''}>âœ— æœªå®Œæˆ</option>
                            </select>
                        </div>
                    `;
                }
                
                html += `</div></td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            
            html += `
                <div style="background: #fffbeb; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #f59e0b;">
                    <strong>è©•æ ¸èªªæ˜ï¼š</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        <li>æ¯å€‹é …ç›®è«‹æ¨™è¨˜æ˜¯å¦å®Œæˆ</li>
                        <li>âœ“ ä»£è¡¨å®Œæˆï¼Œâœ— ä»£è¡¨æœªå®Œæˆ</li>
                        <li>è«‹ç¢ºå¯¦å¡«å¯«æ¯å€‹æª¢æ ¸é»</li>
                        <li>ç©ºç™½æ ¼è¦–ç‚ºæœªå¡«å¯«</li>
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // æ›´æ–°KPIåˆ†æ•¸é è¦½
        window.updateKPIPreview = function() {
            // é‡æ–°è¨ˆç®—åˆ†æ•¸
            const items = window.currentKPITemplate?.items || [];
            const results = {};
            
            // æ”¶é›†æ‰€æœ‰ä¸‹æ‹‰é¸å–®çš„å€¼
            items.forEach((item, index) => {
                const slotCount = item.frequency === 'weekly' ? 5 : 1;
                for (let i = 0; i < slotCount; i++) {
                    const slotKey = `item_${index}_slot_${i}`;
                    const select = document.getElementById(slotKey);
                    if (select) {
                        results[slotKey] = select.value;
                    }
                }
            });
            
            updateKPIScorePreview(items, results);
        };

        // è¨ˆç®—ä¸¦é¡¯ç¤ºKPIåˆ†æ•¸é è¦½
        function updateKPIScorePreview(items, results) {
            // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
            window.currentKPITemplate = { items: items };
            
            const container = document.getElementById('kpiScorePreview');
            if (!container) return;
            
            let totalScore = 0;
            let detailsHtml = '<div style="display: grid; gap: 10px;">';
            
            items.forEach((item, index) => {
                const slotCount = item.frequency === 'weekly' ? 5 : 1;
                const slots = [];
                
                // æ”¶é›†è©²é …ç›®çš„æ‰€æœ‰æ ¼å­
                for (let i = 0; i < slotCount; i++) {
                    const slotKey = `item_${index}_slot_${i}`;
                    const value = results[slotKey] || '';
                    if (value) slots.push(value);
                }
                
                // è¨ˆç®—è©²é …ç›®åˆ†æ•¸ï¼ˆæ ¹æ“šExcelå…¬å¼ï¼‰
                let itemScore = 0;
                let itemScoreText = '-';
                
                if (slots.length > 0) {
                    // æª¢æŸ¥é€£çºŒå…©å€‹X
                    let hasConsecutiveX = false;
                    for (let i = 0; i < slots.length - 1; i++) {
                        if (slots[i] === 'X' && slots[i+1] === 'X') {
                            hasConsecutiveX = true;
                            break;
                        }
                    }
                    
                    if (hasConsecutiveX) {
                        // é€£çºŒå…©å€‹Xï¼Œæ­¤é …0åˆ†
                        itemScore = 0;
                        itemScoreText = '0% (é€£çºŒX)';
                    } else {
                        const vCount = slots.filter(s => s === 'V').length;
                        const xCount = slots.filter(s => s === 'X').length;
                        
                        if (vCount === slots.length) {
                            // å…¨éƒ¨Vï¼Œæ»¿åˆ†
                            itemScore = item.weight;
                            itemScoreText = `${item.weight}% (æ»¿åˆ†)`;
                        } else if (xCount > 0) {
                            // æœ‰Xä½†ä¸é€£çºŒï¼ŒæŒ‰æ¯”ä¾‹æ‰£åˆ†
                            itemScore = item.weight - (xCount / slots.length) * item.weight;
                            itemScoreText = `${itemScore.toFixed(1)}% (${slots.length}æ ¼ä¸­${xCount}å€‹X)`;
                        } else {
                            itemScore = item.weight;
                            itemScoreText = `${item.weight}%`;
                        }
                    }
                }
                
                totalScore += itemScore;
                
                detailsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                        <span>${item.name}</span>
                        <span style="font-weight: bold; color: ${itemScore === 0 ? '#dc2626' : '#059669'};">${itemScoreText}</span>
                    </div>
                `;
            });
            
            detailsHtml += '</div>';
            
            // è½‰æ›ç‚º5åˆ†åˆ¶
            const scoreOutOf5 = (totalScore / 100) * 5;
            
            container.innerHTML = `
                ${detailsHtml}
                <div style="margin-top: 15px; padding: 15px; background: #1E88E5; color: white; border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.9em; margin-bottom: 5px;">ç¸½åˆ†</div>
                    <div style="font-size: 2em; font-weight: bold;">${totalScore.toFixed(1)}%</div>
                    <div style="font-size: 1.2em; margin-top: 5px;">${scoreOutOf5.toFixed(2)} / 5.0 åˆ†</div>
                </div>
            `;
        }

        // å„²å­˜KPIæª¢æ ¸è¡¨
        window.saveKPIChecklist = async function(employeeId, period, status) {
            // é—œéµä¿®æ”¹ï¼šæ¯å€‹è©•åˆ†äººä½¿ç”¨ç¨ç«‹çš„æ–‡ä»¶IDï¼Œé¿å…äº’ç›¸è¦†è“‹
            const checklistId = `kpi_${employeeId}_${period}_${currentUser.userId}`;
            
            // æ”¶é›†æ‰€æœ‰é¸æ“‡çµæœ
            const items = window.currentKPITemplate?.items || [];
            const results = {};
            
            // åªè™•ç†ç•¶å‰ç”¨æˆ¶è² è²¬çš„é …ç›®ï¼Œä½†ä¿ç•™åŸå§‹ç´¢å¼•
            const myItemsWithIndex = items.map((item, originalIndex) => ({ item, originalIndex }))
                .filter(({ item }) => {
                    if (!item.assignedUsers || item.assignedUsers.length === 0) {
                        return true; // æ²’æœ‰æŒ‡å®šè©•åˆ†äººå“¡ï¼Œæ‰€æœ‰äººéƒ½å¯è¦‹
                    }
                    return item.assignedUsers.includes(currentUser.name);
                });
            
            myItemsWithIndex.forEach(({ item, originalIndex }) => {
                const slotCount = item.frequency === 'weekly' ? 5 : 1;
                for (let i = 0; i < slotCount; i++) {
                    const slotKey = `item_${originalIndex}_slot_${i}`;
                    const select = document.getElementById(slotKey);
                    if (select) {
                        results[slotKey] = select.value;
                    }
                }
            });
            
            // å¦‚æœè¦é€å‡ºï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å¿…å¡«é …ç›®
            if (status === 'submitted') {
                // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹é …ç›®æœ‰è©•åˆ†
                const hasAnyScore = Object.values(results).some(v => v !== '');
                if (!hasAnyScore) {
                    alert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æª¢æ ¸é …ç›®');
                    return;
                }
                
                // æª¢æŸ¥å¿…å¡«é …ç›®
                let missingRequired = false;
                myItemsWithIndex.forEach(({ item, originalIndex }) => {
                    if (item.required) {
                        const slotCount = item.frequency === 'weekly' ? 5 : 1;
                        let hasValue = false;
                        for (let i = 0; i < slotCount; i++) {
                            const slotKey = `item_${originalIndex}_slot_${i}`;
                            if (results[slotKey] && results[slotKey] !== '') {
                                hasValue = true;
                                break;
                            }
                        }
                        if (!hasValue) {
                            alert(`å¿…å¡«é …ç›®ã€Œ${item.name}ã€å°šæœªå¡«å¯«ï¼`);
                            missingRequired = true;
                        }
                    }
                });
                
                if (missingRequired) return;
                
                if (!confirm('ç¢ºå®šè¦é€å‡ºKPIæª¢æ ¸è¡¨å—ï¼Ÿ\né€å‡ºå¾Œå°‡ç„¡æ³•ä¿®æ”¹ï¼')) {
                    return;
                }
            }
            
            // è¨ˆç®—ç¸½åˆ†ï¼ˆåªè¨ˆç®—ç•¶å‰ç”¨æˆ¶è² è²¬çš„é …ç›®ï¼‰
            let totalScore = 0;
            myItemsWithIndex.forEach(({ item, originalIndex }) => {
                const slotCount = item.frequency === 'weekly' ? 5 : 1;
                const slots = [];
                
                for (let i = 0; i < slotCount; i++) {
                    const slotKey = `item_${originalIndex}_slot_${i}`;
                    const value = results[slotKey] || '';
                    if (value) slots.push(value);
                }
                
                if (slots.length > 0) {
                    let hasConsecutiveX = false;
                    for (let i = 0; i < slots.length - 1; i++) {
                        if (slots[i] === 'X' && slots[i+1] === 'X') {
                            hasConsecutiveX = true;
                            break;
                        }
                    }
                    
                    if (!hasConsecutiveX) {
                        const vCount = slots.filter(s => s === 'V').length;
                        const xCount = slots.filter(s => s === 'X').length;
                        
                        if (vCount === slots.length) {
                            totalScore += item.weight;
                        } else if (xCount > 0) {
                            totalScore += item.weight - (xCount / slots.length) * item.weight;
                        } else {
                            totalScore += item.weight;
                        }
                    }
                }
            });
            
            try {
                await setDoc(doc(db, 'kpi_checklists', checklistId), {
                    employeeId: employeeId,
                    period: period,
                    checkerId: currentUser.userId,
                    checkerName: currentUser.name,
                    results: results,
                    totalScore: totalScore,
                    itemsEvaluated: myItemsWithIndex.map(({ item }) => item.name), // è¨˜éŒ„è©•æ ¸äº†å“ªäº›é …ç›®
                    status: status,
                    savedAt: new Date().toISOString(),
                    submittedAt: status === 'submitted' ? new Date().toISOString() : null
                });
                
                alert(status === 'submitted' ? 'KPIæª¢æ ¸è¡¨å·²é€å‡ºï¼' : 'KPIæª¢æ ¸è¡¨å·²æš«å­˜ï¼');
                document.querySelector('.modal').remove();
                loadKPIChecklists();
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        };

        // è¼‰å…¥è©•åˆ†é€²åº¦è¿½è¹¤
        window.loadProgressTracking = async function() {
            const month = document.getElementById('progressMonth').value;
            if (!month) {
                return;
            }
            
            const period = month.replace('-', '');
            const container = document.getElementById('progressContainer');
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°progressContainerå…ƒç´ ï¼');
                return;
            }
            
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                // è¼‰å…¥æ‰€æœ‰éœ€è¦è©•æ ¸çš„å“¡å·¥
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const employees = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    
                    // æª¢æŸ¥è©²æœˆæ˜¯å¦éœ€è¦ä¸€èˆ¬è©•æ ¸
                    const needsNormalEval = checkNeedsEvaluationByFrequency(userData.evaluationFrequency || 'none', period);
                    
                    // æª¢æŸ¥æ˜¯å¦éœ€è¦KPIè©•æ ¸
                    const needsKPI = userData.needKPI || false;
                    
                    // åªæœ‰è©²æœˆéœ€è¦è©•æ ¸çš„å“¡å·¥æ‰é¡¯ç¤º
                    if (needsNormalEval || needsKPI) {
                        employees.push({
                            userId: doc.id,  // æ–‡ä»¶IDå°±æ˜¯userId
                            ...userData,     // å±•é–‹æ‰€æœ‰æ¬„ä½
                            needsNormalEval: needsNormalEval  // æ¨™è¨˜è©²æœˆæ˜¯å¦éœ€è¦ä¸€èˆ¬è©•æ ¸
                        });
                    }
                });
                
                if (employees.length === 0) {
                    container.innerHTML = '<p style="color: #a0aec0;">ç„¡éœ€è©•æ ¸äººå“¡</p>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #1E88E5; color: white;">';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">å“¡å·¥å§“å</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">è·ç­‰</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">è©•æ ¸é »ç‡</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">ä¸€èˆ¬è©•æ ¸</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">KPIè©•æ ¸</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd;">æœªé€å‡ºä¸»ç®¡</th>';
                html += '</tr></thead><tbody>';
                
                for (const employee of employees) {
                    
                    let normalStatus = 'ç„¡éœ€è©•æ ¸';
                    let kpiStatus = 'ç„¡éœ€è©•æ ¸';
                    let pendingSupervisors = [];
                    
                    // åªæœ‰è©²æœˆéœ€è¦ä¸€èˆ¬è©•æ ¸çš„å“¡å·¥æ‰æª¢æŸ¥ä¸€èˆ¬è©•æ ¸ç‹€æ…‹
                    if (employee.needsNormalEval) {
                        const templateId = `${employee.userId}_${period}`;
                        const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
                        
                        if (templateDoc.exists()) {
                            // æª¢æŸ¥æ‰€æœ‰ä¸»ç®¡æ˜¯å¦å·²é€å‡º
                            const evaluationsQuery = query(
                                collection(db, 'evaluations'),
                                where('evaluateeId', '==', employee.userId),
                                where('period', '==', period)
                            );
                            const evaluationsSnapshot = await getDocs(evaluationsQuery);
                            
                            const submittedEvaluators = evaluationsSnapshot.docs.map(doc => doc.data().evaluatorId);
                            pendingSupervisors = employee.evaluators.filter(ev => !submittedEvaluators.includes(ev));
                            
                            normalStatus = pendingSupervisors.length === 0 ? 
                                `<span style="color: #059669; font-weight: bold;">âœ“ å·²å®Œæˆ (${submittedEvaluators.length}/${employee.evaluators.length})</span>` :
                                `<span style="color: #dc2626; font-weight: bold;">âœ— æœªå®Œæˆ (${submittedEvaluators.length}/${employee.evaluators.length})</span>`;
                        }
                    }
                    
                    // æª¢æŸ¥KPIè©•æ ¸ç‹€æ…‹
                    if (employee.needKPI) {
                        // æŸ¥è©¢è©²å“¡å·¥æ‰€æœ‰è©•åˆ†äººçš„KPIè¨˜éŒ„
                        const kpiQuery = query(
                            collection(db, 'kpi_checklists'),
                            where('employeeId', '==', employee.userId),
                            where('period', '==', period),
                            where('status', '==', 'submitted')
                        );
                        const kpiSnapshot = await getDocs(kpiQuery);
                        
                        if (kpiSnapshot.size > 0) {
                            kpiStatus = `<span style="color: #059669; font-weight: bold;">âœ“ å·²é€å‡º (${kpiSnapshot.size}ç­†)</span>`;
                        } else {
                            // æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜ä¸­çš„
                            const kpiDraftQuery = query(
                                collection(db, 'kpi_checklists'),
                                where('employeeId', '==', employee.userId),
                                where('period', '==', period),
                                where('status', '==', 'draft')
                            );
                            const kpiDraftSnapshot = await getDocs(kpiDraftQuery);
                            
                            if (kpiDraftSnapshot.size > 0) {
                                kpiStatus = `<span style="color: #f59e0b; font-weight: bold;">â¸ æš«å­˜ä¸­ (${kpiDraftSnapshot.size}ç­†)</span>`;
                            } else {
                                kpiStatus = `<span style="color: #dc2626; font-weight: bold;">âœ— æœªå»ºç«‹</span>`;
                            }
                        }
                    }
                    
                    // å–å¾—ä¸»ç®¡å§“å
                    const pendingNames = [];
                    for (const supId of pendingSupervisors) {
                        const supDoc = await getDoc(doc(db, 'users', supId));
                        if (supDoc.exists()) {
                            pendingNames.push(supDoc.data().name);
                        }
                    }
                    
                    const pendingText = pendingNames.length > 0 ? pendingNames.join(', ') : '-';
                    const rowColor = (pendingSupervisors.length > 0 || (employee.needKPI && kpiStatus.includes('æœª'))) ? '#fff3cd' : 'white';
                    
                    // å®‰å…¨è™•ç†evaluationFrequency
                    let frequencyText = '-';
                    if (employee.evaluationFrequency === 'monthly') {
                        frequencyText = 'æ¯æœˆ';
                    } else if (employee.evaluationFrequency === 'quarterly') {
                        frequencyText = 'æ¯å­£';
                    }
                    
                    html += `<tr style="background: ${rowColor};">`;
                    html += `<td style="padding: 12px; border: 1px solid #ddd;">${employee.name || employee.userId}</td>`;
                    html += `<td style="padding: 12px; border: 1px solid #ddd;">${employee.level || '-'}</td>`;
                    html += `<td style="padding: 12px; border: 1px solid #ddd;">${frequencyText}</td>`;
                    html += `<td style="padding: 12px; border: 1px solid #ddd;">${normalStatus}</td>`;
                    html += `<td style="padding: 12px; border: 1px solid #ddd;">${kpiStatus}</td>`;
                    html += `<td style="padding: 12px; border: 1px solid #ddd;">${pendingText}</td>`;
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥è©•åˆ†é€²åº¦å¤±æ•—:', error);
                container.innerHTML = `<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>`;
            }
        };

        // æ¸²æŸ“ä½¿ç”¨è€…ç®¡ç†
        function renderUserManagement() {
            return `
                <h2>äººå“¡ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="window.showAddUserModal()">æ–°å¢äººå“¡</button>
                <div id="usersList" style="margin-top: 20px;">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            `;
        }

        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        async function loadUsersList() {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const usersListDiv = document.getElementById('usersList');
            
            // å»ºç«‹ä½¿ç”¨è€…å°ç…§è¡¨
            const usersMap = {};
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                usersMap[user.userId] = user.name;
            });
            
            let html = '<table><thead><tr><th>å¸³è™Ÿ</th><th>å§“å</th><th>è·ç­‰</th><th>é¡åˆ¥</th><th>è§’è‰²</th><th>æ‰€å±¬ä¸»ç®¡</th><th>æ“ä½œ</th></tr></thead><tbody>';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const roleText = user.role === 'admin' ? 'ç³»çµ±ç®¡ç†å“¡' : 
                                user.role === 'manager' ? 'ç®¡ç†è·ä¸»ç®¡' : 
                                user.role === 'staff' ? 'ä¸€èˆ¬ä¸»ç®¡' : 'ä¸€èˆ¬è·å“¡';
                const levelText = user.level || 'ç„¡';
                const categoryText = user.category === 'external' ? 'å¤–å‹¤' : 'å…§å‹¤';
                
                // å–å¾—æ‰€å±¬ä¸»ç®¡åç¨±
                let evaluatorsText = 'ç„¡';
                if (user.evaluators && user.evaluators.length > 0) {
                    evaluatorsText = user.evaluators.map(id => usersMap[id] || id).join(', ');
                }
                
                html += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.name}</td>
                        <td>${levelText}</td>
                        <td>${categoryText}</td>
                        <td>${roleText}</td>
                        <td>${evaluatorsText}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="window.editUser('${user.userId}')">ç·¨è¼¯</button>
                            ${user.userId !== 'Admin01' ? `<button class="btn btn-danger" onclick="window.deleteUser('${user.userId}')">åˆªé™¤</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            usersListDiv.innerHTML = html;
        }

        // åˆ‡æ›KPIè¨­å®šé¡¯ç¤º
        window.toggleKPISettings = function(checkbox, mode) {
            const settingsDiv = document.getElementById(mode + 'KPISettings');
            if (checkbox.checked) {
                settingsDiv.style.display = 'block';
            } else {
                settingsDiv.style.display = 'none';
            }
        };

        // é¡¯ç¤ºæ–°å¢ä½¿ç”¨è€…å°è©±æ¡†
        window.showAddUserModal = async function() {
            // è¼‰å…¥æ‰€æœ‰ä¸»ç®¡åˆ—è¡¨
            const usersSnapshot = await getDocs(collection(db, 'users'));
            let managersOptions = '';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                if (user.role === 'manager' || user.role === 'staff') {
                    managersOptions += `<option value="${user.userId}">${user.name} (${user.userId})</option>`;
                }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>æ–°å¢äººå“¡</h2>
                    <div id="addUserMessage"></div>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label>å¸³è™Ÿ (è‹±æ–‡æˆ–æ•¸å­—)</label>
                            <input type="text" id="newUserId" required>
                        </div>
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" id="newUserName" required>
                        </div>
                        <div class="form-group">
                            <label>å¯†ç¢¼</label>
                            <input type="password" id="newUserPassword" required>
                        </div>
                        <div class="form-group">
                            <label>è·ç­‰</label>
                            <select id="newUserLevel">
                                <option value="">ç„¡è·ç­‰</option>
                                <option value="L1">L1</option>
                                <option value="L2">L2</option>
                                <option value="L3">L3</option>
                                <option value="L4">L4</option>
                                <option value="L5">L5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡åˆ¥</label>
                            <select id="newUserCategory" required>
                                <option value="internal">å…§å‹¤</option>
                                <option value="external">å¤–å‹¤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²</label>
                            <select id="newUserRole" required>
                                <option value="employee">ä¸€èˆ¬è·å“¡ (ç„¡æ³•ç™»å…¥ç³»çµ±)</option>
                                <option value="staff">ä¸€èˆ¬ä¸»ç®¡ (å¯è©•åˆ†)</option>
                                <option value="manager">ç®¡ç†è·ä¸»ç®¡ (å¯è©•åˆ†+å¯æŸ¥çœ‹å¾Œå°)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±¬ä¸»ç®¡ (å¯è¤‡é¸,æŒ‰ä½ Ctrl æˆ– Command éµå¤šé¸)</label>
                            <select id="newUserEvaluators" multiple size="6" style="height: auto;">
                                ${managersOptions}
                            </select>
                            <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                å¦‚æœæ­¤äººå“¡éœ€è¦æ¥å—è©•æ ¸,è«‹é¸æ“‡è©•æ ¸ä¸»ç®¡<br>
                                æŒ‰ä½ Ctrl (Windows) æˆ– Command (Mac) å¯å¤šé¸
                            </small>
                        </div>
                        <div class="form-group">
                            <label>ä¸€èˆ¬è©•æ ¸é »ç‡</label>
                            <select id="newUserEvalFrequency" required>
                                <option value="none">ä¸éœ€è©•æ ¸</option>
                                <option value="monthly">æ¯æœˆè©•æ ¸</option>
                                <option value="quarterly">æ¯å­£è©•æ ¸ (3, 5, 9, 12æœˆ)</option>
                            </select>
                            <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                è¨­å®šè®Šæ›´å°‡æ–¼æ¬¡æœˆç”Ÿæ•ˆ
                            </small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="newUserNeedKPI" onchange="window.toggleKPISettings(this, 'new')">
                                éœ€è¦KPIè©•æ ¸ï¼ˆæ¯æœˆï¼‰
                            </label>
                        </div>
                        <div id="newKPISettings" style="display: none; background: #F1F8FE; padding: 15px; border-radius: 5px; margin-top: 10px;">
                            <div class="form-group">
                                <label>KPIåˆ†æ•¸å›å¡«åˆ°è€ƒæ ¸è¡¨æ¬„ä½</label>
                                <input type="text" id="newUserKPIField" placeholder="ä¾‹å¦‚: flat_2_0 (ç¬¬3å¤§é …ç¬¬1å°é …)">
                                <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                    æ ¼å¼èªªæ˜ï¼šflat_å¤§é …ç´¢å¼•_å°é …ç´¢å¼•<br>
                                    ä¾‹å¦‚ï¼šflat_2_0 è¡¨ç¤ºç¬¬3å€‹å¤§é …çš„ç¬¬1å€‹å°é …ï¼ˆç´¢å¼•å¾0é–‹å§‹ï¼‰
                                </small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">æ–°å¢</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userId = document.getElementById('newUserId').value;
                const name = document.getElementById('newUserName').value;
                const password = document.getElementById('newUserPassword').value;
                const level = document.getElementById('newUserLevel').value;
                const category = document.getElementById('newUserCategory').value;
                const role = document.getElementById('newUserRole').value;
                const evalFrequency = document.getElementById('newUserEvalFrequency').value;
                const needKPI = document.getElementById('newUserNeedKPI').checked;
                const kpiField = document.getElementById('newUserKPIField').value;
                
                // å–å¾—æ‰€é¸çš„ä¸»ç®¡
                const evaluatorsSelect = document.getElementById('newUserEvaluators');
                const evaluators = Array.from(evaluatorsSelect.selectedOptions).map(option => option.value);
                
                // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å·²å­˜åœ¨
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    showMessage('addUserMessage', 'å¸³è™Ÿå·²å­˜åœ¨', 'error');
                    return;
                }
                
                // æº–å‚™ä½¿ç”¨è€…è³‡æ–™
                const userData = {
                    userId: userId,
                    name: name,
                    password: password,
                    level: level || 'L5',
                    category: category,
                    role: role,
                    evaluators: evaluators,
                    evaluationFrequency: evalFrequency,
                    needKPI: needKPI,
                    kpiSettings: needKPI ? {
                        enabled: true,
                        targetField: kpiField
                    } : null
                };
                
                await setDoc(doc(db, 'users', userId), userData);
                
                alert('äººå“¡æ–°å¢æˆåŠŸ!');
                modal.remove();
                loadUsersList();
            });
        };

        // æ¸²æŸ“KPIæª¢æ ¸ç®¡ç†
        function renderKPIManagement() {
            return `
                <h2>KPIæª¢æ ¸ç®¡ç†</h2>
                <div class="tabs" style="margin-bottom: 20px;">
                    <button class="tab active" onclick="window.switchKPITab(0)">æª¢æ ¸è¡¨å¡«å¯«</button>
                    <button class="tab" onclick="window.switchKPITab(1)">æª¢æ ¸é …ç›®è¨­å®š</button>
                </div>
                
                <div id="kpiTab0" class="tab-content active">
                    <h3>æœ¬æœˆKPIæª¢æ ¸è¡¨</h3>
                    <div id="kpiChecklistContainer">
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
                
                <div id="kpiTab1" class="tab-content">
                    <h3>è¨­å®šæª¢æ ¸é …ç›®ç¯„æœ¬</h3>
                    <div id="kpiTemplateContainer">
                        <p style="color: #a0aec0;">é¸æ“‡éœ€è¦KPIæª¢æ ¸çš„å“¡å·¥ä¸¦è¨­å®šæª¢æ ¸é …ç›®</p>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“è©•åˆ†é€²åº¦è¿½è¹¤
        function renderProgressTracking() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return `
                <h2>è©•åˆ†é€²åº¦è¿½è¹¤</h2>
                
                <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                    <label>é¸æ“‡æœˆä»½</label>
                    <input type="month" id="progressMonth" value="${currentMonth}" onchange="window.loadProgressTracking(); window.loadMonthLockStatus();">
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #856404; margin-bottom: 10px;">ğŸ”’ æœˆä»½é–å–®è¨­å®š</h3>
                    <p style="color: #856404; margin-bottom: 10px;">é–å®šå¾Œï¼Œè©²æœˆä»½çš„æ‰€æœ‰ä¸»ç®¡å°‡ç„¡æ³•ç¹¼çºŒè©•åˆ†ï¼ˆå·²é€å‡ºçš„ä¸å—å½±éŸ¿ï¼‰</p>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="monthLockToggle" onchange="window.toggleMonthLock(this)" style="width: 20px; height: 20px;">
                            <span style="font-weight: bold;">é–å®šæ‰€é¸æœˆä»½</span>
                        </label>
                        <span id="monthLockStatus" style="color: #059669; font-weight: bold;">ç›®å‰ç‹€æ…‹ï¼šé–‹æ”¾è©•åˆ†</span>
                        <span id="monthLockInfo" style="color: #6b7280; font-size: 0.9em;"></span>
                    </div>
                </div>
                
                <div id="progressContainer">
                    <div class="loading">è«‹é¸æ“‡æœˆä»½ä»¥æŸ¥çœ‹é€²åº¦</div>
                </div>
            `;
        }

        // æ¸²æŸ“è©•åˆ†è¡¨ç·¨è¼¯å™¨
        function renderTemplateEditor() {
            const isAdmin = currentUser.role === 'admin';
            const modeText = isAdmin ? 'ç·¨è¼¯' : 'æŸ¥çœ‹';
            
            return `
                <h2>${modeText}å“¡å·¥è€ƒæ ¸è¡¨</h2>
                ${!isAdmin ? '<p style="color: #ed8936; background: #fffaf0; padding: 10px; border-radius: 5px; margin-bottom: 20px;">âš ï¸ æ‚¨åªæœ‰æŸ¥çœ‹æ¬Šé™,ç„¡æ³•ç·¨è¼¯è€ƒæ ¸è¡¨ç¯„æœ¬</p>' : ''}
                <div class="form-group">
                    <label>é¸æ“‡å“¡å·¥</label>
                    <select id="templateEmployee" onchange="window.loadTemplate()">
                        <option value="">è«‹é¸æ“‡å“¡å·¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¸æ“‡æœˆä»½</label>
                    <input type="month" id="templateMonth" onchange="window.loadTemplate()">
                </div>
                ${isAdmin ? `
                <div style="margin-bottom: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="window.copyPreviousMonthTemplate()">ğŸ“‹ è¤‡è£½ä¸Šæœˆç¯„æœ¬</button>
                    <button type="button" class="btn btn-danger" onclick="window.clearTemplate()">ğŸ—‘ï¸ æ¸…ç©ºç¯„æœ¬</button>
                </div>
                ` : ''}
                <div id="templateEditor">
                    <p style="color: #a0aec0;">è«‹é¸æ“‡å“¡å·¥å’Œæœˆä»½</p>
                </div>
            `;
        }

        // è¼‰å…¥è©•åˆ†è¡¨ç¯„æœ¬å“¡å·¥åˆ—è¡¨
        async function loadTemplateEmployees() {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const select = document.getElementById('templateEmployee');
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            select.innerHTML = '<option value="">è«‹é¸æ“‡å“¡å·¥</option>';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // åªé¡¯ç¤ºéœ€è¦è©•æ ¸çš„å“¡å·¥(æœ‰è·ç­‰ä¸”ä¸æ˜¯L5)
                if (user.level && user.level !== 'L5' && user.level !== '') {
                    const option = document.createElement('option');
                    option.value = user.userId;
                    option.textContent = `${user.name} (${user.userId}) - ${user.level}`;
                    select.appendChild(option);
                }
            });
        }

        // è¼‰å…¥è©•åˆ†è¡¨ç¯„æœ¬
        window.loadTemplate = async function() {
            const employeeId = document.getElementById('templateEmployee').value;
            const month = document.getElementById('templateMonth').value;
            
            if (!employeeId || !month) {
                return;
            }
            
            // å–å¾—å“¡å·¥è³‡è¨Š(åŒ…å«è·ç­‰)
            const employeeDoc = await getDoc(doc(db, 'users', employeeId));
            if (!employeeDoc.exists()) {
                alert('æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™');
                return;
            }
            
            const employeeData = employeeDoc.data();
            const employeeLevel = employeeData.level || '';
            
            const period = month.replace('-', '');
            const templateId = `${employeeId}_${period}`;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è©•åˆ†è¨˜éŒ„
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period)
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            const hasEvaluations = !evaluationsSnapshot.empty;
            
            // å¦‚æœæœ‰è©•åˆ†è¨˜éŒ„,é¡¯ç¤ºè­¦å‘Š
            let evaluationWarning = '';
            if (hasEvaluations) {
                const evaluatorsList = [];
                evaluationsSnapshot.forEach(doc => {
                    const evaluation = doc.data();
                    evaluatorsList.push({
                        evaluatorId: evaluation.evaluatorId,
                        status: evaluation.status
                    });
                });
                
                // å–å¾—ä¸»ç®¡åç¨±
                const evaluatorNames = [];
                for (const ev of evaluatorsList) {
                    const userDoc = await getDoc(doc(db, 'users', ev.evaluatorId));
                    if (userDoc.exists()) {
                        const statusText = ev.status === 'submitted' ? 'å·²é€å‡º' : 'è‰ç¨¿';
                        evaluatorNames.push(`${userDoc.data().name} (${statusText})`);
                    }
                }
                
                evaluationWarning = `
                    <div style="background: #fff5f5; border: 2px solid #f56565; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #c53030; margin-bottom: 10px;">âš ï¸ ç¯„æœ¬å·²é–å®š</h3>
                        <p style="color: #742a2a; margin-bottom: 10px;">
                            <strong>åŸå› :</strong> ä»¥ä¸‹ä¸»ç®¡å·²é–‹å§‹è©•åˆ†,ç‚ºé¿å…è³‡æ–™éŒ¯èª¤,ç¯„æœ¬å·²é–å®šç„¡æ³•ç·¨è¼¯:
                        </p>
                        <ul style="color: #742a2a; margin-left: 20px;">
                            ${evaluatorNames.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                        <p style="color: #742a2a; margin-top: 10px;">
                            è‹¥éœ€ä¿®æ”¹ç¯„æœ¬,è«‹å…ˆä½¿ç”¨ã€Œé€€å–®ã€åŠŸèƒ½æ¸…ç©ºæ‰€æœ‰è©•åˆ†è¨˜éŒ„ã€‚
                        </p>
                        ${currentUser.role === 'admin' ? `
                        <button type="button" class="btn btn-danger" onclick="window.forceUnlockTemplate('${employeeId}', '${period}')" style="margin-top: 10px;">
                            ğŸ”“ å¼·åˆ¶è§£é– (æœƒæ¸…ç©ºæ‰€æœ‰è©•åˆ†è¨˜éŒ„)
                        </button>
                        ` : ''}
                    </div>
                `;
            }
            
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
            
            if (templateDoc.exists()) {
                // è¼‰å…¥ç¾æœ‰ç¯„æœ¬
                const template = templateDoc.data();
                renderTemplateForm(template, employeeId, period, employeeLevel, hasEvaluations, evaluationWarning);
            } else {
                // å»ºç«‹æ–°ç¯„æœ¬ - æ ¹æ“šè·ç­‰æ±ºå®šåˆå§‹çµæ§‹
                const initialTemplate = (employeeLevel === 'L3' || employeeLevel === 'L4') ? {
                    categories: [], // L3ã€L4 ä½¿ç”¨æ‰å¹³åŒ–çµæ§‹
                    templateType: 'flat'
                } : {
                    workPerformance: [],
                    comprehensivePerformance: [],
                    personalLearning: { weight: 0, items: [] },
                    templateType: 'structured'
                };
                
                renderTemplateForm(initialTemplate, employeeId, period, employeeLevel, hasEvaluations, evaluationWarning);
            }
        };

        // å¼·åˆ¶è§£é–ç¯„æœ¬
        window.forceUnlockTemplate = async function(employeeId, period) {
            if (!confirm('âš ï¸ è­¦å‘Š!\n\nå¼·åˆ¶è§£é–æœƒåˆªé™¤æ‰€æœ‰ä¸»ç®¡å°æ­¤å“¡å·¥æœ¬æœˆçš„è©•åˆ†è¨˜éŒ„!\n\né€™å€‹å‹•ä½œç„¡æ³•å¾©åŸ,ç¢ºå®šè¦ç¹¼çºŒå—?')) {
                return;
            }
            
            if (!confirm('å†æ¬¡ç¢ºèª:\n\næ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è©•åˆ†è¨˜éŒ„ä¸¦è§£é–ç¯„æœ¬å—?')) {
                return;
            }
            
            // åˆªé™¤æ‰€æœ‰è©•åˆ†è¨˜éŒ„
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period)
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            for (const evalDoc of evaluationsSnapshot.docs) {
                await deleteDoc(doc(db, 'evaluations', evalDoc.id));
            }
            
            alert('å·²æ¸…ç©ºæ‰€æœ‰è©•åˆ†è¨˜éŒ„,ç¯„æœ¬å·²è§£é–!');
            window.loadTemplate();
        };

        // æ¸²æŸ“ç¯„æœ¬ç·¨è¼¯è¡¨å–®
        function renderTemplateForm(template, employeeId, period, employeeLevel, isLocked = false, lockWarning = '') {
            const editorDiv = document.getElementById('templateEditor');
            const isAdmin = currentUser.role === 'admin';
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            // åˆ¤æ–·ç¯„æœ¬é¡å‹
            const isFlat = (employeeLevel === 'L3' || employeeLevel === 'L4') || template.templateType === 'flat';
            
            // å„²å­˜ç•¶å‰ç¯„æœ¬åˆ°å…¨åŸŸè®Šæ•¸
            window.currentTemplate = template;
            window.currentTemplateLocked = isLocked;
            window.currentTemplateType = isFlat ? 'flat' : 'structured';
            window.currentEmployeeLevel = employeeLevel;
            
            if (isFlat) {
                // L3ã€L4 æ‰å¹³åŒ–çµæ§‹
                editorDiv.innerHTML = `
                    ${lockWarning}
                    <div style="background: #e6f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1890ff;">
                        <strong>ğŸ“‹ ${employeeLevel} è·ç­‰ç¯„æœ¬</strong> - æ‰å¹³åŒ–çµæ§‹(å¤§é … â†’ å°é …)
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h3>è©•åˆ†å¤§é …</h3>
                        <div id="flatCategories"></div>
                        ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addFlatCategory()">æ–°å¢å¤§é …</button>' : ''}
                        
                        ${canEdit ? `
                        <div style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-success" onclick="window.saveTemplate('${employeeId}', '${period}')">å„²å­˜ç¯„æœ¬</button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // ç¢ºä¿æœ‰ categories å±¬æ€§
                if (!window.currentTemplate.categories) {
                    window.currentTemplate.categories = [];
                }
                
                renderFlatCategories();
            } else {
                // L1ã€L2 çµæ§‹åŒ–(ä¸‰å€å¡Š)
                editorDiv.innerHTML = `
                    ${lockWarning}
                    <div style="background: #e6f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1890ff;">
                        <strong>ğŸ“‹ ${employeeLevel} è·ç­‰ç¯„æœ¬</strong> - çµæ§‹åŒ–(å·¥ä½œè¡¨ç¾ + ç¶œåˆè¡¨ç¾ + å€‹äººå­¸ç¿’)
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h3>å·¥ä½œè¡¨ç¾</h3>
                        <div id="workPerformanceCategories"></div>
                        ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addWorkCategory()">æ–°å¢å¤§é¡</button>' : ''}
                        
                        <h3 style="margin-top: 30px;">ç¶œåˆè¡¨ç¾</h3>
                        <div id="comprehensivePerformanceCategories"></div>
                        ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addCompCategory()">æ–°å¢å¤§é¡</button>' : ''}
                        
                        <h3 style="margin-top: 30px;">å€‹äººå­¸ç¿’</h3>
                        <div class="form-group">
                            <label>ä½”æ¯” (%)</label>
                            <input type="number" id="learningWeight" value="${template.personalLearning?.weight || 0}" min="0" max="100" ${disabled}>
                        </div>
                        <div id="learningItems"></div>
                        ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addLearningItem()">æ–°å¢å­¸ç¿’é …ç›®</button>' : ''}
                        
                        ${canEdit ? `
                        <div style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-success" onclick="window.saveTemplate('${employeeId}', '${period}')">å„²å­˜ç¯„æœ¬</button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // ç¢ºä¿æœ‰å¿…è¦å±¬æ€§
                if (!window.currentTemplate.workPerformance) window.currentTemplate.workPerformance = [];
                if (!window.currentTemplate.comprehensivePerformance) window.currentTemplate.comprehensivePerformance = [];
                if (!window.currentTemplate.personalLearning) window.currentTemplate.personalLearning = { weight: 0, items: [] };
                
                renderWorkCategories();
                renderCompCategories();
                renderLearningItems();
            }
        }

        // æ¸²æŸ“å·¥ä½œè¡¨ç¾å¤§é¡
        function renderWorkCategories() {
            const container = document.getElementById('workPerformanceCategories');
            const categories = window.currentTemplate.workPerformance || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            categories.forEach((cat, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" value="${cat.name}" onchange="window.updateWorkCategoryName(${index}, this.value)" 
                                   style="flex: 1; margin-right: 10px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            <input type="number" value="${cat.weight}" onchange="window.updateWorkCategoryWeight(${index}, this.value)" 
                                   placeholder="ä½”æ¯”%" min="0" max="100" style="width: 80px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeWorkCategory(${index})" style="margin-left: 10px;">åˆªé™¤å¤§é¡</button>` : ''}
                        </div>
                        <div>
                            ${cat.items.map((item, itemIndex) => `
                                <div style="display: flex; margin-bottom: 5px;">
                                    <textarea onchange="window.updateWorkItem(${index}, ${itemIndex}, this.value)"
                                           style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                                    ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeWorkItem(${index}, ${itemIndex})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                                </div>
                            `).join('')}
                            ${canEdit ? `<button type="button" class="btn btn-secondary" onclick="window.addWorkItem(${index})">æ–°å¢å°é …</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“ç¶œåˆè¡¨ç¾å¤§é¡
        function renderCompCategories() {
            const container = document.getElementById('comprehensivePerformanceCategories');
            const categories = window.currentTemplate.comprehensivePerformance || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            categories.forEach((cat, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" value="${cat.name}" onchange="window.updateCompCategoryName(${index}, this.value)" 
                                   style="flex: 1; margin-right: 10px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            <input type="number" value="${cat.weight}" onchange="window.updateCompCategoryWeight(${index}, this.value)" 
                                   placeholder="ä½”æ¯”%" min="0" max="100" style="width: 80px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeCompCategory(${index})" style="margin-left: 10px;">åˆªé™¤å¤§é¡</button>` : ''}
                        </div>
                        <div>
                            ${cat.items.map((item, itemIndex) => `
                                <div style="display: flex; margin-bottom: 5px;">
                                    <textarea onchange="window.updateCompItem(${index}, ${itemIndex}, this.value)"
                                           style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                                    ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeCompItem(${index}, ${itemIndex})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                                </div>
                            `).join('')}
                            ${canEdit ? `<button type="button" class="btn btn-secondary" onclick="window.addCompItem(${index})">æ–°å¢å°é …</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“å€‹äººå­¸ç¿’é …ç›®
        function renderLearningItems() {
            const container = document.getElementById('learningItems');
            const items = window.currentTemplate.personalLearning.items || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            items.forEach((item, index) => {
                html += `
                    <div style="display: flex; margin-bottom: 10px;">
                        <textarea onchange="window.updateLearningItem(${index}, this.value)"
                               style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                        ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeLearningItem(${index})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== L3ã€L4 æ‰å¹³åŒ–å¤§é …ç®¡ç† ==========
        
        // æ¸²æŸ“æ‰å¹³åŒ–å¤§é …
        function renderFlatCategories() {
            const container = document.getElementById('flatCategories');
            if (!container) return;
            
            const categories = window.currentTemplate.categories || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            categories.forEach((cat, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #1E88E5;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" value="${cat.name}" onchange="window.updateFlatCategoryName(${index}, this.value)" 
                                   placeholder="å¤§é …åç¨±" style="flex: 1; margin-right: 10px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            <input type="number" value="${cat.weight}" onchange="window.updateFlatCategoryWeight(${index}, this.value)" 
                                   placeholder="ä½”æ¯”%" min="0" max="200" style="width: 100px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeFlatCategory(${index})" style="margin-left: 10px;">åˆªé™¤å¤§é …</button>` : ''}
                        </div>
                        <div style="margin-top: 10px;">
                            <strong style="color: #4a5568; font-size: 0.9em;">å°é …:</strong>
                        </div>
                        <div>
                            ${cat.items.map((item, itemIndex) => `
                                <div style="display: flex; margin-bottom: 5px; margin-top: 5px;">
                                    <textarea onchange="window.updateFlatItem(${index}, ${itemIndex}, this.value)"
                                           style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                                    ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeFlatItem(${index}, ${itemIndex})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                                </div>
                            `).join('')}
                            ${canEdit ? `<button type="button" class="btn btn-secondary" onclick="window.addFlatItem(${index})" style="margin-top: 5px;">æ–°å¢å°é …</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ–°å¢æ‰å¹³åŒ–å¤§é …
        window.addFlatCategory = function() {
            if (!window.currentTemplate.categories) {
                window.currentTemplate.categories = [];
            }
            window.currentTemplate.categories.push({
                name: '',
                weight: 0,
                items: []
            });
            renderFlatCategories();
        };
        
        // åˆªé™¤æ‰å¹³åŒ–å¤§é …
        window.removeFlatCategory = function(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é …å—?')) {
                window.currentTemplate.categories.splice(index, 1);
                renderFlatCategories();
            }
        };
        
        // æ›´æ–°æ‰å¹³åŒ–å¤§é …åç¨±
        window.updateFlatCategoryName = function(index, value) {
            window.currentTemplate.categories[index].name = value;
        };
        
        // æ›´æ–°æ‰å¹³åŒ–å¤§é …ä½”æ¯”
        window.updateFlatCategoryWeight = function(index, value) {
            window.currentTemplate.categories[index].weight = parseFloat(value) || 0;
        };
        
        // æ–°å¢æ‰å¹³åŒ–å°é …
        window.addFlatItem = function(catIndex) {
            window.currentTemplate.categories[catIndex].items.push('');
            renderFlatCategories();
        };
        
        // åˆªé™¤æ‰å¹³åŒ–å°é …
        window.removeFlatItem = function(catIndex, itemIndex) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°é …å—?')) {
                window.currentTemplate.categories[catIndex].items.splice(itemIndex, 1);
                renderFlatCategories();
            }
        };
        
        // æ›´æ–°æ‰å¹³åŒ–å°é …
        window.updateFlatItem = function(catIndex, itemIndex, value) {
            window.currentTemplate.categories[catIndex].items[itemIndex] = value;
        };

        // å·¥ä½œè¡¨ç¾ç›¸é—œå‡½æ•¸
        window.addWorkCategory = function() {
            if (!window.currentTemplate.workPerformance) {
                window.currentTemplate.workPerformance = [];
            }
            window.currentTemplate.workPerformance.push({ name: 'æ–°å¤§é¡', weight: 0, items: [] });
            renderWorkCategories();
        };

        window.removeWorkCategory = function(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é¡å—?')) {
                window.currentTemplate.workPerformance.splice(index, 1);
                renderWorkCategories();
            }
        };

        window.updateWorkCategoryName = function(index, value) {
            window.currentTemplate.workPerformance[index].name = value;
        };

        window.updateWorkCategoryWeight = function(index, value) {
            window.currentTemplate.workPerformance[index].weight = parseFloat(value) || 0;
        };

        window.addWorkItem = function(catIndex) {
            window.currentTemplate.workPerformance[catIndex].items.push('æ–°å°é …');
            renderWorkCategories();
        };

        window.removeWorkItem = function(catIndex, itemIndex) {
            window.currentTemplate.workPerformance[catIndex].items.splice(itemIndex, 1);
            renderWorkCategories();
        };

        window.updateWorkItem = function(catIndex, itemIndex, value) {
            window.currentTemplate.workPerformance[catIndex].items[itemIndex] = value;
        };

        // ç¶œåˆè¡¨ç¾ç›¸é—œå‡½æ•¸
        window.addCompCategory = function() {
            if (!window.currentTemplate.comprehensivePerformance) {
                window.currentTemplate.comprehensivePerformance = [];
            }
            window.currentTemplate.comprehensivePerformance.push({ name: 'æ–°å¤§é¡', weight: 0, items: [] });
            renderCompCategories();
        };

        window.removeCompCategory = function(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é¡å—?')) {
                window.currentTemplate.comprehensivePerformance.splice(index, 1);
                renderCompCategories();
            }
        };

        window.updateCompCategoryName = function(index, value) {
            window.currentTemplate.comprehensivePerformance[index].name = value;
        };

        window.updateCompCategoryWeight = function(index, value) {
            window.currentTemplate.comprehensivePerformance[index].weight = parseFloat(value) || 0;
        };

        window.addCompItem = function(catIndex) {
            window.currentTemplate.comprehensivePerformance[catIndex].items.push('æ–°å°é …');
            renderCompCategories();
        };

        window.removeCompItem = function(catIndex, itemIndex) {
            window.currentTemplate.comprehensivePerformance[catIndex].items.splice(itemIndex, 1);
            renderCompCategories();
        };

        window.updateCompItem = function(catIndex, itemIndex, value) {
            window.currentTemplate.comprehensivePerformance[catIndex].items[itemIndex] = value;
        };

        // å€‹äººå­¸ç¿’ç›¸é—œå‡½æ•¸
        window.addLearningItem = function() {
            if (!window.currentTemplate.personalLearning) {
                window.currentTemplate.personalLearning = { weight: 0, items: [] };
            }
            window.currentTemplate.personalLearning.items.push('æ–°å­¸ç¿’é …ç›®');
            renderLearningItems();
        };

        window.removeLearningItem = function(index) {
            window.currentTemplate.personalLearning.items.splice(index, 1);
            renderLearningItems();
        };

        window.updateLearningItem = function(index, value) {
            window.currentTemplate.personalLearning.items[index] = value;
        };

        // å„²å­˜ç¯„æœ¬
        window.saveTemplate = async function(employeeId, period) {
            const templateType = window.currentTemplateType;
            let totalWeight = 0;
            
            if (templateType === 'flat') {
                // L3ã€L4 æ‰å¹³åŒ–çµæ§‹
                if (window.currentTemplate.categories) {
                    window.currentTemplate.categories.forEach(cat => {
                        totalWeight += parseFloat(cat.weight) || 0;
                    });
                }
            } else {
                // L1ã€L2 çµæ§‹åŒ–
                const learningWeight = parseFloat(document.getElementById('learningWeight').value) || 0;
                window.currentTemplate.personalLearning.weight = learningWeight;
                
                // å·¥ä½œè¡¨ç¾ä½”æ¯”
                if (window.currentTemplate.workPerformance) {
                    window.currentTemplate.workPerformance.forEach(cat => {
                        totalWeight += parseFloat(cat.weight) || 0;
                    });
                }
                
                // ç¶œåˆè¡¨ç¾ä½”æ¯”
                if (window.currentTemplate.comprehensivePerformance) {
                    window.currentTemplate.comprehensivePerformance.forEach(cat => {
                        totalWeight += parseFloat(cat.weight) || 0;
                    });
                }
                
                // å€‹äººå­¸ç¿’ä½”æ¯”
                totalWeight += learningWeight;
            }
            
            // æª¢æŸ¥ä½”æ¯”ç¸½å’Œ - åªè­¦å‘Šä¸é˜»æ­¢
            if (Math.abs(totalWeight - 100) > 0.01) {
                const diff = totalWeight - 100;
                const message = diff > 0 
                    ? `âš ï¸ æé†’ï¼šä½”æ¯”ç¸½å’Œè¶…é 100%\n\nç›®å‰ç¸½å’Œ: ${totalWeight.toFixed(1)}%\nè¶…é: ${diff.toFixed(1)}%\n\n${window.currentEmployeeLevel === 'L4' ? '(L4 å…è¨±å¤–åŠ çµ¦åˆ†)' : ''}\n\nç¢ºå®šè¦å„²å­˜å—?`
                    : `âš ï¸ æé†’ï¼šä½”æ¯”ç¸½å’Œä¸è¶³ 100%\n\nç›®å‰ç¸½å’Œ: ${totalWeight.toFixed(1)}%\nä¸è¶³: ${Math.abs(diff).toFixed(1)}%\n\nç¢ºå®šè¦å„²å­˜å—?`;
                
                if (!confirm(message)) {
                    return;
                }
            }
            
            const templateId = `${employeeId}_${period}`;
            
            // æ ¹æ“šç¯„æœ¬é¡å‹å„²å­˜ä¸åŒçµæ§‹
            const templateData = {
                employeeId: employeeId,
                period: period,
                templateType: templateType,
                updatedAt: new Date().toISOString()
            };
            
            if (templateType === 'flat') {
                templateData.categories = window.currentTemplate.categories || [];
            } else {
                templateData.workPerformance = window.currentTemplate.workPerformance || [];
                templateData.comprehensivePerformance = window.currentTemplate.comprehensivePerformance || [];
                templateData.personalLearning = window.currentTemplate.personalLearning;
            }
            
            await setDoc(doc(db, 'evaluation_templates', templateId), templateData);
            
            alert('ç¯„æœ¬å„²å­˜æˆåŠŸ!');
        };

        // è¤‡è£½ä¸Šæœˆç¯„æœ¬
        window.copyPreviousMonthTemplate = async function() {
            if (window.currentTemplateLocked) {
                alert('ç¯„æœ¬å·²é–å®š,ç„¡æ³•è¤‡è£½ä¸Šæœˆç¯„æœ¬!');
                return;
            }
            
            const employeeId = document.getElementById('templateEmployee').value;
            const month = document.getElementById('templateMonth').value;
            
            if (!employeeId || !month) {
                alert('è«‹å…ˆé¸æ“‡å“¡å·¥å’Œæœˆä»½');
                return;
            }
            
            // è¨ˆç®—ä¸Šå€‹æœˆ
            const currentDate = new Date(month + '-01');
            currentDate.setMonth(currentDate.getMonth() - 1);
            const previousMonth = currentDate.toISOString().slice(0, 7).replace('-', '');
            
            // å–å¾—ä¸Šå€‹æœˆçš„ç¯„æœ¬
            const previousTemplateId = `${employeeId}_${previousMonth}`;
            const previousTemplateDoc = await getDoc(doc(db, 'evaluation_templates', previousTemplateId));
            
            if (!previousTemplateDoc.exists()) {
                alert('æ‰¾ä¸åˆ°ä¸Šå€‹æœˆçš„ç¯„æœ¬');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦è¤‡è£½ä¸Šå€‹æœˆçš„ç¯„æœ¬å—?é€™æœƒè¦†è“‹ç›®å‰çš„è¨­å®š!')) {
                const previousTemplate = previousTemplateDoc.data();
                
                // æ ¹æ“šç¯„æœ¬é¡å‹è¤‡è£½
                if (previousTemplate.templateType === 'flat') {
                    window.currentTemplate = {
                        categories: JSON.parse(JSON.stringify(previousTemplate.categories || [])),
                        templateType: 'flat'
                    };
                    renderFlatCategories();
                } else {
                    window.currentTemplate = {
                        workPerformance: JSON.parse(JSON.stringify(previousTemplate.workPerformance || [])),
                        comprehensivePerformance: JSON.parse(JSON.stringify(previousTemplate.comprehensivePerformance || [])),
                        personalLearning: JSON.parse(JSON.stringify(previousTemplate.personalLearning || { weight: 0, items: [] })),
                        templateType: 'structured'
                    };
                    
                    // æ›´æ–°é¡¯ç¤º
                    document.getElementById('learningWeight').value = window.currentTemplate.personalLearning.weight || 0;
                    renderWorkCategories();
                    renderCompCategories();
                    renderLearningItems();
                }
                
                alert('å·²è¤‡è£½ä¸Šæœˆç¯„æœ¬,è«‹è¨˜å¾—æŒ‰ã€Œå„²å­˜ç¯„æœ¬ã€ä»¥ä¿å­˜!');
            }
        };

        // æ¸…ç©ºç¯„æœ¬
        window.clearTemplate = function() {
            if (window.currentTemplateLocked) {
                alert('ç¯„æœ¬å·²é–å®š,ç„¡æ³•æ¸…ç©º!');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºç›®å‰çš„ç¯„æœ¬å—?')) {
                if (window.currentTemplateType === 'flat') {
                    window.currentTemplate = {
                        categories: [],
                        templateType: 'flat'
                    };
                    renderFlatCategories();
                } else {
                    window.currentTemplate = {
                        workPerformance: [],
                        comprehensivePerformance: [],
                        personalLearning: { weight: 0, items: [] },
                        templateType: 'structured'
                    };
                    
                    document.getElementById('learningWeight').value = 0;
                    renderWorkCategories();
                    renderCompCategories();
                    renderLearningItems();
                }
                
                alert('å·²æ¸…ç©ºç¯„æœ¬');
            }
        };

        // ç·¨è¼¯ä½¿ç”¨è€…
        window.editUser = async function(userId) {
            // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (!userDoc.exists()) {
                alert('æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™');
                return;
            }
            
            const userData = userDoc.data();
            
            // è¼‰å…¥æ‰€æœ‰ä¸»ç®¡åˆ—è¡¨
            const usersSnapshot = await getDocs(collection(db, 'users'));
            let managersOptions = '';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                if (user.role === 'manager' || user.role === 'staff') {
                    const isSelected = userData.evaluators && userData.evaluators.includes(user.userId) ? 'selected' : '';
                    managersOptions += `<option value="${user.userId}" ${isSelected}>${user.name} (${user.userId})</option>`;
                }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>ç·¨è¼¯äººå“¡ - ${userData.name}</h2>
                    <div id="editUserMessage"></div>
                    <form id="editUserForm">
                        <div class="form-group">
                            <label>å¸³è™Ÿ</label>
                            <input type="text" value="${userData.userId}" disabled style="background: #f7fafc;">
                        </div>
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" id="editUserName" value="${userData.name}" required>
                        </div>
                        <div class="form-group">
                            <label>æ–°å¯†ç¢¼ (ä¸ä¿®æ”¹è«‹ç•™ç©º)</label>
                            <input type="password" id="editUserPassword" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç¢¼">
                        </div>
                        <div class="form-group">
                            <label>è·ç­‰</label>
                            <select id="editUserLevel">
                                <option value="" ${!userData.level || userData.level === '' ? 'selected' : ''}>ç„¡è·ç­‰</option>
                                <option value="L1" ${userData.level === 'L1' ? 'selected' : ''}>L1</option>
                                <option value="L2" ${userData.level === 'L2' ? 'selected' : ''}>L2</option>
                                <option value="L3" ${userData.level === 'L3' ? 'selected' : ''}>L3</option>
                                <option value="L4" ${userData.level === 'L4' ? 'selected' : ''}>L4</option>
                                <option value="L5" ${userData.level === 'L5' ? 'selected' : ''}>L5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¡åˆ¥</label>
                            <select id="editUserCategory" required>
                                <option value="internal" ${!userData.category || userData.category === 'internal' ? 'selected' : ''}>å…§å‹¤</option>
                                <option value="external" ${userData.category === 'external' ? 'selected' : ''}>å¤–å‹¤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²</label>
                            <select id="editUserRole" required ${userId === 'Admin01' ? 'disabled' : ''}>
                                <option value="employee" ${userData.role === 'employee' ? 'selected' : ''}>ä¸€èˆ¬è·å“¡ (ç„¡æ³•ç™»å…¥ç³»çµ±)</option>
                                <option value="staff" ${userData.role === 'staff' ? 'selected' : ''}>ä¸€èˆ¬ä¸»ç®¡ (å¯è©•åˆ†)</option>
                                <option value="manager" ${userData.role === 'manager' ? 'selected' : ''}>ç®¡ç†è·ä¸»ç®¡ (å¯è©•åˆ†+å¯æŸ¥çœ‹å¾Œå°)</option>
                                ${userData.role === 'admin' ? '<option value="admin" selected>ç³»çµ±ç®¡ç†å“¡</option>' : ''}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±¬ä¸»ç®¡ (å¯è¤‡é¸,æŒ‰ä½ Ctrl æˆ– Command éµå¤šé¸)</label>
                            <select id="editUserEvaluators" multiple size="6" style="height: auto;">
                                ${managersOptions}
                            </select>
                            <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                å¦‚æœæ­¤äººå“¡éœ€è¦æ¥å—è©•æ ¸,è«‹é¸æ“‡è©•æ ¸ä¸»ç®¡<br>
                                æŒ‰ä½ Ctrl (Windows) æˆ– Command (Mac) å¯å¤šé¸
                            </small>
                        </div>
                        <div class="form-group">
                            <label>ä¸€èˆ¬è©•æ ¸é »ç‡</label>
                            <select id="editUserEvalFrequency" required>
                                <option value="none" ${userData.evaluationFrequency === 'none' || !userData.evaluationFrequency ? 'selected' : ''}>ä¸éœ€è©•æ ¸</option>
                                <option value="monthly" ${userData.evaluationFrequency === 'monthly' ? 'selected' : ''}>æ¯æœˆè©•æ ¸</option>
                                <option value="quarterly" ${userData.evaluationFrequency === 'quarterly' ? 'selected' : ''}>æ¯å­£è©•æ ¸ (3, 5, 9, 12æœˆ)</option>
                            </select>
                            <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                è¨­å®šè®Šæ›´å°‡æ–¼æ¬¡æœˆç”Ÿæ•ˆ
                            </small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editUserNeedKPI" ${userData.needKPI ? 'checked' : ''} onchange="window.toggleKPISettings(this, 'edit')">
                                éœ€è¦KPIè©•æ ¸ï¼ˆæ¯æœˆï¼‰
                            </label>
                        </div>
                        <div id="editKPISettings" style="display: ${userData.needKPI ? 'block' : 'none'}; background: #F1F8FE; padding: 15px; border-radius: 5px; margin-top: 10px;">
                            <div class="form-group">
                                <label>KPIåˆ†æ•¸å›å¡«åˆ°è€ƒæ ¸è¡¨æ¬„ä½</label>
                                <input type="text" id="editUserKPIField" value="${userData.kpiSettings?.targetField || ''}" placeholder="ä¾‹å¦‚: flat_2_0 (ç¬¬3å¤§é …ç¬¬1å°é …)">
                                <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                    æ ¼å¼èªªæ˜ï¼šflat_å¤§é …ç´¢å¼•_å°é …ç´¢å¼•<br>
                                    ä¾‹å¦‚ï¼šflat_2_0 è¡¨ç¤ºç¬¬3å€‹å¤§é …çš„ç¬¬1å€‹å°é …ï¼ˆç´¢å¼•å¾0é–‹å§‹ï¼‰
                                </small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">å„²å­˜ä¿®æ”¹</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('editUserName').value;
                const password = document.getElementById('editUserPassword').value;
                const level = document.getElementById('editUserLevel').value;
                const category = document.getElementById('editUserCategory').value;
                const role = userId === 'Admin01' ? 'admin' : document.getElementById('editUserRole').value;
                const evalFrequency = document.getElementById('editUserEvalFrequency').value;
                const needKPI = document.getElementById('editUserNeedKPI').checked;
                const kpiField = document.getElementById('editUserKPIField').value;
                
                // å–å¾—æ‰€é¸çš„ä¸»ç®¡
                const evaluatorsSelect = document.getElementById('editUserEvaluators');
                const evaluators = Array.from(evaluatorsSelect.selectedOptions).map(option => option.value);
                
                const updateData = {
                    name: name,
                    level: level || 'L5',
                    category: category,
                    role: role,
                    evaluators: evaluators,
                    evaluationFrequency: evalFrequency,
                    needKPI: needKPI,
                    kpiSettings: needKPI ? {
                        enabled: true,
                        targetField: kpiField
                    } : null
                };
                
                // å¦‚æœæœ‰è¼¸å…¥æ–°å¯†ç¢¼æ‰æ›´æ–°
                if (password) {
                    updateData.password = password;
                }
                
                await updateDoc(doc(db, 'users', userId), updateData);
                
                alert('äººå“¡è³‡æ–™å·²æ›´æ–°!');
                modal.remove();
                loadUsersList();
            });
        };

        // åˆªé™¤ä½¿ç”¨è€…
        window.deleteUser = async function(userId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… ${userId} å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!`)) {
                return;
            }
            
            await deleteDoc(doc(db, 'users', userId));
            alert('ä½¿ç”¨è€…å·²åˆªé™¤!');
            loadUsersList();
        };

        // åˆ‡æ›KPIè¨­å®šå€å¡Šé¡¯ç¤º
        window.toggleKPISettings = function(checkbox, mode) {
            const settingsDiv = document.getElementById(`${mode}KPISettings`);
            if (checkbox.checked) {
                settingsDiv.style.display = 'block';
            } else {
                settingsDiv.style.display = 'none';
            }
        };

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        window.loadStatistics = async function() {
            const month = document.getElementById('statsMonth').value;
            if (!month) return;
            
            const period = month.replace('-', '');
            const container = document.getElementById('statisticsContainer');
            container.innerHTML = '<div class="loading">è¨ˆç®—ä¸­...</div>';
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const employees = [];
            
            for (const userDoc of usersSnapshot.docs) {
                const user = userDoc.data();
                
                // æ’é™¤L5å’Œç„¡è·ç­‰çš„ä½¿ç”¨è€…
                if (!user.level || user.level === 'L5' || user.level === '') {
                    continue;
                }
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦ä¸€èˆ¬è©•æ ¸ï¼ˆä½¿ç”¨æ–°çš„evaluationFrequencyé‚è¼¯ï¼‰
                const needsNormalEval = checkNeedsEvaluationByFrequency(user.evaluationFrequency || 'none', period);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰KPIè©•æ ¸
                const needsKPI = user.needKPI || false;
                
                // åªè¦éœ€è¦ä¸€èˆ¬è©•æ ¸æˆ–éœ€è¦KPIè©•æ ¸ï¼Œå°±å˜—è©¦è¨ˆç®—åˆ†æ•¸
                if (needsNormalEval || needsKPI) {
                    const scores = await calculateEmployeeScores(user.userId, period);
                    if (scores) {
                        employees.push({
                            userId: user.userId,
                            name: user.name,
                            level: user.level,
                            scores: scores
                        });
                    }
                }
            }
            
            if (employees.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0;">æœ¬æœˆç„¡è©•æ ¸è³‡æ–™</p>';
                return;
            }
            
            // æ¸²æŸ“çµ±è¨ˆè¡¨
            renderStatisticsTable(employees, period);
        };

        // è¨ˆç®—å“¡å·¥åˆ†æ•¸
        async function calculateEmployeeScores(employeeId, period) {
            // å–å¾—ç¯„æœ¬
            const templateId = `${employeeId}_${period}`;
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
            
            // å…ˆæª¢æŸ¥KPIæˆç¸¾ï¼ˆä¸ç®¡æœ‰æ²’æœ‰evaluation_templateéƒ½è¦æª¢æŸ¥ï¼‰
            const kpiScore = await getKPIScore(employeeId, period);
            
            if (!templateDoc.exists()) {
                // æ²’æœ‰ä¸€èˆ¬è©•æ ¸ç¯„æœ¬ï¼Œä½†å¯èƒ½æœ‰KPIæˆç¸¾
                if (kpiScore > 0) {
                    return {
                        workScore: 0,
                        compScore: 0,
                        learningScore: 0,
                        kpiScore: kpiScore,
                        totalScore: kpiScore,
                        evaluations: []
                    };
                }
                return null;
            }
            
            const template = templateDoc.data();
            
            // å–å¾—æ‰€æœ‰ä¸»ç®¡çš„è©•åˆ†
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            const evaluations = [];
            evaluationsSnapshot.forEach(doc => {
                evaluations.push(doc.data());
            });
            
            if (evaluations.length === 0) {
                // å³ä½¿æ²’æœ‰ä¸»ç®¡è©•åˆ†ï¼Œä¹Ÿæª¢æŸ¥æ˜¯å¦æœ‰KPIæª¢æ ¸æˆç¸¾
                if (kpiScore > 0) {
                    return {
                        workScore: 0,
                        compScore: 0,
                        learningScore: 0,
                        kpiScore: kpiScore,
                        totalScore: kpiScore,
                        evaluations: []
                    };
                }
                return null;
            }
            
            // å·²ç¶“åœ¨é–‹é ­æŸ¥è©¢éKPIæˆç¸¾ï¼Œé€™è£¡ç›´æ¥ä½¿ç”¨
            
            // æ ¹æ“šç¯„æœ¬é¡å‹è¨ˆç®—åˆ†æ•¸
            if (template.templateType === 'flat') {
                // L3ã€L4 æ‰å¹³åŒ–çµæ§‹
                const totalScore = calculateFlatScore(template.categories, evaluations);
                return {
                    workScore: 0,
                    compScore: 0,
                    learningScore: 0,
                    kpiScore: kpiScore,
                    totalScore: totalScore + kpiScore,
                    evaluations: evaluations
                };
            } else {
                // L1ã€L2 çµæ§‹åŒ–
                const workScore = calculateCategoryScore(
                    template.workPerformance,
                    evaluations,
                    'work'
                );
                
                const compScore = calculateCategoryScore(
                    template.comprehensivePerformance,
                    evaluations,
                    'comp'
                );
                
                const learningScore = calculateLearningScore(
                    template.personalLearning,
                    evaluations
                );
                
                const totalScore = workScore + compScore + learningScore + kpiScore;
                
                return {
                    workScore: workScore,
                    compScore: compScore,
                    learningScore: learningScore,
                    kpiScore: kpiScore,
                    totalScore: totalScore,
                    evaluations: evaluations
                };
            }
        }
        
        // æ–°å¢ï¼šå–å¾—KPIæª¢æ ¸ç¸½åˆ†ï¼ˆåˆä½µæ‰€æœ‰è©•åˆ†äººçš„æˆç¸¾ï¼‰
        async function getKPIScore(employeeId, period) {
            const kpiQuery = query(
                collection(db, 'kpi_checklists'),
                where('employeeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const kpiSnapshot = await getDocs(kpiQuery);
            let totalKpiScore = 0;
            
            kpiSnapshot.forEach(doc => {
                const data = doc.data();
                totalKpiScore += (data.totalScore || 0);
            });
            
            return totalKpiScore;
        }

        // è¨ˆç®—åˆ†é¡åˆ†æ•¸(å·¥ä½œè¡¨ç¾/ç¶œåˆè¡¨ç¾)
        function calculateCategoryScore(categories, evaluations, prefix) {
            if (!categories || categories.length === 0) {
                return 0;
            }
            
            const categoryResults = [];
            
            // è¨ˆç®—æ¯å€‹å¤§é¡çš„åˆ†æ•¸
            categories.forEach((category, catIndex) => {
                const itemScores = [];
                
                category.items.forEach((item, itemIndex) => {
                    const itemKey = `${prefix}_${catIndex}_${itemIndex}`;
                    const allScores = [];
                    
                    // æ”¶é›†æ‰€æœ‰ä¸»ç®¡å°é€™å€‹å°é …çš„è©•åˆ†
                    evaluations.forEach(evaluation => {
                        const score1Value = evaluation.scores[`${itemKey}_1`];
                        const score2Value = evaluation.scores[`${itemKey}_2`];
                        
                        // æª¢æŸ¥æ¬„ä½æ˜¯å¦æœ‰å¡«å¯«(åŒ…å«0åˆ†)
                        const hasScore1 = score1Value !== undefined && score1Value !== null && score1Value !== '';
                        const hasScore2 = score2Value !== undefined && score2Value !== null && score2Value !== '';
                        
                        // å¦‚æœè‡³å°‘æœ‰ä¸€å€‹æ¬„ä½æœ‰å¡«å¯«
                        if (hasScore1 || hasScore2) {
                            const score1 = hasScore1 ? parseFloat(score1Value) : 0;
                            const score2 = hasScore2 ? parseFloat(score2Value) : 0;
                            
                            if (!isNaN(score1) && !isNaN(score2)) {
                                // å¦‚æœå…©å€‹éƒ½æœ‰å¡«,å–å¹³å‡
                                if (hasScore1 && hasScore2) {
                                    const avgScore = (score1 + score2) / 2;
                                    allScores.push(avgScore);
                                }
                                // å¦‚æœåªæœ‰ä¸€å€‹æœ‰å¡«,å°±ç”¨è©²åˆ†æ•¸
                                else if (hasScore1) {
                                    allScores.push(score1);
                                }
                                else if (hasScore2) {
                                    allScores.push(score2);
                                }
                            }
                        }
                    });
                    
                    // è¨ˆç®—é€™å€‹å°é …çš„å¹³å‡åˆ†æ•¸
                    if (allScores.length > 0) {
                        const itemAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                        itemScores.push(itemAvg);
                    }
                });
                
                // å¦‚æœé€™å€‹å¤§é¡æœ‰åˆ†æ•¸
                if (itemScores.length > 0) {
                    const categoryAvg = itemScores.reduce((a, b) => a + b, 0) / itemScores.length;
                    categoryResults.push({
                        score: categoryAvg,
                        weight: category.weight,
                        hasScore: true
                    });
                } else {
                    // æ²’æœ‰åˆ†æ•¸ä½†è¨˜éŒ„ä½”æ¯”,ç”¨æ–¼å‡æ”¤
                    categoryResults.push({
                        score: 0,
                        weight: category.weight,
                        hasScore: false
                    });
                }
            });
            
            // è¨ˆç®—éœ€è¦å‡æ”¤çš„ä½”æ¯”
            const totalOriginalWeight = categoryResults.reduce((sum, cat) => sum + cat.weight, 0);
            const scoredWeight = categoryResults.filter(cat => cat.hasScore).reduce((sum, cat) => sum + cat.weight, 0);
            const unscoredWeight = totalOriginalWeight - scoredWeight;
            
            // å¦‚æœæ²’æœ‰ä»»ä½•åˆ†æ•¸
            if (scoredWeight === 0) {
                return 0;
            }
            
            // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
            let finalScore = 0;
            categoryResults.forEach(cat => {
                if (cat.hasScore) {
                    // èª¿æ•´å¾Œçš„ä½”æ¯” = åŸä½”æ¯” + (åŸä½”æ¯”/å·²è©•åˆ†ç¸½ä½”æ¯”) Ã— æœªè©•åˆ†ç¸½ä½”æ¯”
                    const adjustedWeight = cat.weight + (cat.weight / scoredWeight) * unscoredWeight;
                    // å¤§é¡å¾—åˆ† = (å°é …å¹³å‡åˆ† / 5) Ã— èª¿æ•´å¾Œä½”æ¯”
                    const categoryScore = (cat.score / 5) * adjustedWeight;
                    finalScore += categoryScore;
                }
            });
            
            return finalScore;
        }

        // è¨ˆç®—æ‰å¹³åŒ–çµæ§‹åˆ†æ•¸(L3ã€L4)
        function calculateFlatScore(categories, evaluations) {
            if (!categories || categories.length === 0) {
                return 0;
            }
            
            const categoryResults = [];
            
            // è¨ˆç®—æ¯å€‹å¤§é …çš„åˆ†æ•¸
            categories.forEach((category, catIndex) => {
                const itemScores = [];
                
                category.items.forEach((item, itemIndex) => {
                    const itemKey = `flat_${catIndex}_${itemIndex}`;
                    const allScores = [];
                    
                    // æ”¶é›†æ‰€æœ‰ä¸»ç®¡å°é€™å€‹å°é …çš„è©•åˆ† (åªæœ‰ä¸€å€‹æ¬„ä½)
                    evaluations.forEach(evaluation => {
                        const scoreValue = evaluation.scores[itemKey];
                        
                        // æª¢æŸ¥æ¬„ä½æ˜¯å¦æœ‰å¡«å¯«(åŒ…å«0åˆ†)
                        const hasScore = scoreValue !== undefined && scoreValue !== null && scoreValue !== '';
                        
                        if (hasScore) {
                            const score = parseFloat(scoreValue);
                            if (!isNaN(score)) {
                                allScores.push(score);
                            }
                        }
                    });
                    
                    // è¨ˆç®—é€™å€‹å°é …çš„å¹³å‡åˆ†æ•¸
                    if (allScores.length > 0) {
                        const itemAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                        itemScores.push(itemAvg);
                    }
                });
                
                // å¦‚æœé€™å€‹å¤§é …æœ‰åˆ†æ•¸
                if (itemScores.length > 0) {
                    const categoryAvg = itemScores.reduce((a, b) => a + b, 0) / itemScores.length;
                    categoryResults.push({
                        score: categoryAvg,
                        weight: category.weight,
                        hasScore: true
                    });
                } else {
                    // æ²’æœ‰åˆ†æ•¸ä½†è¨˜éŒ„ä½”æ¯”,ç”¨æ–¼å‡æ”¤
                    categoryResults.push({
                        score: 0,
                        weight: category.weight,
                        hasScore: false
                    });
                }
            });
            
            // è¨ˆç®—éœ€è¦å‡æ”¤çš„ä½”æ¯”
            const totalOriginalWeight = categoryResults.reduce((sum, cat) => sum + cat.weight, 0);
            const scoredWeight = categoryResults.filter(cat => cat.hasScore).reduce((sum, cat) => sum + cat.weight, 0);
            const unscoredWeight = totalOriginalWeight - scoredWeight;
            
            // å¦‚æœæ²’æœ‰ä»»ä½•åˆ†æ•¸
            if (scoredWeight === 0) {
                return 0;
            }
            
            // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
            let finalScore = 0;
            categoryResults.forEach(cat => {
                if (cat.hasScore) {
                    // èª¿æ•´å¾Œçš„ä½”æ¯” = åŸä½”æ¯” + (åŸä½”æ¯”/å·²è©•åˆ†ç¸½ä½”æ¯”) Ã— æœªè©•åˆ†ç¸½ä½”æ¯”
                    const adjustedWeight = cat.weight + (cat.weight / scoredWeight) * unscoredWeight;
                    // å¤§é …å¾—åˆ† = (å°é …å¹³å‡åˆ† / 5) Ã— èª¿æ•´å¾Œä½”æ¯”
                    const categoryScore = (cat.score / 5) * adjustedWeight;
                    finalScore += categoryScore;
                }
            });
            
            return finalScore;
        }

        // è¨ˆç®—å€‹äººå­¸ç¿’åˆ†æ•¸
        function calculateLearningScore(learningTemplate, evaluations) {
            if (!learningTemplate || !learningTemplate.items || learningTemplate.items.length === 0) {
                return 0;
            }
            
            const itemScores = [];
            
            learningTemplate.items.forEach((item, itemIndex) => {
                const itemKey = `learn_${itemIndex}`;
                const allScores = [];
                
                evaluations.forEach(evaluation => {
                    const score1Value = evaluation.scores[`${itemKey}_1`];
                    const score2Value = evaluation.scores[`${itemKey}_2`];
                    
                    // æª¢æŸ¥æ¬„ä½æ˜¯å¦æœ‰å¡«å¯«(åŒ…å«0åˆ†)
                    const hasScore1 = score1Value !== undefined && score1Value !== null && score1Value !== '';
                    const hasScore2 = score2Value !== undefined && score2Value !== null && score2Value !== '';
                    
                    // å¦‚æœè‡³å°‘æœ‰ä¸€å€‹æ¬„ä½æœ‰å¡«å¯«
                    if (hasScore1 || hasScore2) {
                        const score1 = hasScore1 ? parseFloat(score1Value) : 0;
                        const score2 = hasScore2 ? parseFloat(score2Value) : 0;
                        
                        if (!isNaN(score1) && !isNaN(score2)) {
                            // å¦‚æœå…©å€‹éƒ½æœ‰å¡«,å–å¹³å‡
                            if (hasScore1 && hasScore2) {
                                const avgScore = (score1 + score2) / 2;
                                allScores.push(avgScore);
                            }
                            // å¦‚æœåªæœ‰ä¸€å€‹æœ‰å¡«,å°±ç”¨è©²åˆ†æ•¸
                            else if (hasScore1) {
                                allScores.push(score1);
                            }
                            else if (hasScore2) {
                                allScores.push(score2);
                            }
                        }
                    }
                });
                
                if (allScores.length > 0) {
                    const itemAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                    itemScores.push(itemAvg);
                }
            });
            
            if (itemScores.length === 0) {
                return 0;
            }
            
            // è¨ˆç®—æ‰€æœ‰å­¸ç¿’é …ç›®çš„å¹³å‡åˆ†
            const avgScore = itemScores.reduce((a, b) => a + b, 0) / itemScores.length;
            // å€‹äººå­¸ç¿’å¾—åˆ† = (å¹³å‡åˆ† / 5) Ã— ä½”æ¯”
            return (avgScore / 5) * learningTemplate.weight;
        }

        // æ¸²æŸ“çµ±è¨ˆè¡¨
        async function renderStatisticsTable(employees, period) {
            const container = document.getElementById('statisticsContainer');
            
            // è¨ˆç®—ä¸Šå€‹æœˆæœŸé–“
            const currentDate = new Date(period.slice(0, 4) + '-' + period.slice(4) + '-01');
            currentDate.setMonth(currentDate.getMonth() - 1);
            const previousPeriod = currentDate.toISOString().slice(0, 7).replace('-', '');
            
            // å–å¾—ä¸Šå€‹æœˆåˆ†æ•¸
            const previousScores = {};
            for (const emp of employees) {
                const prevScores = await calculateEmployeeScores(emp.userId, previousPeriod);
                if (prevScores) {
                    previousScores[emp.userId] = prevScores.totalScore;
                }
            }
            
            let html = '';
            
            employees.forEach(emp => {
                const prevScore = previousScores[emp.userId];
                let diff = null;
                let diffClass = '';
                let diffText = '-';
                
                if (prevScore !== undefined) {
                    diff = emp.scores.totalScore - prevScore;
                    if (diff > 0 && diff >= 5) {
                        diffClass = 'score-positive';
                        diffText = `+${diff.toFixed(1)}`;
                    } else if (diff < 0 && diff <= -6) {
                        diffClass = 'score-negative-heavy';
                        diffText = diff.toFixed(1);
                    } else if (diff < 0 && diff > -6) {
                        diffClass = 'score-negative-light';
                        diffText = diff.toFixed(1);
                    } else {
                        diffText = diff.toFixed(1);
                    }
                }
                
                html += `
                    <div style="background: white; padding: 25px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #1E88E5; margin-bottom: 20px;">${emp.name} (${emp.userId}) - ${emp.level}</h3>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>æœˆä»½</th>
                                    <th>å·¥ä½œè¡¨ç¾</th>
                                    <th>ç¶œåˆè¡¨ç¾</th>
                                    <th>å€‹äººå­¸ç¿’</th>
                                    <th style="background: #fef3c7;">KPIæª¢æ ¸</th>
                                    <th>ç¸½åˆ†</th>
                                    <th>èˆ‡ä¸Šæœˆæ¯”è¼ƒ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${period.slice(0,4)}å¹´${period.slice(4)}æœˆ</td>
                                    <td>${emp.scores.workScore.toFixed(1)}</td>
                                    <td>${emp.scores.compScore.toFixed(1)}</td>
                                    <td>${emp.scores.learningScore.toFixed(1)}</td>
                                    <td style="background: #fef3c7; font-weight: bold;">${(emp.scores.kpiScore || 0).toFixed(1)}</td>
                                    <td><strong>${emp.scores.totalScore.toFixed(1)}</strong></td>
                                    <td class="${diffClass}">${diffText}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="window.viewEvaluationDetails('${emp.userId}', '${period}')">æŸ¥çœ‹æ˜ç´°</button>
                                        <button class="btn btn-danger" onclick="window.returnEvaluations('${emp.userId}', '${period}')">å…¨éƒ¨é€€å–®</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æŸ¥çœ‹è©•åˆ†æ˜ç´°
        window.viewEvaluationDetails = async function(employeeId, period) {
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            // å–å¾—ä¸»ç®¡åç¨±
            const evaluatorNames = {};
            const usersSnapshot = await getDocs(collection(db, 'users'));
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                evaluatorNames[user.userId] = user.name;
            });
            
            // å–å¾—å“¡å·¥åç¨±
            const employeeDoc = await getDoc(doc(db, 'users', employeeId));
            const employeeName = employeeDoc.exists() ? employeeDoc.data().name : employeeId;
            
            // å–å¾—ç¯„æœ¬
            const templateId = `${employeeId}_${period}`;
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
            const template = templateDoc.exists() ? templateDoc.data() : null;
            
            let detailsHtml = `<h3>${employeeName} - ${period.slice(0,4)}å¹´${period.slice(4)}æœˆ è©•åˆ†æ˜ç´°</h3>`;
            
            // é¡¯ç¤ºä¸€èˆ¬è©•æ ¸æ˜ç´°
            if (evaluationsSnapshot.size > 0) {
                detailsHtml += '<h4 style="margin-top: 20px; color: #1E88E5;">ğŸ“‹ ä¸€èˆ¬è©•æ ¸æ˜ç´°</h4>';
                
                evaluationsSnapshot.forEach(doc => {
                    const evaluation = doc.data();
                    const evaluatorName = evaluatorNames[evaluation.evaluatorId] || evaluation.evaluatorId;
                    
                    // é¡¯ç¤ºæ‰€æœ‰è©•åˆ†é …ç›®
                    let scoresHtml = '<div style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">';
                    
                    if (template) {
                        if (template.templateType === 'flat') {
                            // L3ã€L4 æ‰å¹³åŒ–çµæ§‹ - åªæœ‰ä¸€å€‹è©•åˆ†æ¬„ä½
                            scoresHtml += '<table style="width: 100%; font-size: 0.9em;"><thead><tr><th>é¡åˆ¥</th><th>è©•åˆ†é …ç›®</th><th>è©•åˆ†</th></tr></thead><tbody>';
                            
                            if (template.categories) {
                                template.categories.forEach((category, catIndex) => {
                                    category.items.forEach((item, itemIndex) => {
                                        const itemKey = `flat_${catIndex}_${itemIndex}`;
                                        const score = evaluation.scores[itemKey] || '';
                                        
                                        scoresHtml += `<tr><td style="font-size: 0.8em;">${category.name}</td><td style="font-size: 0.8em;">${item}</td><td>${score}</td></tr>`;
                                    });
                                });
                            }
                        } else {
                            // L1ã€L2 çµæ§‹åŒ– - å…©å€‹è©•åˆ†æ¬„ä½
                            scoresHtml += '<table style="width: 100%; font-size: 0.9em;"><thead><tr><th>é¡åˆ¥</th><th>è©•åˆ†é …ç›®</th><th>åŸ·è¡ŒåŠ›</th><th>éŒ¯èª¤ç‡</th></tr></thead><tbody>';
                            
                            // å·¥ä½œè¡¨ç¾
                            if (template.workPerformance) {
                                template.workPerformance.forEach((category, catIndex) => {
                                    category.items.forEach((item, itemIndex) => {
                                        const itemKey = `work_${catIndex}_${itemIndex}`;
                                        const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                        const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                        
                                        scoresHtml += `<tr><td style="font-size: 0.8em;">å·¥ä½œ-${category.name}</td><td style="font-size: 0.8em;">${item}</td><td>${score1}</td><td>${score2}</td></tr>`;
                                    });
                                });
                            }
                            
                            // ç¶œåˆè¡¨ç¾
                            if (template.comprehensivePerformance) {
                                template.comprehensivePerformance.forEach((category, catIndex) => {
                                    category.items.forEach((item, itemIndex) => {
                                        const itemKey = `comp_${catIndex}_${itemIndex}`;
                                        const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                        const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                        
                                        scoresHtml += `<tr><td style="font-size: 0.8em;">ç¶œåˆ-${category.name}</td><td style="font-size: 0.8em;">${item}</td><td>${score1}</td><td>${score2}</td></tr>`;
                                    });
                                });
                            }
                            
                            // å€‹äººå­¸ç¿’
                            if (template.personalLearning && template.personalLearning.items) {
                                template.personalLearning.items.forEach((item, itemIndex) => {
                                    const itemKey = `learn_${itemIndex}`;
                                    const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                    const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                    
                                    scoresHtml += `<tr><td style="font-size: 0.8em;">å€‹äººå­¸ç¿’</td><td style="font-size: 0.8em;">${item}</td><td>${score1}</td><td>${score2}</td></tr>`;
                                });
                            }
                        }
                    }
                    
                    scoresHtml += '</tbody></table></div>';
                    
                    detailsHtml += `
                        <div style="background: #f7fafc; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #1E88E5;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0;">${evaluatorName} çš„è©•åˆ†</h4>
                                <button class="btn btn-danger" onclick="window.returnSingleEvaluation('${evaluation.evaluationId}', '${evaluatorName}', '${employeeId}', '${period}')">
                                    ğŸ”„ é€€å›æ­¤è©•åˆ†
                                </button>
                            </div>
                            <p><strong>è©•èª:</strong> ${evaluation.comment || 'ç„¡'}</p>
                            <p><strong>é€å‡ºæ™‚é–“:</strong> ${new Date(evaluation.submittedAt).toLocaleString('zh-TW')}</p>
                            <details>
                                <summary style="cursor: pointer; color: #1E88E5; margin-top: 10px;"><strong>ğŸ“Š æŸ¥çœ‹æ‰€æœ‰è©•åˆ†é …ç›®</strong></summary>
                                ${scoresHtml}
                            </details>
                        </div>
                    `;
                });
            } else {
                detailsHtml += '<p style="color: #718096; padding: 10px; background: #f7fafc; border-radius: 6px;">æœ¬æœˆç„¡ä¸€èˆ¬è©•æ ¸è³‡æ–™</p>';
            }
            
            // é¡¯ç¤ºKPIæª¢æ ¸æ˜ç´°
            const kpiQuery = query(
                collection(db, 'kpi_checklists'),
                where('employeeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            const kpiSnapshot = await getDocs(kpiQuery);
            
            if (kpiSnapshot.size > 0) {
                detailsHtml += '<h4 style="margin-top: 30px; color: #f59e0b; border-top: 2px solid #fef3c7; padding-top: 20px;">ğŸ“Š KPIæª¢æ ¸æ˜ç´°</h4>';
                
                kpiSnapshot.forEach(doc => {
                    const kpiData = doc.data();
                    const kpiDocId = doc.id;
                    const checkerName = kpiData.checkerName || 'æœªçŸ¥';
                    const checkerId = kpiData.checkerId || '';
                    
                    // é¡¯ç¤ºè©•æ ¸çµæœè©³æƒ…
                    let resultsDetail = '';
                    if (kpiData.results) {
                        resultsDetail = '<details><summary style="cursor: pointer; color: #f59e0b; margin-top: 10px;"><strong>ğŸ“‹ æŸ¥çœ‹è©•æ ¸è¨˜éŒ„</strong></summary>';
                        resultsDetail += '<div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px; max-height: 200px; overflow-y: auto;">';
                        resultsDetail += '<table style="width: 100%; font-size: 0.85em;"><thead><tr><th>é …ç›®</th><th>çµæœ</th></tr></thead><tbody>';
                        
                        Object.entries(kpiData.results).forEach(([key, value]) => {
                            if (value) {
                                const displayValue = value === 'V' ? 'âœ“ å®Œæˆ' : value === 'X' ? 'âœ— æœªå®Œæˆ' : value;
                                resultsDetail += `<tr><td>${key}</td><td>${displayValue}</td></tr>`;
                            }
                        });
                        
                        resultsDetail += '</tbody></table></div></details>';
                    }
                    
                    detailsHtml += `
                        <div style="background: #fffbeb; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0;">${checkerName} çš„KPIè©•æ ¸</h4>
                                    <small style="color: #92400e;">ID: ${checkerId} | æ–‡ä»¶: ${kpiDocId}</small>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span style="background: #f59e0b; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                        ${kpiData.totalScore.toFixed(1)} åˆ†
                                    </span>
                                    <button class="btn btn-danger" onclick="window.returnKPIEvaluation('${kpiDocId}', '${checkerName}', '${employeeId}', '${period}')" style="padding: 5px 10px; font-size: 0.9em;">
                                        ğŸ”„ é€€å–®
                                    </button>
                                </div>
                            </div>
                            <p><strong>è©•æ ¸é …ç›®:</strong> ${(kpiData.itemsEvaluated || []).join('ã€')}</p>
                            <p><strong>é€å‡ºæ™‚é–“:</strong> ${new Date(kpiData.submittedAt).toLocaleString('zh-TW')}</p>
                            ${resultsDetail}
                        </div>
                    `;
                });
                
                // é¡¯ç¤ºKPIç¸½åˆ†å’Œé‡è¤‡è­¦å‘Š
                let totalKpiScore = 0;
                const checkerNames = [];
                kpiSnapshot.forEach(doc => {
                    totalKpiScore += (doc.data().totalScore || 0);
                    checkerNames.push(doc.data().checkerName);
                });
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„è©•åˆ†äºº
                const duplicates = checkerNames.filter((name, index) => checkerNames.indexOf(name) !== index);
                const hasDuplicates = duplicates.length > 0;
                
                detailsHtml += `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center; margin-top: 10px;">
                        <div style="font-size: 0.9em; color: #92400e; margin-bottom: 5px;">KPIæª¢æ ¸ç¸½åˆ†</div>
                        <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${totalKpiScore.toFixed(1)} åˆ†</div>
                        <div style="font-size: 0.9em; color: #92400e; margin-top: 5px;">å…± ${kpiSnapshot.size} ç­†è©•æ ¸è¨˜éŒ„</div>
                        ${totalKpiScore > 100 ? '<div style="color: #dc2626; margin-top: 10px; font-weight: bold;">âš ï¸ æ³¨æ„ï¼šåˆ†æ•¸è¶…é100ï¼Œè«‹æª¢æŸ¥é …ç›®æ¬Šé‡è¨­å®š</div>' : ''}
                        ${hasDuplicates ? `<div style="color: #dc2626; margin-top: 10px; font-weight: bold;">âš ï¸ è­¦å‘Šï¼šç™¼ç¾é‡è¤‡çš„è©•åˆ†äººï¼ˆ${[...new Set(duplicates)].join('ã€')}ï¼‰ï¼Œå¯èƒ½å°è‡´åˆ†æ•¸é‡è¤‡è¨ˆç®—ï¼</div>` : ''}
                    </div>
                `;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'detailsModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    ${detailsHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // é€€å›å–®ä¸€ä¸»ç®¡çš„è©•åˆ†
        window.returnSingleEvaluation = async function(evaluationId, evaluatorName, employeeId, period) {
            if (!confirm(`ç¢ºå®šè¦é€€å› ${evaluatorName} çš„è©•åˆ†å—?\n\né€€å›å¾Œè©²ä¸»ç®¡å¯ä»¥é‡æ–°ä¿®æ”¹ä¸¦é€å‡ºã€‚`)) {
                return;
            }
            
            await updateDoc(doc(db, 'evaluations', evaluationId), {
                status: 'draft',
                returnedAt: new Date().toISOString()
            });
            
            alert(`å·²é€€å› ${evaluatorName} çš„è©•åˆ†!`);
            
            // é—œé–‰å½ˆçª—
            const modal = document.getElementById('detailsModal');
            if (modal) {
                modal.remove();
            }
            
            // é‡æ–°è¼‰å…¥çµ±è¨ˆ
            window.loadStatistics();
        };

        // é€€å–®åŠŸèƒ½
        window.returnEvaluations = async function(employeeId, period) {
            if (!confirm('ç¢ºå®šè¦é€€å›æ­¤å“¡å·¥çš„æ‰€æœ‰è©•åˆ†å—?ä¸»ç®¡å°‡å¯ä»¥é‡æ–°ä¿®æ”¹ä¸¦é€å‡ºã€‚')) {
                return;
            }
            
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            for (const evalDoc of evaluationsSnapshot.docs) {
                await updateDoc(doc(db, 'evaluations', evalDoc.id), {
                    status: 'draft',
                    returnedAt: new Date().toISOString()
                });
            }
            
            alert('å·²é€€å–®!ä¸»ç®¡ç¾åœ¨å¯ä»¥é‡æ–°ä¿®æ”¹è©•åˆ†ã€‚');
            window.loadStatistics();
        };

        // é€€å›KPIè©•æ ¸
        window.returnKPIEvaluation = async function(kpiDocId, checkerName, employeeId, period) {
            if (!confirm(`ç¢ºå®šè¦é€€å› ${checkerName} çš„KPIè©•æ ¸å—ï¼Ÿ\n\né€€å›å¾Œè©²è©•åˆ†äººå¯ä»¥é‡æ–°ä¿®æ”¹ä¸¦é€å‡ºã€‚`)) {
                return;
            }
            
            try {
                await updateDoc(doc(db, 'kpi_checklists', kpiDocId), {
                    status: 'draft',
                    returnedAt: new Date().toISOString()
                });
                
                alert('KPIè©•æ ¸å·²é€€å›ï¼');
                
                // é—œé–‰æ˜ç´°è¦–çª—ä¸¦é‡æ–°è¼‰å…¥çµ±è¨ˆè¡¨
                const modal = document.getElementById('detailsModal');
                if (modal) {
                    modal.remove();
                }
                window.loadStatistics();
            } catch (error) {
                console.error('é€€å–®å¤±æ•—:', error);
                alert('é€€å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        };

        // ä¸‹è¼‰CSV
        window.downloadCSV = async function() {
            const month = document.getElementById('statsMonth').value;
            if (!month) {
                alert('è«‹å…ˆé¸æ“‡æœˆä»½');
                return;
            }
            
            const period = month.replace('-', '');
            
            // å–å¾—æ‰€æœ‰è©•åˆ†è¨˜éŒ„
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            if (evaluationsSnapshot.empty) {
                alert('æœ¬æœˆç„¡è©•åˆ†è³‡æ–™');
                return;
            }
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…åç¨±
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const userNames = {};
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                userNames[user.userId] = user.name;
            });
            
            // å»ºç«‹ CSV å…§å®¹
            let csv = '\uFEFF'; // UTF-8 BOM
            csv += 'è¢«è©•äºº,ä¸»ç®¡,å¤§é¡,å°é …,è©•åˆ†1,è©•åˆ†2,è©•èª,é€å‡ºæ™‚é–“\n';
            
            for (const evalDoc of evaluationsSnapshot.docs) {
                const evaluation = evalDoc.data();
                const evaluateeName = userNames[evaluation.evaluateeId] || evaluation.evaluateeId;
                const evaluatorName = userNames[evaluation.evaluatorId] || evaluation.evaluatorId;
                const submittedAt = new Date(evaluation.submittedAt).toLocaleString('zh-TW');
                const comment = (evaluation.comment || '').replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                
                // å–å¾—ç¯„æœ¬ä»¥è§£æé …ç›®åç¨±
                const templateId = `${evaluation.evaluateeId}_${period}`;
                const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
                
                if (templateDoc.exists()) {
                    const template = templateDoc.data();
                    
                    if (template.templateType === 'flat') {
                        // L3ã€L4 æ‰å¹³åŒ–çµæ§‹ - åªæœ‰ä¸€å€‹åˆ†æ•¸,ç¬¬äºŒæ¬„ç•™ç©º
                        if (template.categories) {
                            template.categories.forEach((category, catIndex) => {
                                category.items.forEach((item, itemIndex) => {
                                    const itemKey = `flat_${catIndex}_${itemIndex}`;
                                    const score = evaluation.scores[itemKey] || '';
                                    
                                    const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                                    const categoryName = category.name.replace(/,/g, 'ï¼Œ').replace(/"/g, '""');
                                    
                                    csv += `"${evaluateeName}","${evaluatorName}","${categoryName}","${itemName}",${score},,"${comment}","${submittedAt}"\n`;
                                });
                            });
                        }
                    } else {
                        // L1ã€L2 çµæ§‹åŒ– - å…©å€‹åˆ†æ•¸æ¬„ä½
                        // å·¥ä½œè¡¨ç¾
                        if (template.workPerformance) {
                            template.workPerformance.forEach((category, catIndex) => {
                                category.items.forEach((item, itemIndex) => {
                                    const itemKey = `work_${catIndex}_${itemIndex}`;
                                    const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                    const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                    
                                    const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                                    const categoryName = category.name.replace(/,/g, 'ï¼Œ').replace(/"/g, '""');
                                    
                                    csv += `"${evaluateeName}","${evaluatorName}","å·¥ä½œè¡¨ç¾-${categoryName}","${itemName}",${score1},${score2},"${comment}","${submittedAt}"\n`;
                                });
                            });
                        }
                        
                        // ç¶œåˆè¡¨ç¾
                        if (template.comprehensivePerformance) {
                            template.comprehensivePerformance.forEach((category, catIndex) => {
                                category.items.forEach((item, itemIndex) => {
                                    const itemKey = `comp_${catIndex}_${itemIndex}`;
                                    const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                    const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                    
                                    const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                                    const categoryName = category.name.replace(/,/g, 'ï¼Œ').replace(/"/g, '""');
                                    
                                    csv += `"${evaluateeName}","${evaluatorName}","ç¶œåˆè¡¨ç¾-${categoryName}","${itemName}",${score1},${score2},"${comment}","${submittedAt}"\n`;
                                });
                            });
                        }
                        
                        // å€‹äººå­¸ç¿’
                        if (template.personalLearning && template.personalLearning.items) {
                            template.personalLearning.items.forEach((item, itemIndex) => {
                                const itemKey = `learn_${itemIndex}`;
                                const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                
                                const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                                
                                csv += `"${evaluateeName}","${evaluatorName}","å€‹äººå­¸ç¿’","${itemName}",${score1},${score2},"${comment}","${submittedAt}"\n`;
                            });
                        }
                    }
                }
            }
            
            // ä¸‹è¼‰ CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è©•åˆ†æ˜ç´°_${period}.csv`;
            link.click();
        };

        // è¼‰å…¥è·ç­‰æ¯”å°åœ–è¡¨
        window.loadCharts = async function() {
            const year = document.getElementById('chartYear').value;
            if (!year) return;
            
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…ä¸¦æŒ‰è·ç­‰å’Œé¡åˆ¥åˆ†çµ„
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const levelGroups = {
                internal: {}, // å…§å‹¤
                external: {}  // å¤–å‹¤
            };
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // æ’é™¤ L5 å’Œç„¡è·ç­‰çš„ä½¿ç”¨è€…
                if (user.level && user.level !== 'L5' && user.level !== '' && ['L1', 'L2', 'L3', 'L4'].includes(user.level)) {
                    const category = user.category || 'internal'; // é è¨­ç‚ºå…§å‹¤
                    
                    if (!levelGroups[category][user.level]) {
                        levelGroups[category][user.level] = [];
                    }
                    levelGroups[category][user.level].push(user);
                }
            });
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™
            const hasInternalData = Object.keys(levelGroups.internal).length > 0;
            const hasExternalData = Object.keys(levelGroups.external).length > 0;
            
            if (!hasInternalData && !hasExternalData) {
                container.innerHTML = '<p style="color: #a0aec0;">ç„¡è·ç­‰è³‡æ–™</p>';
                return;
            }
            
            let chartsHtml = '';
            const levelOrder = ['L1', 'L2', 'L3', 'L4'];
            
            // å…§å‹¤åœ–è¡¨
            if (hasInternalData) {
                chartsHtml += '<h3 style="margin-top: 30px; margin-bottom: 20px; color: #2d3748; border-bottom: 2px solid #1E88E5; padding-bottom: 10px;">ğŸ“Š å…§å‹¤äººå“¡</h3>';
                
                for (const level of levelOrder) {
                    if (levelGroups.internal[level]) {
                        const chartId = `chart_internal_${level}`;
                        chartsHtml += `
                            <div class="chart-container">
                                <h3 class="chart-title">${level} è·ç­‰å¹´åº¦ç¸¾æ•ˆæ¯”å° (å…§å‹¤)</h3>
                                <canvas id="${chartId}" style="max-height: 400px;"></canvas>
                            </div>
                        `;
                    }
                }
            }
            
            // å¤–å‹¤åœ–è¡¨
            if (hasExternalData) {
                chartsHtml += '<h3 style="margin-top: 30px; margin-bottom: 20px; color: #2d3748; border-bottom: 2px solid #38b2ac; padding-bottom: 10px;">ğŸ“Š å¤–å‹¤äººå“¡</h3>';
                
                for (const level of levelOrder) {
                    if (levelGroups.external[level]) {
                        const chartId = `chart_external_${level}`;
                        chartsHtml += `
                            <div class="chart-container">
                                <h3 class="chart-title">${level} è·ç­‰å¹´åº¦ç¸¾æ•ˆæ¯”å° (å¤–å‹¤)</h3>
                                <canvas id="${chartId}" style="max-height: 400px;"></canvas>
                            </div>
                        `;
                    }
                }
            }
            
            container.innerHTML = chartsHtml;
            
            // æ¸²æŸ“å…§å‹¤åœ–è¡¨
            if (hasInternalData) {
                for (const level of levelOrder) {
                    if (levelGroups.internal[level]) {
                        await renderLevelChart(`internal_${level}`, levelGroups.internal[level], year);
                    }
                }
            }
            
            // æ¸²æŸ“å¤–å‹¤åœ–è¡¨
            if (hasExternalData) {
                for (const level of levelOrder) {
                    if (levelGroups.external[level]) {
                        await renderLevelChart(`external_${level}`, levelGroups.external[level], year);
                    }
                }
            }
        };

        // æ¸²æŸ“è·ç­‰åœ–è¡¨
        async function renderLevelChart(chartKey, employees, year) {
            const chartId = `chart_${chartKey}`;
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // æº–å‚™è³‡æ–™
            const months = [];
            const datasets = [];
            
            // æª¢æŸ¥è©²è·ç­‰çš„å“¡å·¥ä¸­æ˜¯å¦æœ‰ä»»ä½•äººæ˜¯æœˆè€ƒæ ¸
            const hasMonthlyEval = employees.some(emp => emp.evaluationFrequency === 'monthly');
            
            // æ±ºå®šè¦é¡¯ç¤ºå“ªäº›æœˆä»½
            const monthsToShow = hasMonthlyEval ? 
                [1,2,3,4,5,6,7,8,9,10,11,12] : 
                [3,5,9,12];
            
            monthsToShow.forEach(m => months.push(`${m}æœˆ`));
            
            // ç‚ºæ¯å€‹å“¡å·¥å»ºç«‹è³‡æ–™é›†
            const colors = [
                '#1E88E5', '#42A5F5', '#1976D2', '#7dd3fc',
                '#1565C0', '#0c4a6e', '#075985', '#bae6fd',
                '#1976D2', '#42A5F5', '#1565C0', '#7dd3fc'
            ];
            
            for (let i = 0; i < employees.length; i++) {
                const employee = employees[i];
                const scores = [];
                
                // å–å¾—è©²å“¡å·¥æ¯å€‹æœˆçš„åˆ†æ•¸
                for (let m of monthsToShow) {
                    const period = `${year}${String(m).padStart(2, '0')}`;
                    
                    // æª¢æŸ¥è©²å“¡å·¥é€™å€‹æœˆæ˜¯å¦éœ€è¦è©•æ ¸
                    const needsEval = checkNeedsEvaluationByFrequency(employee.evaluationFrequency || 'quarterly', period);
                    
                    if (needsEval) {
                        const employeeScores = await calculateEmployeeScores(employee.userId, period);
                        scores.push(employeeScores ? employeeScores.totalScore.toFixed(1) : null);
                    } else {
                        scores.push(null); // è©²æœˆä¸éœ€è©•æ ¸
                    }
                }
                
                datasets.push({
                    label: employee.name,
                    data: scores,
                    backgroundColor: colors[i % colors.length],
                    borderColor: colors[i % colors.length],
                    borderWidth: 2
                });
            }
            
            // å»ºç«‹åœ–è¡¨
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' åˆ†';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'åˆ†æ•¸'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆä»½'
                            }
                        }
                    }
                }
            });
            
            // åœ¨åœ–è¡¨ä¸‹æ–¹å»ºç«‹åˆ†æ•¸è¡¨æ ¼
            const tableContainer = document.createElement('div');
            tableContainer.style.marginTop = '20px';
            tableContainer.style.overflowX = 'auto';
            
            // ä½¿ç”¨monthsToShowï¼ˆå·²ç¶“åœ¨ä¸Šé¢å®šç¾©å¥½äº†ï¼‰
            const monthNumbers = monthsToShow;
            
            let tableHtml = '<table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            tableHtml += '<thead><tr style="background: #1E88E5; color: white;">';
            tableHtml += '<th style="padding: 12px; border: 1px solid #ddd; text-align: left;">å“¡å·¥å§“å</th>';
            
            for (let i = 0; i < months.length; i++) {
                tableHtml += `<th style="padding: 12px; border: 1px solid #ddd; text-align: center;">${months[i]}<br><span style="font-size: 0.85em;">(å·®ç•°)</span></th>`;
            }
            
            tableHtml += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center; background: #1976D2;">å¹´åº¦å¹³å‡</th>';
            
            tableHtml += '</tr></thead><tbody>';
            
            for (let i = 0; i < employees.length; i++) {
                const employee = employees[i];
                tableHtml += `<tr style="background: ${i % 2 === 0 ? '#F1F8FE' : 'white'};">`;
                tableHtml += `<td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">${employee.name}</td>`;
                
                let previousScore = null;
                const yearScores = []; // æ”¶é›†å¹´åº¦æ‰€æœ‰åˆ†æ•¸
                
                for (let j = 0; j < monthNumbers.length; j++) {
                    const m = monthNumbers[j];
                    const period = `${year}${String(m).padStart(2, '0')}`;
                    
                    // æª¢æŸ¥è©²å“¡å·¥é€™å€‹æœˆæ˜¯å¦éœ€è¦è©•æ ¸
                    const needsEval = checkNeedsEvaluationByFrequency(employee.evaluationFrequency || 'quarterly', period);
                    
                    let cellContent = '-';
                    let diffHtml = '';
                    
                    if (needsEval) {
                        const employeeScores = await calculateEmployeeScores(employee.userId, period);
                        
                        if (employeeScores) {
                            const currentScore = employeeScores.totalScore;
                            yearScores.push(currentScore);
                            cellContent = currentScore.toFixed(1);
                            
                            // è¨ˆç®—èˆ‡ä¸Šæœˆçš„å·®ç•°
                            if (previousScore !== null) {
                                const diff = currentScore - previousScore;
                                const diffColor = diff > 0 ? '#059669' : (diff < 0 ? '#dc2626' : '#6b7280');
                                const diffSign = diff > 0 ? '+' : '';
                                diffHtml = `<div style="color: ${diffColor}; font-size: 0.85em;">${diffSign}${diff.toFixed(1)}</div>`;
                            }
                            previousScore = currentScore;
                        }
                    }
                    
                    tableHtml += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <div style="font-weight: bold;">${cellContent}</div>${diffHtml}
                    </td>`;
                }
                
                // è¨ˆç®—å¹´åº¦å¹³å‡
                let yearAverageHtml = '-';
                if (yearScores.length > 0) {
                    const yearAverage = yearScores.reduce((a, b) => a + b, 0) / yearScores.length;
                    yearAverageHtml = `<strong>${yearAverage.toFixed(1)}</strong>`;
                }
                
                tableHtml += `<td style="padding: 12px; border: 1px solid #ddd; text-align: center; background: #E3F2FD; font-size: 1.1em;">${yearAverageHtml}</td>`;
                
                tableHtml += '</tr>';
            }
            
            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;
            
            // å°‡è¡¨æ ¼æ’å…¥åˆ°åœ–è¡¨ä¸‹æ–¹
            canvas.parentElement.appendChild(tableContainer);
        }

        // é¡¯ç¤ºç®¡ç†å¾Œå°
        window.showAdminPanel = function() {
            renderAdminDashboard();
        };

        // è¿”å›è©•åˆ†é é¢
        window.backToEvaluation = function() {
            renderEvaluatorDashboard();
        };

        // ç™»å‡º
        window.logout = function() {
            currentUser = null;
            renderLogin();
        };

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // å•Ÿå‹•ç³»çµ±
        initSystem();
    </script>
</body>
</html>
