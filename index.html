<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è€ƒæ ¸ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            text-align: right;
        }

        .user-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .login-container {
            padding: 60px;
            max-width: 500px;
            margin: 100px auto;
        }

        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background-color: #ffffff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #a0aec0;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #718096;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .employee-card {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .employee-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .employee-card.disabled {
            background: #f7fafc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .employee-card.submitted {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .evaluation-form {
            max-width: 900px;
            margin: 0 auto;
        }

        .category-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .category-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            align-items: start;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .item-name {
            font-weight: bold;
            color: #2d3748;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding-top: 8px;
        }

        .score-input {
            text-align: center;
        }

        .score-input input {
            width: 80px;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: bold;
        }

        table tr:hover {
            background: #f7fafc;
        }

        .score-positive {
            color: #48bb78;
            font-weight: bold;
        }

        .score-negative-light {
            color: #ed8936;
            font-weight: bold;
        }

        .score-negative-heavy {
            color: #f56565;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #a0aec0;
        }

        .close-modal:hover {
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #f0fff4;
            border: 1px solid #48bb78;
            color: #22543d;
        }

        .alert-error {
            background: #fff5f5;
            border: 1px solid #f56565;
            color: #742a2a;
        }

        .alert-info {
            background: #ebf8ff;
            border: 1px solid #4299e1;
            color: #2c5282;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .chart-container {
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3em;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCz__a2mqHuKtI8-magMdCG_35mHITa-To",
            authDomain: "kpi-system-76380260.firebaseapp.com",
            projectId: "kpi-system-76380260",
            storageBucket: "kpi-system-76380260.firebasestorage.app",
            messagingSenderId: "243808614082",
            appId: "1:243808614082:web:7cfc400d9b2d4c3379ad5b"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å…¨åŸŸç‹€æ…‹
        let currentUser = null;
        let currentPage = 'login';

        // åˆå§‹åŒ–ç³»çµ±
        async function initSystem() {
            // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­ç®¡ç†å“¡å¸³è™Ÿ
            const adminDoc = await getDoc(doc(db, 'users', 'Admin01'));
            if (!adminDoc.exists()) {
                // å»ºç«‹é è¨­ç®¡ç†å“¡å¸³è™Ÿ
                await setDoc(doc(db, 'users', 'Admin01'), {
                    userId: 'Admin01',
                    name: 'ç³»çµ±ç®¡ç†å“¡',
                    password: '76380260',
                    level: 'L5',
                    role: 'admin',
                    evaluators: []
                });
            }
            renderLogin();
        }

        // æ¸²æŸ“ç™»å…¥é é¢
        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>å“¡å·¥è€ƒæ ¸ç³»çµ±</h1>
                    </div>
                    <div class="login-container">
                        <h2>ç³»çµ±ç™»å…¥</h2>
                        <div id="loginMessage"></div>
                        <form id="loginForm">
                            <div class="form-group">
                                <label>å¸³è™Ÿ</label>
                                <select id="loginUserId" required>
                                    <option value="">è«‹é¸æ“‡å¸³è™Ÿ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å¯†ç¢¼</label>
                                <input type="password" id="loginPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å…¥</button>
                        </form>
                    </div>
                </div>
            `;

            loadUsers();

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        async function loadUsers() {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const select = document.getElementById('loginUserId');
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // åªé¡¯ç¤ºå¯ä»¥ç™»å…¥çš„ä½¿ç”¨è€…(æ’é™¤ä¸€èˆ¬è·å“¡)
                if (user.role !== 'employee') {
                    const option = document.createElement('option');
                    option.value = user.userId;
                    option.textContent = `${user.name} (${user.userId})`;
                    select.appendChild(option);
                }
            });
        }

        // è™•ç†ç™»å…¥
        async function handleLogin(e) {
            e.preventDefault();
            const userId = document.getElementById('loginUserId').value;
            const password = document.getElementById('loginPassword').value;

            const userDoc = await getDoc(doc(db, 'users', userId));
            
            if (!userDoc.exists()) {
                showMessage('loginMessage', 'å¸³è™Ÿä¸å­˜åœ¨', 'error');
                return;
            }

            const userData = userDoc.data();
            
            if (userData.password !== password) {
                showMessage('loginMessage', 'å¯†ç¢¼éŒ¯èª¤', 'error');
                return;
            }

            currentUser = userData;
            
            if (userData.role === 'admin') {
                renderAdminDashboard();
            } else {
                renderEvaluatorDashboard();
            }
        }

        // æ¸²æŸ“è©•åˆ†è€…å„€è¡¨æ¿
        function renderEvaluatorDashboard() {
            const app = document.getElementById('app');
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>è©•åˆ†ç³»çµ±</h1>
                        <div class="user-info">
                            <div class="user-name">${currentUser.name}</div>
                            ${currentUser.role === 'manager' ? '<button class="btn btn-secondary" onclick="window.showAdminPanel()">ç®¡ç†å¾Œå°</button>' : ''}
                            <button class="btn btn-secondary" onclick="window.logout()">ç™»å‡º</button>
                        </div>
                    </div>
                    <div class="content">
                        <h2>æœ¬æœˆè©•æ ¸äººå“¡ (${currentMonth.slice(0,4)}å¹´${currentMonth.slice(4)}æœˆ)</h2>
                        <div id="employeeList" class="employee-grid">
                            <div class="loading">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            `;

            loadEvaluationList();
        }

        // è¼‰å…¥è©•æ ¸äººå“¡åˆ—è¡¨
        async function loadEvaluationList() {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            const employeeListDiv = document.getElementById('employeeList');
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const employees = [];
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // æª¢æŸ¥ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦æ˜¯é€™å€‹å“¡å·¥çš„è©•æ ¸è€…
                if (user.evaluators && user.evaluators.includes(currentUser.userId)) {
                    // æª¢æŸ¥æ˜¯å¦éœ€è¦æœ¬æœˆè©•æ ¸
                    const needsEvaluation = checkNeedsEvaluation(user.level, currentMonth);
                    if (needsEvaluation) {
                        employees.push(user);
                    }
                }
            });

            if (employees.length === 0) {
                employeeListDiv.innerHTML = '<p style="text-align: center; color: #a0aec0;">æœ¬æœˆç„¡éœ€è©•æ ¸äººå“¡</p>';
                return;
            }

            let html = '';
            for (const employee of employees) {
                const evaluationId = `${employee.userId}_${currentUser.userId}_${currentMonth}`;
                const evalDoc = await getDoc(doc(db, 'evaluations', evaluationId));
                const status = evalDoc.exists() ? evalDoc.data().status : 'pending';
                
                const cardClass = status === 'submitted' ? 'employee-card submitted' : 'employee-card';
                const statusText = status === 'submitted' ? 'âœ“ å·²é€å‡º' : 'å¾…è©•åˆ†';
                
                html += `
                    <div class="${cardClass}" onclick="window.openEvaluation('${employee.userId}', '${status}')">
                        <h3>${employee.name}</h3>
                        <p>${employee.level}</p>
                        <p style="margin-top: 10px; color: ${status === 'submitted' ? '#48bb78' : '#ed8936'};">
                            ${statusText}
                        </p>
                    </div>
                `;
            }
            
            employeeListDiv.innerHTML = html;
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦è©•æ ¸
        function checkNeedsEvaluation(level, month) {
            // L5 æˆ–ç„¡è·ç­‰ä¸éœ€è©•æ ¸
            if (!level || level === 'L5' || level === '') {
                return false;
            }
            
            const monthNum = parseInt(month.slice(4));
            
            if (level === 'L1') {
                return true; // æ¯æœˆè©•æ ¸
            } else if (['L2', 'L3', 'L4'].includes(level)) {
                return [3, 5, 9, 12].includes(monthNum); // å­£è©•æ ¸(é…åˆä¸‰ç¯€çé‡‘)
            }
            
            return false;
        }

        // é–‹å•Ÿè©•åˆ†è¡¨
        window.openEvaluation = async function(employeeId, status) {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            const evaluationId = `${employeeId}_${currentUser.userId}_${currentMonth}`;
            
            // å–å¾—å“¡å·¥è³‡æ–™
            const employeeDoc = await getDoc(doc(db, 'users', employeeId));
            const employee = employeeDoc.data();
            
            // å–å¾—è©•åˆ†è¡¨ç¯„æœ¬
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', `${employeeId}_${currentMonth}`));
            
            if (!templateDoc.exists()) {
                alert('æ­¤å“¡å·¥å°šæœªè¨­å®šè©•åˆ†è¡¨ç¯„æœ¬ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
                return;
            }
            
            const template = templateDoc.data();
            
            // å–å¾—å·²å„²å­˜çš„è©•åˆ†
            const evalDoc = await getDoc(doc(db, 'evaluations', evaluationId));
            const savedScores = evalDoc.exists() ? evalDoc.data().scores : {};
            const savedComment = evalDoc.exists() ? evalDoc.data().comment : '';
            const isSubmitted = status === 'submitted';
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>${employee.name} - ${currentMonth.slice(0,4)}å¹´${currentMonth.slice(4)}æœˆè©•æ ¸</h2>
                    <div id="evaluationMessage"></div>
                    <form id="evaluationForm">
                        ${renderEvaluationForm(template, savedScores, isSubmitted)}
                        
                        <div class="form-group">
                            <label>ç¸½è©•èª</label>
                            <textarea id="comment" rows="4" ${isSubmitted ? 'disabled' : ''}>${savedComment}</textarea>
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px;">
                            ${!isSubmitted ? `
                                <button type="button" class="btn btn-secondary" onclick="window.saveEvaluationDraft('${evaluationId}', '${employeeId}')">æš«å­˜</button>
                                <button type="button" class="btn btn-success" onclick="window.submitEvaluation('${evaluationId}', '${employeeId}')">ç¢ºèªé€å‡º</button>
                            ` : `
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">é—œé–‰</button>
                            `}
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // æ¸²æŸ“è©•åˆ†è¡¨å–®
        function renderEvaluationForm(template, savedScores, isDisabled) {
            let html = '';
            
            // å·¥ä½œè¡¨ç¾
            if (template.workPerformance) {
                html += '<div class="category-section"><h3 class="category-title">å·¥ä½œè¡¨ç¾</h3>';
                template.workPerformance.forEach((category, catIndex) => {
                    html += `<h4 style="margin: 15px 0 10px 0;">${category.name} (ä½”æ¯”: ${category.weight}%)</h4>`;
                    category.items.forEach((item, itemIndex) => {
                        const itemKey = `work_${catIndex}_${itemIndex}`;
                        const score1 = savedScores[`${itemKey}_1`] || '';
                        const score2 = savedScores[`${itemKey}_2`] || '';
                        
                        html += `
                            <div class="item-row">
                                <div class="item-name">${item}</div>
                                <div class="score-input">
                                    <label>åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§</label>
                                    <input type="number" name="${itemKey}_1" min="0" max="5" step="0.1" value="${score1}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                </div>
                                <div class="score-input">
                                    <label>éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§</label>
                                    <input type="number" name="${itemKey}_2" min="0" max="5" step="0.1" value="${score2}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                </div>
                            </div>
                        `;
                    });
                });
                html += '</div>';
            }
            
            // ç¶œåˆè¡¨ç¾
            if (template.comprehensivePerformance) {
                html += '<div class="category-section"><h3 class="category-title">ç¶œåˆè¡¨ç¾</h3>';
                template.comprehensivePerformance.forEach((category, catIndex) => {
                    html += `<h4 style="margin: 15px 0 10px 0;">${category.name} (ä½”æ¯”: ${category.weight}%)</h4>`;
                    category.items.forEach((item, itemIndex) => {
                        const itemKey = `comp_${catIndex}_${itemIndex}`;
                        const score1 = savedScores[`${itemKey}_1`] || '';
                        const score2 = savedScores[`${itemKey}_2`] || '';
                        
                        html += `
                            <div class="item-row">
                                <div class="item-name">${item}</div>
                                <div class="score-input">
                                    <label>åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§</label>
                                    <input type="number" name="${itemKey}_1" min="0" max="5" step="0.1" value="${score1}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                </div>
                                <div class="score-input">
                                    <label>éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§</label>
                                    <input type="number" name="${itemKey}_2" min="0" max="5" step="0.1" value="${score2}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                                </div>
                            </div>
                        `;
                    });
                });
                html += '</div>';
            }
            
            // å€‹äººå­¸ç¿’
            if (template.personalLearning) {
                html += '<div class="category-section"><h3 class="category-title">å€‹äººå­¸ç¿’</h3>';
                template.personalLearning.items.forEach((item, itemIndex) => {
                    const itemKey = `learn_${itemIndex}`;
                    const score1 = savedScores[`${itemKey}_1`] || '';
                    const score2 = savedScores[`${itemKey}_2`] || '';
                    
                    html += `
                        <div class="item-row">
                            <div class="item-name">${item}</div>
                            <div class="score-input">
                                <label>åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§</label>
                                <input type="number" name="${itemKey}_1" min="0" max="5" step="0.1" value="${score1}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                            </div>
                            <div class="score-input">
                                <label>éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§</label>
                                <input type="number" name="${itemKey}_2" min="0" max="5" step="0.1" value="${score2}" ${isDisabled ? 'disabled' : ''} oninput="window.validateScore(this)">
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            return html;
        }

        // å„²å­˜è©•åˆ†è‰ç¨¿
        window.saveEvaluationDraft = async function(evaluationId, employeeId) {
            // é©—è­‰åˆ†æ•¸
            if (!validateAllScores()) {
                alert('è©•åˆ†ä¸å¯è¶…é 5 åˆ†!è«‹æª¢æŸ¥æ‰€æœ‰è©•åˆ†æ¬„ä½ã€‚');
                return;
            }
            
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            const form = document.getElementById('evaluationForm');
            const formData = new FormData(form);
            const scores = {};
            
            for (let [key, value] of formData.entries()) {
                if (key !== 'comment') {
                    scores[key] = value;
                }
            }
            
            const comment = document.getElementById('comment').value;
            
            await setDoc(doc(db, 'evaluations', evaluationId), {
                evaluationId: evaluationId,
                evaluateeId: employeeId,
                evaluatorId: currentUser.userId,
                period: currentMonth,
                status: 'draft',
                scores: scores,
                comment: comment,
                updatedAt: new Date().toISOString()
            });
            
            showMessage('evaluationMessage', 'å·²å„²å­˜è‰ç¨¿', 'success');
        };

        // é€å‡ºè©•åˆ†
        window.submitEvaluation = async function(evaluationId, employeeId) {
            // é©—è­‰åˆ†æ•¸
            if (!validateAllScores()) {
                alert('è©•åˆ†ä¸å¯è¶…é 5 åˆ†!è«‹æª¢æŸ¥æ‰€æœ‰è©•åˆ†æ¬„ä½ã€‚');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦é€å‡ºè©•åˆ†å—?é€å‡ºå¾Œå°‡ç„¡æ³•ä¿®æ”¹!')) {
                return;
            }
            
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '');
            const form = document.getElementById('evaluationForm');
            const formData = new FormData(form);
            const scores = {};
            
            for (let [key, value] of formData.entries()) {
                if (key !== 'comment') {
                    scores[key] = value;
                }
            }
            
            const comment = document.getElementById('comment').value;
            
            await setDoc(doc(db, 'evaluations', evaluationId), {
                evaluationId: evaluationId,
                evaluateeId: employeeId,
                evaluatorId: currentUser.userId,
                period: currentMonth,
                status: 'submitted',
                scores: scores,
                comment: comment,
                submittedAt: new Date().toISOString()
            });
            
            alert('è©•åˆ†å·²é€å‡º!');
            document.querySelector('.modal').remove();
            loadEvaluationList();
        };

        // é©—è­‰æ‰€æœ‰è©•åˆ†ä¸è¶…é5åˆ†
        function validateAllScores() {
            const form = document.getElementById('evaluationForm');
            if (!form) return true;
            
            const inputs = form.querySelectorAll('input[type="number"]');
            for (let input of inputs) {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 5) {
                    input.style.borderColor = '#f56565';
                    return false;
                }
            }
            return true;
        }

        // å³æ™‚é©—è­‰å–®ä¸€è©•åˆ†æ¬„ä½
        window.validateScore = function(input) {
            const value = parseFloat(input.value);
            if (!isNaN(value) && value > 5) {
                input.style.borderColor = '#f56565';
                input.style.backgroundColor = '#fff5f5';
            } else {
                input.style.borderColor = '#cbd5e0';
                input.style.backgroundColor = '#ffffff';
            }
        };

        // æ¸²æŸ“ç®¡ç†å“¡å„€è¡¨æ¿
        function renderAdminDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>ç®¡ç†å¾Œå°</h1>
                        <div class="user-info">
                            <div class="user-name">${currentUser.name}</div>
                            ${currentUser.role === 'manager' ? '<button class="btn btn-secondary" onclick="window.backToEvaluation()">è¿”å›è©•åˆ†é é¢</button>' : ''}
                            <button class="btn btn-secondary" onclick="window.logout()">ç™»å‡º</button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="tabs">
                            <button class="tab active" onclick="window.switchTab(0)">äººå“¡ç®¡ç†</button>
                            <button class="tab" onclick="window.switchTab(1)">è€ƒæ ¸çµ±è¨ˆè¡¨</button>
                            <button class="tab" onclick="window.switchTab(2)">è·ç­‰æ¯”å°åœ–è¡¨</button>
                            <button class="tab" onclick="window.switchTab(3)">ç·¨è¼¯è€ƒæ ¸è¡¨</button>
                        </div>
                        
                        <div id="tab0" class="tab-content active">
                            ${renderUserManagement()}
                        </div>
                        <div id="tab1" class="tab-content">
                            <h2>è€ƒæ ¸çµ±è¨ˆè¡¨</h2>
                            <div class="form-group" style="max-width: 400px;">
                                <label>é¸æ“‡æœˆä»½</label>
                                <input type="month" id="statsMonth" onchange="window.loadStatistics()">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <button class="btn btn-primary" onclick="window.downloadCSV()">ğŸ“¥ ä¸‹è¼‰è©•åˆ†æ˜ç´° CSV</button>
                            </div>
                            <div id="statisticsContainer">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                        <div id="tab2" class="tab-content">
                            <h2>è·ç­‰æ¯”å°åœ–è¡¨</h2>
                            <div class="form-group" style="max-width: 400px;">
                                <label>é¸æ“‡å¹´åº¦</label>
                                <input type="number" id="chartYear" min="2020" max="2099" onchange="window.loadCharts()">
                            </div>
                            <div id="chartsContainer">
                                <div class="loading">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>
                        <div id="tab3" class="tab-content">
                            ${renderTemplateEditor()}
                        </div>
                    </div>
                </div>
            `;
            
            loadUsersList();
            loadTemplateEmployees();
            
            // è¨­å®šç•¶å‰æœˆä»½ä¸¦è‡ªå‹•è¼‰å…¥çµ±è¨ˆè³‡æ–™
            const currentMonth = new Date().toISOString().slice(0, 7);
            const statsMonthInput = document.getElementById('statsMonth');
            if (statsMonthInput) {
                statsMonthInput.value = currentMonth;
                window.loadStatistics();
            }
            
            // è¨­å®šç•¶å‰å¹´åº¦ä¸¦è‡ªå‹•è¼‰å…¥åœ–è¡¨
            const currentYear = new Date().getFullYear();
            const chartYearInput = document.getElementById('chartYear');
            if (chartYearInput) {
                chartYearInput.value = currentYear;
                window.loadCharts();
            }
        }

        // åˆ‡æ›åˆ†é 
        window.switchTab = function(index) {
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        };

        // æ¸²æŸ“ä½¿ç”¨è€…ç®¡ç†
        function renderUserManagement() {
            return `
                <h2>äººå“¡ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="window.showAddUserModal()">æ–°å¢äººå“¡</button>
                <div id="usersList" style="margin-top: 20px;">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            `;
        }

        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        async function loadUsersList() {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const usersListDiv = document.getElementById('usersList');
            
            // å»ºç«‹ä½¿ç”¨è€…å°ç…§è¡¨
            const usersMap = {};
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                usersMap[user.userId] = user.name;
            });
            
            let html = '<table><thead><tr><th>å¸³è™Ÿ</th><th>å§“å</th><th>è·ç­‰</th><th>è§’è‰²</th><th>æ‰€å±¬ä¸»ç®¡</th><th>æ“ä½œ</th></tr></thead><tbody>';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const roleText = user.role === 'admin' ? 'ç³»çµ±ç®¡ç†å“¡' : 
                                user.role === 'manager' ? 'ç®¡ç†è·ä¸»ç®¡' : 
                                user.role === 'staff' ? 'ä¸€èˆ¬ä¸»ç®¡' : 'ä¸€èˆ¬è·å“¡';
                const levelText = user.level || 'ç„¡';
                
                // å–å¾—æ‰€å±¬ä¸»ç®¡åç¨±
                let evaluatorsText = 'ç„¡';
                if (user.evaluators && user.evaluators.length > 0) {
                    evaluatorsText = user.evaluators.map(id => usersMap[id] || id).join(', ');
                }
                
                html += `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${user.name}</td>
                        <td>${levelText}</td>
                        <td>${roleText}</td>
                        <td>${evaluatorsText}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="window.editUser('${user.userId}')">ç·¨è¼¯</button>
                            ${user.userId !== 'Admin01' ? `<button class="btn btn-danger" onclick="window.deleteUser('${user.userId}')">åˆªé™¤</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            usersListDiv.innerHTML = html;
        }

        // é¡¯ç¤ºæ–°å¢ä½¿ç”¨è€…å°è©±æ¡†
        window.showAddUserModal = async function() {
            // è¼‰å…¥æ‰€æœ‰ä¸»ç®¡åˆ—è¡¨
            const usersSnapshot = await getDocs(collection(db, 'users'));
            let managersOptions = '';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                if (user.role === 'manager' || user.role === 'staff') {
                    managersOptions += `<option value="${user.userId}">${user.name} (${user.userId})</option>`;
                }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>æ–°å¢äººå“¡</h2>
                    <div id="addUserMessage"></div>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label>å¸³è™Ÿ (è‹±æ–‡æˆ–æ•¸å­—)</label>
                            <input type="text" id="newUserId" required>
                        </div>
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" id="newUserName" required>
                        </div>
                        <div class="form-group">
                            <label>å¯†ç¢¼</label>
                            <input type="password" id="newUserPassword" required>
                        </div>
                        <div class="form-group">
                            <label>è·ç­‰</label>
                            <select id="newUserLevel">
                                <option value="">ç„¡è·ç­‰(ä¸éœ€è©•æ ¸)</option>
                                <option value="L1">L1 (æ¯æœˆè©•æ ¸)</option>
                                <option value="L2">L2 (å­£è©•æ ¸)</option>
                                <option value="L3">L3 (å­£è©•æ ¸)</option>
                                <option value="L4">L4 (å­£è©•æ ¸)</option>
                                <option value="L5">L5 (ä¸éœ€è©•æ ¸)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²</label>
                            <select id="newUserRole" required>
                                <option value="employee">ä¸€èˆ¬è·å“¡ (ç„¡æ³•ç™»å…¥ç³»çµ±)</option>
                                <option value="staff">ä¸€èˆ¬ä¸»ç®¡ (å¯è©•åˆ†)</option>
                                <option value="manager">ç®¡ç†è·ä¸»ç®¡ (å¯è©•åˆ†+å¯æŸ¥çœ‹å¾Œå°)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±¬ä¸»ç®¡ (å¯è¤‡é¸,æŒ‰ä½ Ctrl æˆ– Command éµå¤šé¸)</label>
                            <select id="newUserEvaluators" multiple size="6" style="height: auto;">
                                ${managersOptions}
                            </select>
                            <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                å¦‚æœæ­¤äººå“¡éœ€è¦æ¥å—è©•æ ¸,è«‹é¸æ“‡è©•æ ¸ä¸»ç®¡<br>
                                æŒ‰ä½ Ctrl (Windows) æˆ– Command (Mac) å¯å¤šé¸
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary">æ–°å¢</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userId = document.getElementById('newUserId').value;
                const name = document.getElementById('newUserName').value;
                const password = document.getElementById('newUserPassword').value;
                const level = document.getElementById('newUserLevel').value;
                const role = document.getElementById('newUserRole').value;
                
                // å–å¾—æ‰€é¸çš„ä¸»ç®¡
                const evaluatorsSelect = document.getElementById('newUserEvaluators');
                const evaluators = Array.from(evaluatorsSelect.selectedOptions).map(option => option.value);
                
                // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å·²å­˜åœ¨
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    showMessage('addUserMessage', 'å¸³è™Ÿå·²å­˜åœ¨', 'error');
                    return;
                }
                
                await setDoc(doc(db, 'users', userId), {
                    userId: userId,
                    name: name,
                    password: password,
                    level: level || 'L5',
                    role: role,
                    evaluators: evaluators
                });
                
                alert('äººå“¡æ–°å¢æˆåŠŸ!');
                modal.remove();
                loadUsersList();
            });
        };

        // æ¸²æŸ“è©•åˆ†è¡¨ç·¨è¼¯å™¨
        function renderTemplateEditor() {
            const isAdmin = currentUser.role === 'admin';
            const modeText = isAdmin ? 'ç·¨è¼¯' : 'æŸ¥çœ‹';
            
            return `
                <h2>${modeText}å“¡å·¥è€ƒæ ¸è¡¨</h2>
                ${!isAdmin ? '<p style="color: #ed8936; background: #fffaf0; padding: 10px; border-radius: 5px; margin-bottom: 20px;">âš ï¸ æ‚¨åªæœ‰æŸ¥çœ‹æ¬Šé™,ç„¡æ³•ç·¨è¼¯è€ƒæ ¸è¡¨ç¯„æœ¬</p>' : ''}
                <div class="form-group">
                    <label>é¸æ“‡å“¡å·¥</label>
                    <select id="templateEmployee" onchange="window.loadTemplate()">
                        <option value="">è«‹é¸æ“‡å“¡å·¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¸æ“‡æœˆä»½</label>
                    <input type="month" id="templateMonth" onchange="window.loadTemplate()">
                </div>
                ${isAdmin ? `
                <div style="margin-bottom: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="window.copyPreviousMonthTemplate()">ğŸ“‹ è¤‡è£½ä¸Šæœˆç¯„æœ¬</button>
                    <button type="button" class="btn btn-danger" onclick="window.clearTemplate()">ğŸ—‘ï¸ æ¸…ç©ºç¯„æœ¬</button>
                </div>
                ` : ''}
                <div id="templateEditor">
                    <p style="color: #a0aec0;">è«‹é¸æ“‡å“¡å·¥å’Œæœˆä»½</p>
                </div>
            `;
        }

        // è¼‰å…¥è©•åˆ†è¡¨ç¯„æœ¬å“¡å·¥åˆ—è¡¨
        async function loadTemplateEmployees() {
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const select = document.getElementById('templateEmployee');
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            select.innerHTML = '<option value="">è«‹é¸æ“‡å“¡å·¥</option>';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // åªé¡¯ç¤ºéœ€è¦è©•æ ¸çš„å“¡å·¥(æœ‰è·ç­‰ä¸”ä¸æ˜¯L5)
                if (user.level && user.level !== 'L5' && user.level !== '') {
                    const option = document.createElement('option');
                    option.value = user.userId;
                    option.textContent = `${user.name} (${user.userId}) - ${user.level}`;
                    select.appendChild(option);
                }
            });
        }

        // è¼‰å…¥è©•åˆ†è¡¨ç¯„æœ¬
        window.loadTemplate = async function() {
            const employeeId = document.getElementById('templateEmployee').value;
            const month = document.getElementById('templateMonth').value;
            
            if (!employeeId || !month) {
                return;
            }
            
            const period = month.replace('-', '');
            const templateId = `${employeeId}_${period}`;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è©•åˆ†è¨˜éŒ„
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period)
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            const hasEvaluations = !evaluationsSnapshot.empty;
            
            // å¦‚æœæœ‰è©•åˆ†è¨˜éŒ„,é¡¯ç¤ºè­¦å‘Š
            let evaluationWarning = '';
            if (hasEvaluations) {
                const evaluatorsList = [];
                evaluationsSnapshot.forEach(doc => {
                    const evaluation = doc.data();
                    evaluatorsList.push({
                        evaluatorId: evaluation.evaluatorId,
                        status: evaluation.status
                    });
                });
                
                // å–å¾—ä¸»ç®¡åç¨±
                const evaluatorNames = [];
                for (const ev of evaluatorsList) {
                    const userDoc = await getDoc(doc(db, 'users', ev.evaluatorId));
                    if (userDoc.exists()) {
                        const statusText = ev.status === 'submitted' ? 'å·²é€å‡º' : 'è‰ç¨¿';
                        evaluatorNames.push(`${userDoc.data().name} (${statusText})`);
                    }
                }
                
                evaluationWarning = `
                    <div style="background: #fff5f5; border: 2px solid #f56565; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #c53030; margin-bottom: 10px;">âš ï¸ ç¯„æœ¬å·²é–å®š</h3>
                        <p style="color: #742a2a; margin-bottom: 10px;">
                            <strong>åŸå› :</strong> ä»¥ä¸‹ä¸»ç®¡å·²é–‹å§‹è©•åˆ†,ç‚ºé¿å…è³‡æ–™éŒ¯èª¤,ç¯„æœ¬å·²é–å®šç„¡æ³•ç·¨è¼¯:
                        </p>
                        <ul style="color: #742a2a; margin-left: 20px;">
                            ${evaluatorNames.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                        <p style="color: #742a2a; margin-top: 10px;">
                            è‹¥éœ€ä¿®æ”¹ç¯„æœ¬,è«‹å…ˆä½¿ç”¨ã€Œé€€å–®ã€åŠŸèƒ½æ¸…ç©ºæ‰€æœ‰è©•åˆ†è¨˜éŒ„ã€‚
                        </p>
                        ${currentUser.role === 'admin' ? `
                        <button type="button" class="btn btn-danger" onclick="window.forceUnlockTemplate('${employeeId}', '${period}')" style="margin-top: 10px;">
                            ğŸ”“ å¼·åˆ¶è§£é– (æœƒæ¸…ç©ºæ‰€æœ‰è©•åˆ†è¨˜éŒ„)
                        </button>
                        ` : ''}
                    </div>
                `;
            }
            
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
            
            if (templateDoc.exists()) {
                // è¼‰å…¥ç¾æœ‰ç¯„æœ¬
                const template = templateDoc.data();
                renderTemplateForm(template, employeeId, period, hasEvaluations, evaluationWarning);
            } else {
                // å»ºç«‹æ–°ç¯„æœ¬
                renderTemplateForm({
                    workPerformance: [],
                    comprehensivePerformance: [],
                    personalLearning: { weight: 0, items: [] }
                }, employeeId, period, hasEvaluations, evaluationWarning);
            }
        };

        // å¼·åˆ¶è§£é–ç¯„æœ¬
        window.forceUnlockTemplate = async function(employeeId, period) {
            if (!confirm('âš ï¸ è­¦å‘Š!\n\nå¼·åˆ¶è§£é–æœƒåˆªé™¤æ‰€æœ‰ä¸»ç®¡å°æ­¤å“¡å·¥æœ¬æœˆçš„è©•åˆ†è¨˜éŒ„!\n\né€™å€‹å‹•ä½œç„¡æ³•å¾©åŸ,ç¢ºå®šè¦ç¹¼çºŒå—?')) {
                return;
            }
            
            if (!confirm('å†æ¬¡ç¢ºèª:\n\næ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è©•åˆ†è¨˜éŒ„ä¸¦è§£é–ç¯„æœ¬å—?')) {
                return;
            }
            
            // åˆªé™¤æ‰€æœ‰è©•åˆ†è¨˜éŒ„
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period)
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            for (const evalDoc of evaluationsSnapshot.docs) {
                await deleteDoc(doc(db, 'evaluations', evalDoc.id));
            }
            
            alert('å·²æ¸…ç©ºæ‰€æœ‰è©•åˆ†è¨˜éŒ„,ç¯„æœ¬å·²è§£é–!');
            window.loadTemplate();
        };

        // æ¸²æŸ“ç¯„æœ¬ç·¨è¼¯è¡¨å–®
        function renderTemplateForm(template, employeeId, period, isLocked = false, lockWarning = '') {
            const editorDiv = document.getElementById('templateEditor');
            const isAdmin = currentUser.role === 'admin';
            const canEdit = isAdmin && !isLocked; // åªæœ‰ç®¡ç†å“¡ä¸”æœªé–å®šæ‰èƒ½ç·¨è¼¯
            const disabled = !canEdit ? 'disabled' : '';
            
            editorDiv.innerHTML = `
                ${lockWarning}
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>å·¥ä½œè¡¨ç¾</h3>
                    <div id="workPerformanceCategories"></div>
                    ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addWorkCategory()">æ–°å¢å¤§é¡</button>' : ''}
                    
                    <h3 style="margin-top: 30px;">ç¶œåˆè¡¨ç¾</h3>
                    <div id="comprehensivePerformanceCategories"></div>
                    ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addCompCategory()">æ–°å¢å¤§é¡</button>' : ''}
                    
                    <h3 style="margin-top: 30px;">å€‹äººå­¸ç¿’</h3>
                    <div class="form-group">
                        <label>ä½”æ¯” (%)</label>
                        <input type="number" id="learningWeight" value="${template.personalLearning.weight || 0}" min="0" max="100" ${disabled}>
                    </div>
                    <div id="learningItems"></div>
                    ${canEdit ? '<button type="button" class="btn btn-primary" onclick="window.addLearningItem()">æ–°å¢å­¸ç¿’é …ç›®</button>' : ''}
                    
                    ${canEdit ? `
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn btn-success" onclick="window.saveTemplate('${employeeId}', '${period}')">å„²å­˜ç¯„æœ¬</button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // å„²å­˜ç•¶å‰ç¯„æœ¬åˆ°å…¨åŸŸè®Šæ•¸
            window.currentTemplate = template;
            window.currentTemplateLocked = isLocked;
            
            // æ¸²æŸ“ç¾æœ‰è³‡æ–™
            renderWorkCategories();
            renderCompCategories();
            renderLearningItems();
        }

        // æ¸²æŸ“å·¥ä½œè¡¨ç¾å¤§é¡
        function renderWorkCategories() {
            const container = document.getElementById('workPerformanceCategories');
            const categories = window.currentTemplate.workPerformance || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            categories.forEach((cat, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" value="${cat.name}" onchange="window.updateWorkCategoryName(${index}, this.value)" 
                                   style="flex: 1; margin-right: 10px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            <input type="number" value="${cat.weight}" onchange="window.updateWorkCategoryWeight(${index}, this.value)" 
                                   placeholder="ä½”æ¯”%" min="0" max="100" style="width: 80px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeWorkCategory(${index})" style="margin-left: 10px;">åˆªé™¤å¤§é¡</button>` : ''}
                        </div>
                        <div>
                            ${cat.items.map((item, itemIndex) => `
                                <div style="display: flex; margin-bottom: 5px;">
                                    <textarea onchange="window.updateWorkItem(${index}, ${itemIndex}, this.value)"
                                           style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                                    ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeWorkItem(${index}, ${itemIndex})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                                </div>
                            `).join('')}
                            ${canEdit ? `<button type="button" class="btn btn-secondary" onclick="window.addWorkItem(${index})">æ–°å¢å°é …</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“ç¶œåˆè¡¨ç¾å¤§é¡
        function renderCompCategories() {
            const container = document.getElementById('comprehensivePerformanceCategories');
            const categories = window.currentTemplate.comprehensivePerformance || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            categories.forEach((cat, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" value="${cat.name}" onchange="window.updateCompCategoryName(${index}, this.value)" 
                                   style="flex: 1; margin-right: 10px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            <input type="number" value="${cat.weight}" onchange="window.updateCompCategoryWeight(${index}, this.value)" 
                                   placeholder="ä½”æ¯”%" min="0" max="100" style="width: 80px; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px;" ${disabled}>
                            ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeCompCategory(${index})" style="margin-left: 10px;">åˆªé™¤å¤§é¡</button>` : ''}
                        </div>
                        <div>
                            ${cat.items.map((item, itemIndex) => `
                                <div style="display: flex; margin-bottom: 5px;">
                                    <textarea onchange="window.updateCompItem(${index}, ${itemIndex}, this.value)"
                                           style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                                    ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeCompItem(${index}, ${itemIndex})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                                </div>
                            `).join('')}
                            ${canEdit ? `<button type="button" class="btn btn-secondary" onclick="window.addCompItem(${index})">æ–°å¢å°é …</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“å€‹äººå­¸ç¿’é …ç›®
        function renderLearningItems() {
            const container = document.getElementById('learningItems');
            const items = window.currentTemplate.personalLearning.items || [];
            const isAdmin = currentUser.role === 'admin';
            const isLocked = window.currentTemplateLocked || false;
            const canEdit = isAdmin && !isLocked;
            const disabled = !canEdit ? 'disabled' : '';
            
            let html = '';
            items.forEach((item, index) => {
                html += `
                    <div style="display: flex; margin-bottom: 10px;">
                        <textarea onchange="window.updateLearningItem(${index}, this.value)"
                               style="flex: 1; padding: 8px; border: 2px solid #cbd5e0; border-radius: 5px; margin-right: 5px; min-height: 60px; resize: vertical; font-family: inherit;" ${disabled}>${item}</textarea>
                        ${canEdit ? `<button type="button" class="btn btn-danger" onclick="window.removeLearningItem(${index})" style="align-self: flex-start;">åˆªé™¤</button>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // å·¥ä½œè¡¨ç¾ç›¸é—œå‡½æ•¸
        window.addWorkCategory = function() {
            if (!window.currentTemplate.workPerformance) {
                window.currentTemplate.workPerformance = [];
            }
            window.currentTemplate.workPerformance.push({ name: 'æ–°å¤§é¡', weight: 0, items: [] });
            renderWorkCategories();
        };

        window.removeWorkCategory = function(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é¡å—?')) {
                window.currentTemplate.workPerformance.splice(index, 1);
                renderWorkCategories();
            }
        };

        window.updateWorkCategoryName = function(index, value) {
            window.currentTemplate.workPerformance[index].name = value;
        };

        window.updateWorkCategoryWeight = function(index, value) {
            window.currentTemplate.workPerformance[index].weight = parseFloat(value) || 0;
        };

        window.addWorkItem = function(catIndex) {
            window.currentTemplate.workPerformance[catIndex].items.push('æ–°å°é …');
            renderWorkCategories();
        };

        window.removeWorkItem = function(catIndex, itemIndex) {
            window.currentTemplate.workPerformance[catIndex].items.splice(itemIndex, 1);
            renderWorkCategories();
        };

        window.updateWorkItem = function(catIndex, itemIndex, value) {
            window.currentTemplate.workPerformance[catIndex].items[itemIndex] = value;
        };

        // ç¶œåˆè¡¨ç¾ç›¸é—œå‡½æ•¸
        window.addCompCategory = function() {
            if (!window.currentTemplate.comprehensivePerformance) {
                window.currentTemplate.comprehensivePerformance = [];
            }
            window.currentTemplate.comprehensivePerformance.push({ name: 'æ–°å¤§é¡', weight: 0, items: [] });
            renderCompCategories();
        };

        window.removeCompCategory = function(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¤§é¡å—?')) {
                window.currentTemplate.comprehensivePerformance.splice(index, 1);
                renderCompCategories();
            }
        };

        window.updateCompCategoryName = function(index, value) {
            window.currentTemplate.comprehensivePerformance[index].name = value;
        };

        window.updateCompCategoryWeight = function(index, value) {
            window.currentTemplate.comprehensivePerformance[index].weight = parseFloat(value) || 0;
        };

        window.addCompItem = function(catIndex) {
            window.currentTemplate.comprehensivePerformance[catIndex].items.push('æ–°å°é …');
            renderCompCategories();
        };

        window.removeCompItem = function(catIndex, itemIndex) {
            window.currentTemplate.comprehensivePerformance[catIndex].items.splice(itemIndex, 1);
            renderCompCategories();
        };

        window.updateCompItem = function(catIndex, itemIndex, value) {
            window.currentTemplate.comprehensivePerformance[catIndex].items[itemIndex] = value;
        };

        // å€‹äººå­¸ç¿’ç›¸é—œå‡½æ•¸
        window.addLearningItem = function() {
            if (!window.currentTemplate.personalLearning) {
                window.currentTemplate.personalLearning = { weight: 0, items: [] };
            }
            window.currentTemplate.personalLearning.items.push('æ–°å­¸ç¿’é …ç›®');
            renderLearningItems();
        };

        window.removeLearningItem = function(index) {
            window.currentTemplate.personalLearning.items.splice(index, 1);
            renderLearningItems();
        };

        window.updateLearningItem = function(index, value) {
            window.currentTemplate.personalLearning.items[index] = value;
        };

        // å„²å­˜ç¯„æœ¬
        window.saveTemplate = async function(employeeId, period) {
            const learningWeight = parseFloat(document.getElementById('learningWeight').value) || 0;
            window.currentTemplate.personalLearning.weight = learningWeight;
            
            // è¨ˆç®—ç¸½ä½”æ¯”
            let totalWeight = 0;
            
            // å·¥ä½œè¡¨ç¾ä½”æ¯”
            if (window.currentTemplate.workPerformance) {
                window.currentTemplate.workPerformance.forEach(cat => {
                    totalWeight += parseFloat(cat.weight) || 0;
                });
            }
            
            // ç¶œåˆè¡¨ç¾ä½”æ¯”
            if (window.currentTemplate.comprehensivePerformance) {
                window.currentTemplate.comprehensivePerformance.forEach(cat => {
                    totalWeight += parseFloat(cat.weight) || 0;
                });
            }
            
            // å€‹äººå­¸ç¿’ä½”æ¯”
            totalWeight += learningWeight;
            
            // æª¢æŸ¥ä½”æ¯”ç¸½å’Œ
            if (Math.abs(totalWeight - 100) > 0.01) { // å…è¨±å°æ•¸é»èª¤å·®
                const diff = totalWeight - 100;
                const message = diff > 0 
                    ? `âš ï¸ ä½”æ¯”ç¸½å’Œè¶…é 100%\n\nç›®å‰ç¸½å’Œ: ${totalWeight.toFixed(1)}%\nè¶…é: ${diff.toFixed(1)}%\n\nè«‹èª¿æ•´å„é …ä½”æ¯”!`
                    : `âš ï¸ ä½”æ¯”ç¸½å’Œä¸è¶³ 100%\n\nç›®å‰ç¸½å’Œ: ${totalWeight.toFixed(1)}%\nä¸è¶³: ${Math.abs(diff).toFixed(1)}%\n\nè«‹èª¿æ•´å„é …ä½”æ¯”!`;
                
                alert(message);
                return;
            }
            
            const templateId = `${employeeId}_${period}`;
            
            await setDoc(doc(db, 'evaluation_templates', templateId), {
                employeeId: employeeId,
                period: period,
                workPerformance: window.currentTemplate.workPerformance || [],
                comprehensivePerformance: window.currentTemplate.comprehensivePerformance || [],
                personalLearning: window.currentTemplate.personalLearning,
                updatedAt: new Date().toISOString()
            });
            
            alert('ç¯„æœ¬å„²å­˜æˆåŠŸ!');
        };

        // è¤‡è£½ä¸Šæœˆç¯„æœ¬
        window.copyPreviousMonthTemplate = async function() {
            if (window.currentTemplateLocked) {
                alert('ç¯„æœ¬å·²é–å®š,ç„¡æ³•è¤‡è£½ä¸Šæœˆç¯„æœ¬!');
                return;
            }
            
            const employeeId = document.getElementById('templateEmployee').value;
            const month = document.getElementById('templateMonth').value;
            
            if (!employeeId || !month) {
                alert('è«‹å…ˆé¸æ“‡å“¡å·¥å’Œæœˆä»½');
                return;
            }
            
            // è¨ˆç®—ä¸Šå€‹æœˆ
            const currentDate = new Date(month + '-01');
            currentDate.setMonth(currentDate.getMonth() - 1);
            const previousMonth = currentDate.toISOString().slice(0, 7).replace('-', '');
            
            // å–å¾—ä¸Šå€‹æœˆçš„ç¯„æœ¬
            const previousTemplateId = `${employeeId}_${previousMonth}`;
            const previousTemplateDoc = await getDoc(doc(db, 'evaluation_templates', previousTemplateId));
            
            if (!previousTemplateDoc.exists()) {
                alert('æ‰¾ä¸åˆ°ä¸Šå€‹æœˆçš„ç¯„æœ¬');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦è¤‡è£½ä¸Šå€‹æœˆçš„ç¯„æœ¬å—?é€™æœƒè¦†è“‹ç›®å‰çš„è¨­å®š!')) {
                const previousTemplate = previousTemplateDoc.data();
                window.currentTemplate = {
                    workPerformance: JSON.parse(JSON.stringify(previousTemplate.workPerformance || [])),
                    comprehensivePerformance: JSON.parse(JSON.stringify(previousTemplate.comprehensivePerformance || [])),
                    personalLearning: JSON.parse(JSON.stringify(previousTemplate.personalLearning || { weight: 0, items: [] }))
                };
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('learningWeight').value = window.currentTemplate.personalLearning.weight || 0;
                renderWorkCategories();
                renderCompCategories();
                renderLearningItems();
                
                alert('å·²è¤‡è£½ä¸Šæœˆç¯„æœ¬,è«‹è¨˜å¾—æŒ‰ã€Œå„²å­˜ç¯„æœ¬ã€ä»¥ä¿å­˜!');
            }
        };

        // æ¸…ç©ºç¯„æœ¬
        window.clearTemplate = function() {
            if (window.currentTemplateLocked) {
                alert('ç¯„æœ¬å·²é–å®š,ç„¡æ³•æ¸…ç©º!');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºç›®å‰çš„ç¯„æœ¬å—?')) {
                window.currentTemplate = {
                    workPerformance: [],
                    comprehensivePerformance: [],
                    personalLearning: { weight: 0, items: [] }
                };
                
                document.getElementById('learningWeight').value = 0;
                renderWorkCategories();
                renderCompCategories();
                renderLearningItems();
                
                alert('å·²æ¸…ç©ºç¯„æœ¬');
            }
        };

        // ç·¨è¼¯ä½¿ç”¨è€…
        window.editUser = async function(userId) {
            // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (!userDoc.exists()) {
                alert('æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™');
                return;
            }
            
            const userData = userDoc.data();
            
            // è¼‰å…¥æ‰€æœ‰ä¸»ç®¡åˆ—è¡¨
            const usersSnapshot = await getDocs(collection(db, 'users'));
            let managersOptions = '';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                if (user.role === 'manager' || user.role === 'staff') {
                    const isSelected = userData.evaluators && userData.evaluators.includes(user.userId) ? 'selected' : '';
                    managersOptions += `<option value="${user.userId}" ${isSelected}>${user.name} (${user.userId})</option>`;
                }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2>ç·¨è¼¯äººå“¡ - ${userData.name}</h2>
                    <div id="editUserMessage"></div>
                    <form id="editUserForm">
                        <div class="form-group">
                            <label>å¸³è™Ÿ</label>
                            <input type="text" value="${userData.userId}" disabled style="background: #f7fafc;">
                        </div>
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" id="editUserName" value="${userData.name}" required>
                        </div>
                        <div class="form-group">
                            <label>æ–°å¯†ç¢¼ (ä¸ä¿®æ”¹è«‹ç•™ç©º)</label>
                            <input type="password" id="editUserPassword" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç¢¼">
                        </div>
                        <div class="form-group">
                            <label>è·ç­‰</label>
                            <select id="editUserLevel">
                                <option value="" ${!userData.level || userData.level === '' ? 'selected' : ''}>ç„¡è·ç­‰(ä¸éœ€è©•æ ¸)</option>
                                <option value="L1" ${userData.level === 'L1' ? 'selected' : ''}>L1 (æ¯æœˆè©•æ ¸)</option>
                                <option value="L2" ${userData.level === 'L2' ? 'selected' : ''}>L2 (å­£è©•æ ¸)</option>
                                <option value="L3" ${userData.level === 'L3' ? 'selected' : ''}>L3 (å­£è©•æ ¸)</option>
                                <option value="L4" ${userData.level === 'L4' ? 'selected' : ''}>L4 (å­£è©•æ ¸)</option>
                                <option value="L5" ${userData.level === 'L5' ? 'selected' : ''}>L5 (ä¸éœ€è©•æ ¸)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²</label>
                            <select id="editUserRole" required ${userId === 'Admin01' ? 'disabled' : ''}>
                                <option value="employee" ${userData.role === 'employee' ? 'selected' : ''}>ä¸€èˆ¬è·å“¡ (ç„¡æ³•ç™»å…¥ç³»çµ±)</option>
                                <option value="staff" ${userData.role === 'staff' ? 'selected' : ''}>ä¸€èˆ¬ä¸»ç®¡ (å¯è©•åˆ†)</option>
                                <option value="manager" ${userData.role === 'manager' ? 'selected' : ''}>ç®¡ç†è·ä¸»ç®¡ (å¯è©•åˆ†+å¯æŸ¥çœ‹å¾Œå°)</option>
                                ${userData.role === 'admin' ? '<option value="admin" selected>ç³»çµ±ç®¡ç†å“¡</option>' : ''}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±¬ä¸»ç®¡ (å¯è¤‡é¸,æŒ‰ä½ Ctrl æˆ– Command éµå¤šé¸)</label>
                            <select id="editUserEvaluators" multiple size="6" style="height: auto;">
                                ${managersOptions}
                            </select>
                            <small style="color: #a0aec0; display: block; margin-top: 5px;">
                                å¦‚æœæ­¤äººå“¡éœ€è¦æ¥å—è©•æ ¸,è«‹é¸æ“‡è©•æ ¸ä¸»ç®¡<br>
                                æŒ‰ä½ Ctrl (Windows) æˆ– Command (Mac) å¯å¤šé¸
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary">å„²å­˜ä¿®æ”¹</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('editUserName').value;
                const password = document.getElementById('editUserPassword').value;
                const level = document.getElementById('editUserLevel').value;
                const role = userId === 'Admin01' ? 'admin' : document.getElementById('editUserRole').value;
                
                // å–å¾—æ‰€é¸çš„ä¸»ç®¡
                const evaluatorsSelect = document.getElementById('editUserEvaluators');
                const evaluators = Array.from(evaluatorsSelect.selectedOptions).map(option => option.value);
                
                const updateData = {
                    name: name,
                    level: level || 'L5',
                    role: role,
                    evaluators: evaluators
                };
                
                // å¦‚æœæœ‰è¼¸å…¥æ–°å¯†ç¢¼æ‰æ›´æ–°
                if (password) {
                    updateData.password = password;
                }
                
                await updateDoc(doc(db, 'users', userId), updateData);
                
                alert('äººå“¡è³‡æ–™å·²æ›´æ–°!');
                modal.remove();
                loadUsersList();
            });
        };

        // åˆªé™¤ä½¿ç”¨è€…
        window.deleteUser = async function(userId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… ${userId} å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!`)) {
                return;
            }
            
            await deleteDoc(doc(db, 'users', userId));
            alert('ä½¿ç”¨è€…å·²åˆªé™¤!');
            loadUsersList();
        };

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        window.loadStatistics = async function() {
            const month = document.getElementById('statsMonth').value;
            if (!month) return;
            
            const period = month.replace('-', '');
            const container = document.getElementById('statisticsContainer');
            container.innerHTML = '<div class="loading">è¨ˆç®—ä¸­...</div>';
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const employees = [];
            
            for (const userDoc of usersSnapshot.docs) {
                const user = userDoc.data();
                // åªè™•ç†éœ€è¦è©•æ ¸çš„å“¡å·¥
                if (checkNeedsEvaluation(user.level, period)) {
                    const scores = await calculateEmployeeScores(user.userId, period);
                    if (scores) {
                        employees.push({
                            userId: user.userId,
                            name: user.name,
                            level: user.level,
                            scores: scores
                        });
                    }
                }
            }
            
            if (employees.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0;">æœ¬æœˆç„¡è©•æ ¸è³‡æ–™</p>';
                return;
            }
            
            // æ¸²æŸ“çµ±è¨ˆè¡¨
            renderStatisticsTable(employees, period);
        };

        // è¨ˆç®—å“¡å·¥åˆ†æ•¸
        async function calculateEmployeeScores(employeeId, period) {
            // å–å¾—ç¯„æœ¬
            const templateId = `${employeeId}_${period}`;
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
            
            if (!templateDoc.exists()) {
                return null;
            }
            
            const template = templateDoc.data();
            
            // å–å¾—æ‰€æœ‰ä¸»ç®¡çš„è©•åˆ†
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            const evaluations = [];
            evaluationsSnapshot.forEach(doc => {
                evaluations.push(doc.data());
            });
            
            if (evaluations.length === 0) {
                return null;
            }
            
            // è¨ˆç®—å·¥ä½œè¡¨ç¾åˆ†æ•¸
            const workScore = calculateCategoryScore(
                template.workPerformance,
                evaluations,
                'work'
            );
            
            // è¨ˆç®—ç¶œåˆè¡¨ç¾åˆ†æ•¸
            const compScore = calculateCategoryScore(
                template.comprehensivePerformance,
                evaluations,
                'comp'
            );
            
            // è¨ˆç®—å€‹äººå­¸ç¿’åˆ†æ•¸
            const learningScore = calculateLearningScore(
                template.personalLearning,
                evaluations
            );
            
            const totalScore = workScore + compScore + learningScore;
            
            return {
                workScore: workScore,
                compScore: compScore,
                learningScore: learningScore,
                totalScore: totalScore,
                evaluations: evaluations
            };
        }

        // è¨ˆç®—åˆ†é¡åˆ†æ•¸(å·¥ä½œè¡¨ç¾/ç¶œåˆè¡¨ç¾)
        function calculateCategoryScore(categories, evaluations, prefix) {
            if (!categories || categories.length === 0) {
                return 0;
            }
            
            const categoryResults = [];
            
            // è¨ˆç®—æ¯å€‹å¤§é¡çš„åˆ†æ•¸
            categories.forEach((category, catIndex) => {
                const itemScores = [];
                
                category.items.forEach((item, itemIndex) => {
                    const itemKey = `${prefix}_${catIndex}_${itemIndex}`;
                    const allScores = [];
                    
                    // æ”¶é›†æ‰€æœ‰ä¸»ç®¡å°é€™å€‹å°é …çš„è©•åˆ†
                    evaluations.forEach(evaluation => {
                        const score1Value = evaluation.scores[`${itemKey}_1`];
                        const score2Value = evaluation.scores[`${itemKey}_2`];
                        
                        // æª¢æŸ¥æ¬„ä½æ˜¯å¦æœ‰å¡«å¯«(åŒ…å«0åˆ†)
                        const hasScore1 = score1Value !== undefined && score1Value !== null && score1Value !== '';
                        const hasScore2 = score2Value !== undefined && score2Value !== null && score2Value !== '';
                        
                        // å¦‚æœè‡³å°‘æœ‰ä¸€å€‹æ¬„ä½æœ‰å¡«å¯«
                        if (hasScore1 || hasScore2) {
                            const score1 = hasScore1 ? parseFloat(score1Value) : 0;
                            const score2 = hasScore2 ? parseFloat(score2Value) : 0;
                            
                            if (!isNaN(score1) && !isNaN(score2)) {
                                // å¦‚æœå…©å€‹éƒ½æœ‰å¡«,å–å¹³å‡
                                if (hasScore1 && hasScore2) {
                                    const avgScore = (score1 + score2) / 2;
                                    allScores.push(avgScore);
                                }
                                // å¦‚æœåªæœ‰ä¸€å€‹æœ‰å¡«,å°±ç”¨è©²åˆ†æ•¸
                                else if (hasScore1) {
                                    allScores.push(score1);
                                }
                                else if (hasScore2) {
                                    allScores.push(score2);
                                }
                            }
                        }
                    });
                    
                    // è¨ˆç®—é€™å€‹å°é …çš„å¹³å‡åˆ†æ•¸
                    if (allScores.length > 0) {
                        const itemAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                        itemScores.push(itemAvg);
                    }
                });
                
                // å¦‚æœé€™å€‹å¤§é¡æœ‰åˆ†æ•¸
                if (itemScores.length > 0) {
                    const categoryAvg = itemScores.reduce((a, b) => a + b, 0) / itemScores.length;
                    categoryResults.push({
                        score: categoryAvg,
                        weight: category.weight,
                        hasScore: true
                    });
                } else {
                    // æ²’æœ‰åˆ†æ•¸ä½†è¨˜éŒ„ä½”æ¯”,ç”¨æ–¼å‡æ”¤
                    categoryResults.push({
                        score: 0,
                        weight: category.weight,
                        hasScore: false
                    });
                }
            });
            
            // è¨ˆç®—éœ€è¦å‡æ”¤çš„ä½”æ¯”
            const totalOriginalWeight = categoryResults.reduce((sum, cat) => sum + cat.weight, 0);
            const scoredWeight = categoryResults.filter(cat => cat.hasScore).reduce((sum, cat) => sum + cat.weight, 0);
            const unscoredWeight = totalOriginalWeight - scoredWeight;
            
            // å¦‚æœæ²’æœ‰ä»»ä½•åˆ†æ•¸
            if (scoredWeight === 0) {
                return 0;
            }
            
            // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
            let finalScore = 0;
            categoryResults.forEach(cat => {
                if (cat.hasScore) {
                    // èª¿æ•´å¾Œçš„ä½”æ¯” = åŸä½”æ¯” + (åŸä½”æ¯”/å·²è©•åˆ†ç¸½ä½”æ¯”) Ã— æœªè©•åˆ†ç¸½ä½”æ¯”
                    const adjustedWeight = cat.weight + (cat.weight / scoredWeight) * unscoredWeight;
                    // å¤§é¡å¾—åˆ† = (å°é …å¹³å‡åˆ† / 5) Ã— èª¿æ•´å¾Œä½”æ¯”
                    const categoryScore = (cat.score / 5) * adjustedWeight;
                    finalScore += categoryScore;
                }
            });
            
            return finalScore;
        }

        // è¨ˆç®—å€‹äººå­¸ç¿’åˆ†æ•¸
        function calculateLearningScore(learningTemplate, evaluations) {
            if (!learningTemplate || !learningTemplate.items || learningTemplate.items.length === 0) {
                return 0;
            }
            
            const itemScores = [];
            
            learningTemplate.items.forEach((item, itemIndex) => {
                const itemKey = `learn_${itemIndex}`;
                const allScores = [];
                
                evaluations.forEach(evaluation => {
                    const score1Value = evaluation.scores[`${itemKey}_1`];
                    const score2Value = evaluation.scores[`${itemKey}_2`];
                    
                    // æª¢æŸ¥æ¬„ä½æ˜¯å¦æœ‰å¡«å¯«(åŒ…å«0åˆ†)
                    const hasScore1 = score1Value !== undefined && score1Value !== null && score1Value !== '';
                    const hasScore2 = score2Value !== undefined && score2Value !== null && score2Value !== '';
                    
                    // å¦‚æœè‡³å°‘æœ‰ä¸€å€‹æ¬„ä½æœ‰å¡«å¯«
                    if (hasScore1 || hasScore2) {
                        const score1 = hasScore1 ? parseFloat(score1Value) : 0;
                        const score2 = hasScore2 ? parseFloat(score2Value) : 0;
                        
                        if (!isNaN(score1) && !isNaN(score2)) {
                            // å¦‚æœå…©å€‹éƒ½æœ‰å¡«,å–å¹³å‡
                            if (hasScore1 && hasScore2) {
                                const avgScore = (score1 + score2) / 2;
                                allScores.push(avgScore);
                            }
                            // å¦‚æœåªæœ‰ä¸€å€‹æœ‰å¡«,å°±ç”¨è©²åˆ†æ•¸
                            else if (hasScore1) {
                                allScores.push(score1);
                            }
                            else if (hasScore2) {
                                allScores.push(score2);
                            }
                        }
                    }
                });
                
                if (allScores.length > 0) {
                    const itemAvg = allScores.reduce((a, b) => a + b, 0) / allScores.length;
                    itemScores.push(itemAvg);
                }
            });
            
            if (itemScores.length === 0) {
                return 0;
            }
            
            // è¨ˆç®—æ‰€æœ‰å­¸ç¿’é …ç›®çš„å¹³å‡åˆ†
            const avgScore = itemScores.reduce((a, b) => a + b, 0) / itemScores.length;
            // å€‹äººå­¸ç¿’å¾—åˆ† = (å¹³å‡åˆ† / 5) Ã— ä½”æ¯”
            return (avgScore / 5) * learningTemplate.weight;
        }

        // æ¸²æŸ“çµ±è¨ˆè¡¨
        async function renderStatisticsTable(employees, period) {
            const container = document.getElementById('statisticsContainer');
            
            // è¨ˆç®—ä¸Šå€‹æœˆæœŸé–“
            const currentDate = new Date(period.slice(0, 4) + '-' + period.slice(4) + '-01');
            currentDate.setMonth(currentDate.getMonth() - 1);
            const previousPeriod = currentDate.toISOString().slice(0, 7).replace('-', '');
            
            // å–å¾—ä¸Šå€‹æœˆåˆ†æ•¸
            const previousScores = {};
            for (const emp of employees) {
                const prevScores = await calculateEmployeeScores(emp.userId, previousPeriod);
                if (prevScores) {
                    previousScores[emp.userId] = prevScores.totalScore;
                }
            }
            
            let html = '';
            
            employees.forEach(emp => {
                const prevScore = previousScores[emp.userId];
                let diff = null;
                let diffClass = '';
                let diffText = '-';
                
                if (prevScore !== undefined) {
                    diff = emp.scores.totalScore - prevScore;
                    if (diff > 0 && diff >= 5) {
                        diffClass = 'score-positive';
                        diffText = `+${diff.toFixed(1)}`;
                    } else if (diff < 0 && diff <= -6) {
                        diffClass = 'score-negative-heavy';
                        diffText = diff.toFixed(1);
                    } else if (diff < 0 && diff > -6) {
                        diffClass = 'score-negative-light';
                        diffText = diff.toFixed(1);
                    } else {
                        diffText = diff.toFixed(1);
                    }
                }
                
                html += `
                    <div style="background: white; padding: 25px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 20px;">${emp.name} (${emp.userId}) - ${emp.level}</h3>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>æœˆä»½</th>
                                    <th>å·¥ä½œè¡¨ç¾</th>
                                    <th>ç¶œåˆè¡¨ç¾</th>
                                    <th>å€‹äººå­¸ç¿’</th>
                                    <th>ç¸½åˆ†</th>
                                    <th>èˆ‡ä¸Šæœˆæ¯”è¼ƒ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${period.slice(0,4)}å¹´${period.slice(4)}æœˆ</td>
                                    <td>${emp.scores.workScore.toFixed(1)}</td>
                                    <td>${emp.scores.compScore.toFixed(1)}</td>
                                    <td>${emp.scores.learningScore.toFixed(1)}</td>
                                    <td><strong>${emp.scores.totalScore.toFixed(1)}</strong></td>
                                    <td class="${diffClass}">${diffText}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="window.viewEvaluationDetails('${emp.userId}', '${period}')">æŸ¥çœ‹æ˜ç´°</button>
                                        <button class="btn btn-danger" onclick="window.returnEvaluations('${emp.userId}', '${period}')">å…¨éƒ¨é€€å–®</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æŸ¥çœ‹è©•åˆ†æ˜ç´°
        window.viewEvaluationDetails = async function(employeeId, period) {
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            // å–å¾—ä¸»ç®¡åç¨±
            const evaluatorNames = {};
            const usersSnapshot = await getDocs(collection(db, 'users'));
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                evaluatorNames[user.userId] = user.name;
            });
            
            // å–å¾—å“¡å·¥åç¨±
            const employeeDoc = await getDoc(doc(db, 'users', employeeId));
            const employeeName = employeeDoc.exists() ? employeeDoc.data().name : employeeId;
            
            // å–å¾—ç¯„æœ¬
            const templateId = `${employeeId}_${period}`;
            const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
            const template = templateDoc.exists() ? templateDoc.data() : null;
            
            let detailsHtml = `<h3>${employeeName} - ${period.slice(0,4)}å¹´${period.slice(4)}æœˆ è©•åˆ†æ˜ç´°</h3>`;
            
            evaluationsSnapshot.forEach(doc => {
                const evaluation = doc.data();
                const evaluatorName = evaluatorNames[evaluation.evaluatorId] || evaluation.evaluatorId;
                
                // é¡¯ç¤ºæ‰€æœ‰è©•åˆ†é …ç›®
                let scoresHtml = '<div style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">';
                scoresHtml += '<table style="width: 100%; font-size: 0.9em;"><thead><tr><th>é¡åˆ¥</th><th>è©•åˆ†é …ç›®</th><th>åŸ·è¡ŒåŠ›</th><th>éŒ¯èª¤ç‡</th></tr></thead><tbody>';
                
                if (template) {
                    // å·¥ä½œè¡¨ç¾
                    if (template.workPerformance) {
                        template.workPerformance.forEach((category, catIndex) => {
                            category.items.forEach((item, itemIndex) => {
                                const itemKey = `work_${catIndex}_${itemIndex}`;
                                const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                
                                scoresHtml += `<tr><td style="font-size: 0.8em;">å·¥ä½œ-${category.name}</td><td style="font-size: 0.8em;">${item}</td><td>${score1}</td><td>${score2}</td></tr>`;
                            });
                        });
                    }
                    
                    // ç¶œåˆè¡¨ç¾
                    if (template.comprehensivePerformance) {
                        template.comprehensivePerformance.forEach((category, catIndex) => {
                            category.items.forEach((item, itemIndex) => {
                                const itemKey = `comp_${catIndex}_${itemIndex}`;
                                const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                
                                scoresHtml += `<tr><td style="font-size: 0.8em;">ç¶œåˆ-${category.name}</td><td style="font-size: 0.8em;">${item}</td><td>${score1}</td><td>${score2}</td></tr>`;
                            });
                        });
                    }
                    
                    // å€‹äººå­¸ç¿’
                    if (template.personalLearning && template.personalLearning.items) {
                        template.personalLearning.items.forEach((item, itemIndex) => {
                            const itemKey = `learn_${itemIndex}`;
                            const score1 = evaluation.scores[`${itemKey}_1`] || '';
                            const score2 = evaluation.scores[`${itemKey}_2`] || '';
                            
                            scoresHtml += `<tr><td style="font-size: 0.8em;">å€‹äººå­¸ç¿’</td><td style="font-size: 0.8em;">${item}</td><td>${score1}</td><td>${score2}</td></tr>`;
                        });
                    }
                }
                
                scoresHtml += '</tbody></table></div>';
                
                detailsHtml += `
                    <div style="background: #f7fafc; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0;">${evaluatorName} çš„è©•åˆ†</h4>
                            <button class="btn btn-danger" onclick="window.returnSingleEvaluation('${evaluation.evaluationId}', '${evaluatorName}', '${employeeId}', '${period}')">
                                ğŸ”„ é€€å›æ­¤è©•åˆ†
                            </button>
                        </div>
                        <p><strong>è©•èª:</strong> ${evaluation.comment || 'ç„¡'}</p>
                        <p><strong>é€å‡ºæ™‚é–“:</strong> ${new Date(evaluation.submittedAt).toLocaleString('zh-TW')}</p>
                        <details>
                            <summary style="cursor: pointer; color: #667eea; margin-top: 10px;"><strong>ğŸ“Š æŸ¥çœ‹æ‰€æœ‰è©•åˆ†é …ç›®</strong></summary>
                            ${scoresHtml}
                        </details>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'detailsModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    ${detailsHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // é€€å›å–®ä¸€ä¸»ç®¡çš„è©•åˆ†
        window.returnSingleEvaluation = async function(evaluationId, evaluatorName, employeeId, period) {
            if (!confirm(`ç¢ºå®šè¦é€€å› ${evaluatorName} çš„è©•åˆ†å—?\n\né€€å›å¾Œè©²ä¸»ç®¡å¯ä»¥é‡æ–°ä¿®æ”¹ä¸¦é€å‡ºã€‚`)) {
                return;
            }
            
            await updateDoc(doc(db, 'evaluations', evaluationId), {
                status: 'draft',
                returnedAt: new Date().toISOString()
            });
            
            alert(`å·²é€€å› ${evaluatorName} çš„è©•åˆ†!`);
            
            // é—œé–‰å½ˆçª—
            const modal = document.getElementById('detailsModal');
            if (modal) {
                modal.remove();
            }
            
            // é‡æ–°è¼‰å…¥çµ±è¨ˆ
            window.loadStatistics();
        };

        // é€€å–®åŠŸèƒ½
        window.returnEvaluations = async function(employeeId, period) {
            if (!confirm('ç¢ºå®šè¦é€€å›æ­¤å“¡å·¥çš„æ‰€æœ‰è©•åˆ†å—?ä¸»ç®¡å°‡å¯ä»¥é‡æ–°ä¿®æ”¹ä¸¦é€å‡ºã€‚')) {
                return;
            }
            
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('evaluateeId', '==', employeeId),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            for (const evalDoc of evaluationsSnapshot.docs) {
                await updateDoc(doc(db, 'evaluations', evalDoc.id), {
                    status: 'draft',
                    returnedAt: new Date().toISOString()
                });
            }
            
            alert('å·²é€€å–®!ä¸»ç®¡ç¾åœ¨å¯ä»¥é‡æ–°ä¿®æ”¹è©•åˆ†ã€‚');
            window.loadStatistics();
        };

        // ä¸‹è¼‰CSV
        window.downloadCSV = async function() {
            const month = document.getElementById('statsMonth').value;
            if (!month) {
                alert('è«‹å…ˆé¸æ“‡æœˆä»½');
                return;
            }
            
            const period = month.replace('-', '');
            
            // å–å¾—æ‰€æœ‰è©•åˆ†è¨˜éŒ„
            const evaluationsQuery = query(
                collection(db, 'evaluations'),
                where('period', '==', period),
                where('status', '==', 'submitted')
            );
            
            const evaluationsSnapshot = await getDocs(evaluationsQuery);
            
            if (evaluationsSnapshot.empty) {
                alert('æœ¬æœˆç„¡è©•åˆ†è³‡æ–™');
                return;
            }
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…åç¨±
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const userNames = {};
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                userNames[user.userId] = user.name;
            });
            
            // å»ºç«‹ CSV å…§å®¹
            let csv = '\uFEFF'; // UTF-8 BOM
            csv += 'è¢«è©•äºº,ä¸»ç®¡,å¤§é¡,å°é …,åŸ·è¡ŒåŠ›èˆ‡æº–æ™‚æ€§,éŒ¯èª¤ç‡èˆ‡å°ˆæ¥­æ€§,è©•èª,é€å‡ºæ™‚é–“\n';
            
            for (const evalDoc of evaluationsSnapshot.docs) {
                const evaluation = evalDoc.data();
                const evaluateeName = userNames[evaluation.evaluateeId] || evaluation.evaluateeId;
                const evaluatorName = userNames[evaluation.evaluatorId] || evaluation.evaluatorId;
                const submittedAt = new Date(evaluation.submittedAt).toLocaleString('zh-TW');
                const comment = (evaluation.comment || '').replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                
                // å–å¾—ç¯„æœ¬ä»¥è§£æé …ç›®åç¨±
                const templateId = `${evaluation.evaluateeId}_${period}`;
                const templateDoc = await getDoc(doc(db, 'evaluation_templates', templateId));
                
                if (templateDoc.exists()) {
                    const template = templateDoc.data();
                    
                    // å·¥ä½œè¡¨ç¾
                    if (template.workPerformance) {
                        template.workPerformance.forEach((category, catIndex) => {
                            category.items.forEach((item, itemIndex) => {
                                const itemKey = `work_${catIndex}_${itemIndex}`;
                                const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                
                                const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                                const categoryName = category.name.replace(/,/g, 'ï¼Œ').replace(/"/g, '""');
                                
                                csv += `"${evaluateeName}","${evaluatorName}","å·¥ä½œè¡¨ç¾-${categoryName}","${itemName}",${score1},${score2},"${comment}","${submittedAt}"\n`;
                            });
                        });
                    }
                    
                    // ç¶œåˆè¡¨ç¾
                    if (template.comprehensivePerformance) {
                        template.comprehensivePerformance.forEach((category, catIndex) => {
                            category.items.forEach((item, itemIndex) => {
                                const itemKey = `comp_${catIndex}_${itemIndex}`;
                                const score1 = evaluation.scores[`${itemKey}_1`] || '';
                                const score2 = evaluation.scores[`${itemKey}_2`] || '';
                                
                                const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                                const categoryName = category.name.replace(/,/g, 'ï¼Œ').replace(/"/g, '""');
                                
                                csv += `"${evaluateeName}","${evaluatorName}","ç¶œåˆè¡¨ç¾-${categoryName}","${itemName}",${score1},${score2},"${comment}","${submittedAt}"\n`;
                            });
                        });
                    }
                    
                    // å€‹äººå­¸ç¿’
                    if (template.personalLearning && template.personalLearning.items) {
                        template.personalLearning.items.forEach((item, itemIndex) => {
                            const itemKey = `learn_${itemIndex}`;
                            const score1 = evaluation.scores[`${itemKey}_1`] || '';
                            const score2 = evaluation.scores[`${itemKey}_2`] || '';
                            
                            const itemName = item.replace(/,/g, 'ï¼Œ').replace(/\n/g, ' ').replace(/"/g, '""');
                            
                            csv += `"${evaluateeName}","${evaluatorName}","å€‹äººå­¸ç¿’","${itemName}",${score1},${score2},"${comment}","${submittedAt}"\n`;
                        });
                    }
                }
            }
            
            // ä¸‹è¼‰ CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è©•åˆ†æ˜ç´°_${period}.csv`;
            link.click();
        };

        // è¼‰å…¥è·ç­‰æ¯”å°åœ–è¡¨
        window.loadCharts = async function() {
            const year = document.getElementById('chartYear').value;
            if (!year) return;
            
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…ä¸¦æŒ‰è·ç­‰åˆ†çµ„
            const usersSnapshot = await getDocs(collection(db, 'users'));
            const levelGroups = {};
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                // æ’é™¤ L5 å’Œç„¡è·ç­‰çš„ä½¿ç”¨è€…
                if (user.level && user.level !== 'L5' && user.level !== '' && ['L1', 'L2', 'L3', 'L4'].includes(user.level)) {
                    if (!levelGroups[user.level]) {
                        levelGroups[user.level] = [];
                    }
                    levelGroups[user.level].push(user);
                }
            });
            
            if (Object.keys(levelGroups).length === 0) {
                container.innerHTML = '<p style="color: #a0aec0;">ç„¡è·ç­‰è³‡æ–™</p>';
                return;
            }
            
            // ç‚ºæ¯å€‹è·ç­‰ç”Ÿæˆåœ–è¡¨
            let chartsHtml = '';
            
            for (const [level, employees] of Object.entries(levelGroups)) {
                const chartId = `chart_${level}`;
                chartsHtml += `
                    <div class="chart-container">
                        <h3 class="chart-title">${level} è·ç­‰å¹´åº¦ç¸¾æ•ˆæ¯”å°</h3>
                        <canvas id="${chartId}" style="max-height: 400px;"></canvas>
                    </div>
                `;
            }
            
            container.innerHTML = chartsHtml;
            
            // æ¸²æŸ“æ¯å€‹åœ–è¡¨
            for (const [level, employees] of Object.entries(levelGroups)) {
                await renderLevelChart(level, employees, year);
            }
        };

        // æ¸²æŸ“è·ç­‰åœ–è¡¨
        async function renderLevelChart(level, employees, year) {
            const chartId = `chart_${level}`;
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // æº–å‚™è³‡æ–™
            const months = [];
            const datasets = [];
            
            // æ ¹æ“šè·ç­‰æ±ºå®šè¦é¡¯ç¤ºå“ªäº›æœˆä»½
            if (level === 'L1') {
                // L1 é¡¯ç¤ºå…¨å¹´12å€‹æœˆ
                for (let m = 1; m <= 12; m++) {
                    months.push(`${m}æœˆ`);
                }
            } else {
                // L2-L4 åªé¡¯ç¤º 3, 5, 9, 12 æœˆ
                months.push('3æœˆ', '5æœˆ', '9æœˆ', '12æœˆ');
            }
            
            // ç‚ºæ¯å€‹å“¡å·¥å»ºç«‹è³‡æ–™é›†
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471f5', '#12c2e9'
            ];
            
            for (let i = 0; i < employees.length; i++) {
                const employee = employees[i];
                const scores = [];
                
                // å–å¾—è©²å“¡å·¥æ¯å€‹æœˆçš„åˆ†æ•¸
                for (let m of (level === 'L1' ? [1,2,3,4,5,6,7,8,9,10,11,12] : [3,5,9,12])) {
                    const period = `${year}${String(m).padStart(2, '0')}`;
                    const employeeScores = await calculateEmployeeScores(employee.userId, period);
                    
                    if (employeeScores) {
                        scores.push(employeeScores.totalScore.toFixed(1));
                    } else {
                        scores.push(null); // æ²’æœ‰è³‡æ–™é¡¯ç¤ºç‚ºç©º
                    }
                }
                
                datasets.push({
                    label: employee.name,
                    data: scores,
                    backgroundColor: colors[i % colors.length],
                    borderColor: colors[i % colors.length],
                    borderWidth: 2
                });
            }
            
            // å»ºç«‹åœ–è¡¨
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' åˆ†';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'åˆ†æ•¸'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆä»½'
                            }
                        }
                    }
                }
            });
        }

        // é¡¯ç¤ºç®¡ç†å¾Œå°
        window.showAdminPanel = function() {
            renderAdminDashboard();
        };

        // è¿”å›è©•åˆ†é é¢
        window.backToEvaluation = function() {
            renderEvaluatorDashboard();
        };

        // ç™»å‡º
        window.logout = function() {
            currentUser = null;
            renderLogin();
        };

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // å•Ÿå‹•ç³»çµ±
        initSystem();
    </script>
</body>
</html>
